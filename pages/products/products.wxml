<!--pages/products/products.wxml-->
<view class="container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="header">
    <view class="title">äº§å“çŸ¥è¯†åº“</view>
    <view class="header-actions">
      <view class="search-btn" bindtap="showSearchBar">
        <text class="icon">ğŸ”</text>
      </view>
      <view class="filter-btn" bindtap="showFilterPanel">
        <text class="icon">ğŸ”§</text>
      </view>
    </view>
  </view>

  <!-- æœç´¢æ  -->
  <view class="search-bar {{showSearch ? 'show' : ''}}" wx:if="{{showSearch}}">
    <view class="search-input-wrapper">
      <input 
        class="search-input" 
        placeholder="æœç´¢äº§å“ã€å“ç‰Œã€æˆåˆ†..." 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindconfirm="performSearch"
        focus="{{showSearch}}"
      />
      <view class="search-actions">
        <text class="search-btn" bindtap="performSearch">æœç´¢</text>
        <text class="cancel-btn" bindtap="hideSearchBar">å–æ¶ˆ</text>
      </view>
    </view>
    
    <!-- æœç´¢å»ºè®® -->
    <view class="search-suggestions" wx:if="{{!searchKeyword}}">
      <!-- çƒ­é—¨æœç´¢ -->
      <view class="suggestion-section">
        <view class="section-title">çƒ­é—¨æœç´¢</view>
        <view class="hot-searches">
          <text 
            class="hot-search-item" 
            wx:for="{{hotSearches}}" 
            wx:key="*this"
            data-keyword="{{item}}"
            bindtap="onHotSearchTap"
          >{{item}}</text>
        </view>
      </view>
      
      <!-- æœç´¢å†å² -->
      <view class="suggestion-section" wx:if="{{searchHistory.length > 0}}">
        <view class="section-header">
          <view class="section-title">æœç´¢å†å²</view>
          <text class="clear-btn" bindtap="clearSearchHistory">æ¸…ç©º</text>
        </view>
        <view class="search-history">
          <view 
            class="history-item" 
            wx:for="{{searchHistory}}" 
            wx:key="*this"
            data-keyword="{{item}}"
            bindtap="onSearchHistoryTap"
          >
            <text class="history-icon">ğŸ•</text>
            <text class="history-text">{{item}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
  <view class="tab-nav">
    <view 
      class="tab-item {{currentTab === 'products' ? 'active' : ''}}"
      data-tab="products"
      bindtap="switchTab"
    >
      <text class="tab-icon">ğŸ§´</text>
      <text class="tab-text">äº§å“</text>
    </view>
    <view 
      class="tab-item {{currentTab === 'ingredients' ? 'active' : ''}}"
      data-tab="ingredients"
      bindtap="switchTab"
    >
      <text class="tab-icon">ğŸ§ª</text>
      <text class="tab-text">æˆåˆ†</text>
    </view>
    <view 
      class="tab-item {{currentTab === 'brands' ? 'active' : ''}}"
      data-tab="brands"
      bindtap="switchTab"
    >
      <text class="tab-icon">ğŸ·ï¸</text>
      <text class="tab-text">å“ç‰Œ</text>
    </view>
    <view 
      class="tab-item {{currentTab === 'favorites' ? 'active' : ''}}"
      data-tab="favorites"
      bindtap="switchTab"
    >
      <text class="tab-icon">â¤ï¸</text>
      <text class="tab-text">æ”¶è—</text>
    </view>
  </view>

  <!-- æ’åºå’Œç­›é€‰å·¥å…·æ  -->
  <view class="toolbar" wx:if="{{currentTab === 'products'}}">
    <picker 
      class="sort-picker"
      mode="selector"
      range="{{sortOptions}}"
      range-key="name"
      bindchange="onSortChange"
    >
      <view class="picker-display">
        <text class="sort-text">{{sortOptions[currentSort] || 'é»˜è®¤æ’åº'}}</text>
        <text class="arrow">â–¼</text>
      </view>
    </picker>
    
    <view class="result-count">
      å…±{{filteredProducts.length}}ä¸ªäº§å“
    </view>
  </view>

  <!-- å†…å®¹åŒºåŸŸ -->
  <scroll-view class="content" scroll-y="{{true}}" bindscrolltolower="onReachBottom">
    <!-- äº§å“åˆ—è¡¨ -->
    <view class="product-list" wx:if="{{currentTab === 'products'}}">
      <view class="loading" wx:if="{{loading && productList.length === 0}}">
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>
      
      <view class="empty" wx:elif="{{filteredProducts.length === 0 && !loading}}">
        <text class="empty-icon">ğŸ“¦</text>
        <text class="empty-text">æš‚æ— äº§å“æ•°æ®</text>
      </view>
      
      <view class="product-grid" wx:else>
        <view 
          class="product-item"
          wx:for="{{filteredProducts}}"
          wx:key="id"
          data-id="{{item.id}}"
          bindtap="viewProductDetail"
        >
          <!-- äº§å“å›¾ç‰‡ -->
          <view class="product-image-wrapper">
            <image 
              class="product-image" 
              src="{{item.image}}" 
              mode="aspectFill"
              lazy-load="{{true}}"
              data-index="{{index}}"
              data-type="product"
              binderror="onImageError"
            />
            <view class="product-badges">
              <text class="badge new" wx:if="{{item.isNew}}">æ–°å“</text>
              <text class="badge hot" wx:if="{{item.isHot}}">çƒ­é”€</text>
              <text class="badge discount" wx:if="{{item.discount}}">-{{item.discount}}%</text>
            </view>
            <view 
              class="favorite-btn {{item.isFavorite ? 'active' : ''}}"
              data-id="{{item.id}}"
              bindtap="toggleFavorite"
              catchtap="true"
            >
              <text class="favorite-icon">{{item.isFavorite ? 'â¤ï¸' : 'ğŸ¤'}}</text>
            </view>
          </view>
          
          <!-- äº§å“ä¿¡æ¯ -->
          <view class="product-info">
            <view class="product-name">{{item.name}}</view>
            <view class="product-brand">{{item.brand}}</view>
            <view class="product-category">{{item.categoryName}}</view>
            
            <view class="product-rating">
              <text class="rating-stars">â­</text>
              <text class="rating-score">{{item.rating}}</text>
              <text class="rating-count">({{item.sales}})</text>
            </view>
            
            <view class="product-price">
              <text class="current-price">Â¥{{item.price}}</text>
              <text class="original-price" wx:if="{{item.originalPrice !== item.price}}">Â¥{{item.originalPrice}}</text>
            </view>
            
            <view class="product-effects">
              <text class="effect-tag">{{item.effects}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- åŠ è½½æ›´å¤š -->
      <view class="load-more" wx:if="{{loading && productList.length > 0}}">
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>
      
      <view class="no-more" wx:if="{{!hasMore && filteredProducts.length > 0}}">
        <text class="no-more-text">æ²¡æœ‰æ›´å¤šäº†</text>
      </view>
    </view>

    <!-- æˆåˆ†åˆ—è¡¨ -->
    <view class="ingredient-list" wx:if="{{currentTab === 'ingredients'}}">
      <view class="loading" wx:if="{{loading && ingredientList.length === 0}}">
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>
      
      <view class="empty" wx:elif="{{ingredientList.length === 0 && !loading}}">
        <text class="empty-icon">ğŸ§ª</text>
        <text class="empty-text">æš‚æ— æˆåˆ†æ•°æ®</text>
      </view>
      
      <view class="ingredient-items" wx:else>
        <view 
          class="ingredient-item"
          wx:for="{{ingredientList}}"
          wx:key="id"
          data-id="{{item.id}}"
          bindtap="viewIngredientDetail"
        >
          <view class="ingredient-header">
            <view class="ingredient-name">{{item.name}}</view>
            <view class="ingredient-english">{{item.englishName}}</view>
          </view>
          
          <view class="ingredient-safety">
            <view class="safety-level {{item.safetyLevel}}">
              <text class="safety-icon">{{item.safetyLevel === 'safe' ? 'âœ…' : 'âš ï¸'}}</text>
              <text class="safety-text">å®‰å…¨è¯„åˆ†: {{item.safetyScore}}</text>
            </view>
          </view>
          
          <view class="ingredient-effects">
            <text 
              class="effect-tag"
              wx:for="{{item.effects}}"
              wx:for-item="effect"
              wx:key="*this"
            >{{effect}}</text>
          </view>
          
          <view class="ingredient-description">{{item.description}}</view>
        </view>
      </view>
    </view>

    <!-- å“ç‰Œåˆ—è¡¨ -->
    <view class="brand-list" wx:if="{{currentTab === 'brands'}}">
      <view class="loading" wx:if="{{loading && brandList.length === 0}}">
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>
      
      <view class="empty" wx:elif="{{brandList.length === 0 && !loading}}">
        <text class="empty-icon">ğŸ·ï¸</text>
        <text class="empty-text">æš‚æ— å“ç‰Œæ•°æ®</text>
      </view>
      
      <view class="brand-items" wx:else>
        <view 
          class="brand-item"
          wx:for="{{brandList}}"
          wx:key="id"
          data-id="{{item.id}}"
          bindtap="viewBrandDetail"
        >
          <view class="brand-logo">
            <image 
              class="logo-image" 
              src="{{item.logo}}" 
              mode="aspectFit"
              lazy-load="{{true}}"
              data-index="{{index}}"
              data-type="brand"
              binderror="onImageError"
            />
          </view>
          
          <view class="brand-info">
            <view class="brand-header">
              <view class="brand-name">{{item.name}}</view>
              <view class="brand-english">{{item.englishName}}</view>
              <text class="popular-badge" wx:if="{{item.isPopular}}">çƒ­é—¨</text>
            </view>
            
            <view class="brand-meta">
              <text class="brand-country">{{item.country}}</text>
              <text class="brand-founded">åˆ›ç«‹äº{{item.founded}}å¹´</text>
            </view>
            
            <view class="brand-stats">
              <text class="product-count">{{item.productCount}}ä¸ªäº§å“</text>
              <view class="brand-rating">
                <text class="rating-stars">â­</text>
                <text class="rating-score">{{item.rating}}</text>
              </view>
            </view>
            
            <view class="brand-description">{{item.description}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ”¶è—åˆ—è¡¨ -->
    <view class="favorite-list" wx:if="{{currentTab === 'favorites'}}">
      <view class="empty" wx:if="{{!userInfo}}">
        <text class="empty-icon">ğŸ‘¤</text>
        <text class="empty-text">è¯·å…ˆç™»å½•æŸ¥çœ‹æ”¶è—</text>
      </view>
      
      <view class="loading" wx:elif="{{loading && favoriteList.length === 0}}">
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>
      
      <view class="empty" wx:elif="{{favoriteList.length === 0 && !loading && userInfo}}">
        <text class="empty-icon">â¤ï¸</text>
        <text class="empty-text">æš‚æ— æ”¶è—äº§å“</text>
      </view>
      
      <view class="favorite-items" wx:else>
        <view 
          class="favorite-item"
          wx:for="{{favoriteList}}"
          wx:key="id"
          data-id="{{item.id}}"
          bindtap="viewProductDetail"
        >
          <image class="favorite-image" src="{{item.image}}" mode="aspectFill" />
          <view class="favorite-info">
            <view class="favorite-name">{{item.name}}</view>
            <view class="favorite-brand">{{item.brand}}</view>
            <view class="favorite-price">Â¥{{item.price}}</view>
          </view>
          <view 
            class="unfavorite-btn"
            data-id="{{item.id}}"
            bindtap="toggleFavorite"
            catchtap="true"
          >
            <text class="unfavorite-icon">ğŸ’”</text>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view class="filter-panel {{showFilter ? 'show' : ''}}" wx:if="{{showFilter}}">
    <view class="filter-mask" bindtap="hideFilterPanel"></view>
    <view class="filter-content">
      <view class="filter-header">
        <text class="filter-title">ç­›é€‰æ¡ä»¶</text>
        <text class="filter-reset" bindtap="resetFilter">é‡ç½®</text>
      </view>
      
      <scroll-view class="filter-body" scroll-y="{{true}}">
        <!-- åˆ†ç±»ç­›é€‰ -->
        <view class="filter-section">
          <view class="filter-section-title">äº§å“åˆ†ç±»</view>
          <view class="filter-options">
            <view 
              class="filter-option {{filterOptions.category === item.id ? 'active' : ''}}"
              wx:for="{{categories}}"
              wx:key="id"
              data-type="category"
              data-value="{{item.id}}"
              bindtap="onFilterChange"
            >
              <text class="option-icon">{{item.icon}}</text>
              <text class="option-text">{{item.name}}</text>
            </view>
          </view>
        </view>
        
        <!-- è‚Œè‚¤ç±»å‹ç­›é€‰ -->
        <view class="filter-section">
          <view class="filter-section-title">è‚Œè‚¤ç±»å‹</view>
          <view class="filter-options">
            <view 
              class="filter-option {{filterOptions.skinType === item.id ? 'active' : ''}}"
              wx:for="{{skinTypes}}"
              wx:key="id"
              data-type="skinType"
              data-value="{{item.id}}"
              bindtap="onFilterChange"
            >
              <text class="option-text">{{item.name}}</text>
            </view>
          </view>
        </view>
        
        <!-- ä»·æ ¼åŒºé—´ç­›é€‰ -->
        <view class="filter-section">
          <view class="filter-section-title">ä»·æ ¼åŒºé—´</view>
          <view class="filter-options">
            <view 
              class="filter-option {{filterOptions.priceRange === item.id ? 'active' : ''}}"
              wx:for="{{priceRanges}}"
              wx:key="id"
              data-type="priceRange"
              data-value="{{item.id}}"
              bindtap="onFilterChange"
            >
              <text class="option-text">{{item.name}}</text>
            </view>
          </view>
        </view>
        
        <!-- å“ç‰Œç­›é€‰ -->
        <view class="filter-section">
          <view class="filter-section-title">å“ç‰Œ</view>
          <view class="filter-options">
            <view 
              class="filter-option {{filterOptions.brand === 'all' ? 'active' : ''}}"
              data-type="brand"
              data-value="all"
              bindtap="onFilterChange"
            >
              <text class="option-text">å…¨éƒ¨å“ç‰Œ</text>
            </view>
            <view 
              class="filter-option {{filterOptions.brand === item.name ? 'active' : ''}}"
              wx:for="{{brandList}}"
              wx:key="id"
              data-type="brand"
              data-value="{{item.name}}"
              bindtap="onFilterChange"
            >
              <text class="option-text">{{item.name}}</text>
            </view>
          </view>
        </view>
      </scroll-view>
      
      <view class="filter-footer">
        <button class="filter-cancel" bindtap="hideFilterPanel">å–æ¶ˆ</button>
        <button class="filter-confirm" bindtap="applyFilter">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- äº§å“è¯¦æƒ…å¼¹çª— -->
  <view class="product-detail-modal {{showProductDetail ? 'show' : ''}}" wx:if="{{selectedProduct}}">
    <view class="modal-mask" bindtap="closeProductDetail"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">äº§å“è¯¦æƒ…</text>
        <text class="modal-close" bindtap="closeProductDetail">âœ•</text>
      </view>
      
      <scroll-view class="modal-body" scroll-y="{{true}}">
        <view class="product-detail">
          <image 
            class="detail-image" 
            src="{{selectedProduct.image}}" 
            mode="aspectFill"
            lazy-load="{{true}}"
            data-type="product-detail"
            binderror="onImageError"
          />
          
          <view class="detail-info">
            <view class="detail-name">{{selectedProduct.name}}</view>
            <view class="detail-brand">{{selectedProduct.brand}}</view>
            
            <view class="detail-rating">
              <text class="rating-stars">â­</text>
              <text class="rating-score">{{selectedProduct.rating}}</text>
              <text class="rating-count">({{selectedProduct.sales}}äººè´­ä¹°)</text>
            </view>
            
            <view class="detail-price">
              <text class="current-price">Â¥{{selectedProduct.price}}</text>
              <text class="original-price" wx:if="{{selectedProduct.originalPrice !== selectedProduct.price}}">Â¥{{selectedProduct.originalPrice}}</text>
            </view>
            
            <view class="detail-description">{{selectedProduct.description}}</view>
            
            <view class="detail-section">
              <view class="section-title">é€‚ç”¨è‚Œè‚¤</view>
              <text class="skin-type">{{selectedProduct.skinTypes}}</text>
            </view>
            
            <view class="detail-section">
              <view class="section-title">ä¸»è¦åŠŸæ•ˆ</view>
              <text class="effect-tag">{{selectedProduct.effects}}</text>
            </view>
            
            <view class="detail-section">
              <view class="section-title">æ ¸å¿ƒæˆåˆ†</view>
              <text class="ingredient-tag">{{selectedProduct.ingredients}}</text>
            </view>
          </view>
        </view>
      </scroll-view>
      
      <view class="modal-footer">
        <button 
          class="favorite-btn {{selectedProduct.isFavorite ? 'active' : ''}}"
          data-id="{{selectedProduct.id}}"
          bindtap="toggleFavorite"
        >
          {{selectedProduct.isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—'}}
        </button>
        <button class="share-btn" data-id="{{selectedProduct.id}}" bindtap="shareProduct">åˆ†äº«</button>
      </view>
    </view>
  </view>

  <!-- æˆåˆ†è¯¦æƒ…å¼¹çª— -->
  <view class="ingredient-detail-modal {{showIngredientDetail ? 'show' : ''}}" wx:if="{{selectedIngredient}}">
    <view class="modal-mask" bindtap="closeIngredientDetail"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">æˆåˆ†è¯¦æƒ…</text>
        <text class="modal-close" bindtap="closeIngredientDetail">âœ•</text>
      </view>
      
      <scroll-view class="modal-body" scroll-y="{{true}}">
        <view class="ingredient-detail">
          <view class="ingredient-header">
            <view class="ingredient-name">{{selectedIngredient.name}}</view>
            <view class="ingredient-english">{{selectedIngredient.englishName}}</view>
          </view>
          
          <view class="ingredient-safety">
            <view class="safety-score">
              <text class="score-label">å®‰å…¨è¯„åˆ†</text>
              <text class="score-value">{{selectedIngredient.safetyScore}}/10</text>
            </view>
            <view class="safety-level {{selectedIngredient.safetyLevel}}">
              <text class="safety-icon">{{selectedIngredient.safetyLevel === 'safe' ? 'âœ…' : 'âš ï¸'}}</text>
              <text class="safety-text">{{selectedIngredient.safetyLevel === 'safe' ? 'å®‰å…¨' : 'éœ€æ³¨æ„'}}</text>
            </view>
          </view>
          
          <view class="ingredient-effects">
            <view class="section-title">ä¸»è¦åŠŸæ•ˆ</view>
            <view class="effect-list">
              <text 
                class="effect-tag"
                wx:for="{{selectedIngredient.effects}}"
                wx:for-item="effect"
                wx:key="*this"
              >{{effect}}</text>
            </view>
          </view>
          
          <view class="ingredient-description">
            <view class="section-title">æˆåˆ†è¯´æ˜</view>
            <text class="description-text">{{selectedIngredient.description}}</text>
          </view>
          
          <view class="ingredient-usage">
            <view class="section-title">ä½¿ç”¨å»ºè®®</view>
            <text class="usage-text">{{selectedIngredient.usage}}</text>
          </view>
          
          <view class="ingredient-precautions">
            <view class="section-title">æ³¨æ„äº‹é¡¹</view>
            <text class="precautions-text">{{selectedIngredient.precautions}}</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>
</view>