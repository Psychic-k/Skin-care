<!--pages/product-detail/product-detail.wxml-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- äº§å“å†…å®¹ -->
  <view class="product-content" wx:else>
    <!-- äº§å“å›¾ç‰‡è½®æ’­ -->
    <view class="image-section">
      <swiper 
        class="product-swiper" 
        indicator-dots="{{true}}" 
        indicator-color="rgba(255,255,255,0.5)"
        indicator-active-color="#ffffff"
        bindchange="onImageChange"
      >
        <swiper-item 
          wx:for="{{product.images}}" 
          wx:key="*this"
          data-index="{{index}}"
          bindtap="previewImage"
        >
          <image 
            class="product-image" 
            src="{{item}}" 
            mode="aspectFit"
            lazy-load="{{true}}"
            data-index="{{index}}"
            data-type="product-detail"
            binderror="onImageError"
          />
        </swiper-item>
      </swiper>
      
      <!-- æ”¶è—æŒ‰é’® -->
      <view class="favorite-btn {{isFavorited ? 'favorited' : ''}}" bindtap="toggleFavorite">
        <text class="favorite-icon">{{isFavorited ? 'â¤ï¸' : 'ğŸ¤'}}</text>
      </view>
    </view>

    <!-- äº§å“åŸºæœ¬ä¿¡æ¯ -->
    <view class="product-info">
      <view class="product-header">
        <view class="product-name">{{product.name}}</view>
        <view class="product-english">{{product.englishName}}</view>
        <view class="product-brand">{{product.brand}}</view>
      </view>
      
      <view class="product-price">
        <view class="current-price">Â¥{{product.price}}</view>
        <view class="original-price" wx:if="{{product.originalPrice > product.price}}">Â¥{{product.originalPrice}}</view>
        <view class="discount" wx:if="{{product.discountText}}">{{product.discountText}}</view>
      </view>
      
      <view class="product-stats">
        <view class="stat-item">
          <text class="stat-icon">â­</text>
          <text class="stat-value">{{product.rating}}</text>
          <text class="stat-label">({{product.reviewCount}}æ¡è¯„ä»·)</text>
        </view>
        <view class="stat-item">
          <text class="stat-icon">ğŸ“¦</text>
          <text class="stat-value">{{product.salesCount}}</text>
          <text class="stat-label">å·²å”®</text>
        </view>
      </view>
      
      <view class="product-tags">
        <view class="tag category-tag">{{product.category}}</view>
        <view 
          class="tag skin-tag" 
          wx:for="{{product.skinTypes}}" 
          wx:key="*this"
        >
          {{item}}
        </view>
        <view 
          class="tag effect-tag" 
          wx:for="{{product.effects}}" 
          wx:key="*this"
        >
          {{item}}
        </view>
      </view>
    </view>

    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
    <view class="tab-nav">
      <view 
        class="tab-item {{currentTab === item.id ? 'active' : ''}}"
        wx:for="{{tabs}}" 
        wx:key="id"
        data-tab="{{item.id}}"
        bindtap="switchTab"
      >
        <text class="tab-icon">{{item.icon}}</text>
        <text class="tab-name">{{item.name}}</text>
      </view>
    </view>

    <!-- æ ‡ç­¾é¡µå†…å®¹ -->
    <view class="tab-content">
      <!-- äº§å“è¯¦æƒ… -->
      <view class="detail-tab" wx:if="{{currentTab === 0}}">
        <view class="detail-section">
          <view class="section-title">äº§å“æè¿°</view>
          <view class="product-description">{{product.description}}</view>
        </view>
        
        <view class="detail-section">
          <view class="section-title">äº§å“è§„æ ¼</view>
          <view class="spec-list">
            <view class="spec-item">
              <text class="spec-label">å®¹é‡ï¼š</text>
              <text class="spec-value">{{product.volume}}</text>
            </view>
            <view class="spec-item">
              <text class="spec-label">äº§åœ°ï¼š</text>
              <text class="spec-value">{{product.origin}}</text>
            </view>
            <view class="spec-item">
              <text class="spec-label">ä¿è´¨æœŸï¼š</text>
              <text class="spec-value">{{product.shelfLife}}</text>
            </view>
          </view>
        </view>
        
        <view class="detail-section">
          <view class="section-title">äº§å“ç‰¹è‰²</view>
          <view class="feature-list">
            <view 
              class="feature-item" 
              wx:for="{{product.features}}" 
              wx:key="*this"
            >
              <text class="feature-icon">âœ¨</text>
              <text class="feature-text">{{item}}</text>
            </view>
          </view>
        </view>
        
        <view class="detail-section">
          <view class="section-title">ä½¿ç”¨æ–¹æ³•</view>
          <view class="usage-list">
            <view 
              class="usage-item" 
              wx:for="{{product.usage}}" 
              wx:key="*this"
            >
              <text class="usage-step">{{index + 1}}.</text>
              <text class="usage-text">{{item}}</text>
            </view>
          </view>
        </view>
        
        <view class="detail-section">
          <view class="section-title">æ³¨æ„äº‹é¡¹</view>
          <view class="precaution-list">
            <view 
              class="precaution-item" 
              wx:for="{{product.precautions}}" 
              wx:key="*this"
            >
              <text class="precaution-icon">âš ï¸</text>
              <text class="precaution-text">{{item}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æˆåˆ†åˆ†æ -->
      <view class="ingredient-tab" wx:if="{{currentTab === 1}}">
        <view class="ingredient-stats">
          <view class="stats-header">
            <view class="stats-title">æˆåˆ†å®‰å…¨åˆ†æ</view>
            <view class="stats-total">å…±{{ingredientStats.total}}ç§æˆåˆ†</view>
          </view>
          <view class="stats-chart">
            <view class="stat-item safe">
              <view class="stat-number">{{ingredientStats.safe}}</view>
              <view class="stat-label">å®‰å…¨</view>
            </view>
            <view class="stat-item caution">
              <view class="stat-number">{{ingredientStats.caution}}</view>
              <view class="stat-label">æ³¨æ„</view>
            </view>
            <view class="stat-item danger">
              <view class="stat-number">{{ingredientStats.danger}}</view>
              <view class="stat-label">é£é™©</view>
            </view>
          </view>
        </view>
        
        <view class="ingredient-list">
          <view 
            class="ingredient-item"
            wx:for="{{ingredients}}" 
            wx:key="id"
            data-ingredient="{{item}}"
            bindtap="showIngredientDetail"
          >
            <view class="ingredient-header">
              <view class="ingredient-name">{{item.name}}</view>
              <view class="ingredient-concentration">{{item.concentration}}</view>
            </view>
            <view class="ingredient-english">{{item.englishName}}</view>
            <view class="ingredient-info">
              <view class="safety-level {{item.safetyLevel}}">
                {{item.safetyLevel === 'safe' ? 'å®‰å…¨' : item.safetyLevel === 'caution' ? 'æ³¨æ„' : 'é£é™©'}}
              </view>
              <view class="ingredient-function">{{item.function}}</view>
            </view>
            <view class="ingredient-effects">
              <view 
                class="effect-tag" 
                wx:for="{{item.effects}}" 
                wx:for-item="effect"
                wx:key="*this"
              >
                {{effect}}
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- ç”¨æˆ·è¯„ä»· -->
      <view class="review-tab" wx:if="{{currentTab === 2}}">
        <view class="review-summary">
          <view class="rating-overview">
            <view class="average-rating">
              <view class="rating-number">{{reviewStats.averageRating}}</view>
              <view class="rating-stars">
                <text class="star filled">â­</text>
                <text class="star filled">â­</text>
                <text class="star filled">â­</text>
                <text class="star filled">â­</text>
                <text class="star">â­</text>
              </view>
              <view class="rating-count">{{reviewStats.totalCount}}æ¡è¯„ä»·</view>
            </view>
            <view class="rating-distribution">
              <view class="rating-bar" wx:for="{{[5,4,3,2,1]}}" wx:key="*this">
                <text class="rating-label">{{item}}æ˜Ÿ</text>
                <view class="bar-container">
                  <view class="bar-fill" style="width: {{(reviewStats.ratingDistribution[item] / reviewStats.totalCount * 100) || 0}}%"></view>
                </view>
                <text class="rating-count">{{reviewStats.ratingDistribution[item] || 0}}</text>
              </view>
            </view>
          </view>
        </view>
        
        <view class="review-filters">
          <view 
            class="filter-item {{reviewFilter === 'all' ? 'active' : ''}}"
            data-filter="all"
            bindtap="filterReviews"
          >
            å…¨éƒ¨
          </view>
          <view 
            class="filter-item {{reviewFilter === '5' ? 'active' : ''}}"
            data-filter="5"
            bindtap="filterReviews"
          >
            å¥½è¯„
          </view>
          <view 
            class="filter-item {{reviewFilter === '3' ? 'active' : ''}}"
            data-filter="3"
            bindtap="filterReviews"
          >
            ä¸­è¯„
          </view>
          <view 
            class="filter-item {{reviewFilter === '1' ? 'active' : ''}}"
            data-filter="1"
            bindtap="filterReviews"
          >
            å·®è¯„
          </view>
          <view 
            class="filter-item {{reviewFilter === 'withImages' ? 'active' : ''}}"
            data-filter="withImages"
            bindtap="filterReviews"
          >
            æœ‰å›¾
          </view>
        </view>
        
        <view class="review-list">
          <view 
            class="review-item"
            wx:for="{{reviews}}" 
            wx:key="id"
          >
            <view class="review-header">
              <image class="user-avatar" src="{{item.avatar}}" mode="aspectFit" />
              <view class="user-info">
                <view class="user-name">{{item.userName}}</view>
                <view class="user-meta">
                  <text class="skin-type">{{item.skinType}}</text>
                  <text class="age">{{item.age}}</text>
                  <text class="review-date">{{item.createTime}}</text>
                </view>
              </view>
              <view class="review-rating">
                <view class="stars">
                  <text class="star {{index < item.rating ? 'filled' : ''}}" wx:for="{{[1,2,3,4,5]}}" wx:key="*this">â­</text>
                </view>
              </view>
            </view>
            
            <view class="review-content">{{item.content}}</view>
            
            <view class="review-images" wx:if="{{item.images.length > 0}}">
              <image 
                class="review-image" 
                wx:for="{{item.images}}" 
                wx:for-item="image"
                wx:key="*this"
                src="{{image}}" 
                mode="aspectFit"
                bindtap="previewImage"
                data-urls="{{item.images}}"
                data-current="{{image}}"
              />
            </view>
            
            <view class="review-tags" wx:if="{{item.tags.length > 0}}">
              <view 
                class="review-tag" 
                wx:for="{{item.tags}}" 
                wx:for-item="tag"
                wx:key="*this"
              >
                {{tag}}
              </view>
            </view>
            
            <view class="review-actions">
              <view 
                class="action-btn like-btn {{item.isLiked ? 'liked' : ''}}"
                data-review-id="{{item.id}}"
                bindtap="toggleReviewLike"
              >
                <text class="action-icon">{{item.isLiked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
                <text class="action-text">{{item.likeCount}}</text>
              </view>
            </view>
          </view>
        </view>
        
        <view class="load-more-reviews" wx:if="{{hasMoreReviews}}" bindtap="loadProductReviews">
          <text class="load-more-text">æŸ¥çœ‹æ›´å¤šè¯„ä»·</text>
        </view>
      </view>

      <!-- ç›¸å…³æ¨è -->
      <view class="related-tab" wx:if="{{currentTab === 3}}">
        <view class="related-title">ç›¸å…³æ¨è</view>
        <view class="related-grid">
          <view 
            class="related-item"
            wx:for="{{relatedProducts}}" 
            wx:key="id"
            data-product-id="{{item.id}}"
            bindtap="viewRelatedProduct"
          >
            <image class="related-image" src="{{item.image}}" mode="aspectFit" />
            <view class="related-info">
              <view class="related-name">{{item.name}}</view>
              <view class="related-brand">{{item.brand}}</view>
              <view class="related-price">
                <text class="current-price">Â¥{{item.price}}</text>
                <text class="original-price" wx:if="{{item.originalPrice > item.price}}">Â¥{{item.originalPrice}}</text>
              </view>
              <view class="related-rating">
                <text class="rating-icon">â­</text>
                <text class="rating-value">{{item.rating}}</text>
                <text class="review-count">({{item.reviewCount}})</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar" wx:if="{{!loading}}">
    <view class="bar-actions">
      <view class="action-item" bindtap="contactService">
        <text class="action-icon">ğŸ’¬</text>
        <text class="action-text">å®¢æœ</text>
      </view>
      <view class="action-item" bindtap="toggleFavorite">
        <text class="action-icon">{{isFavorited ? 'â¤ï¸' : 'ğŸ¤'}}</text>
        <text class="action-text">{{isFavorited ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
      </view>
    </view>
    <view class="bar-buttons">
      <view class="btn-secondary" bindtap="showSkuModal">åŠ å…¥è´­ç‰©è½¦</view>
      <view class="btn-primary" bindtap="showSkuModal">ç«‹å³è´­ä¹°</view>
    </view>
  </view>

  <!-- æˆåˆ†è¯¦æƒ…å¼¹çª— -->
  <view class="ingredient-modal {{showIngredientDetail ? 'show' : ''}}" wx:if="{{showIngredientDetail && selectedIngredient}}">
    <view class="modal-mask" bindtap="closeIngredientDetail"></view>
    <view class="modal-content">
      <view class="modal-header">
        <view class="ingredient-title">{{selectedIngredient.name}}</view>
        <view class="modal-close" bindtap="closeIngredientDetail">âœ•</view>
      </view>
      
      <scroll-view class="modal-body" scroll-y>
        <view class="ingredient-detail">
          <view class="detail-item">
            <view class="detail-label">è‹±æ–‡åç§°</view>
            <view class="detail-value">{{selectedIngredient.englishName}}</view>
          </view>
          <view class="detail-item">
            <view class="detail-label">æµ“åº¦</view>
            <view class="detail-value">{{selectedIngredient.concentration}}</view>
          </view>
          <view class="detail-item">
            <view class="detail-label">å®‰å…¨ç­‰çº§</view>
            <view class="detail-value safety-level {{selectedIngredient.safetyLevel}}">
              {{selectedIngredient.safetyLevel === 'safe' ? 'å®‰å…¨' : selectedIngredient.safetyLevel === 'caution' ? 'æ³¨æ„' : 'é£é™©'}}
            </view>
          </view>
          <view class="detail-item">
            <view class="detail-label">åŠŸèƒ½</view>
            <view class="detail-value">{{selectedIngredient.function}}</view>
          </view>
          <view class="detail-item">
            <view class="detail-label">åŠŸæ•ˆ</view>
            <view class="detail-value">
              <view 
                class="effect-tag" 
                wx:for="{{selectedIngredient.effects}}" 
                wx:key="*this"
              >
                {{item}}
              </view>
            </view>
          </view>
          <view class="detail-item">
            <view class="detail-label">è¯´æ˜</view>
            <view class="detail-value description">{{selectedIngredient.description}}</view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- è§„æ ¼é€‰æ‹©å¼¹çª— -->
  <view class="sku-modal {{showSkuModal ? 'show' : ''}}" wx:if="{{showSkuModal && product}}">
    <view class="modal-mask" bindtap="closeSkuModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <view class="sku-product-info">
          <image class="sku-image" src="{{product.images[0]}}" mode="aspectFit" />
          <view class="sku-info">
            <view class="sku-name">{{product.name}}</view>
            <view class="sku-price">Â¥{{selectedSku ? selectedSku.price : product.price}}</view>
            <view class="sku-stock">åº“å­˜ï¼š{{selectedSku ? selectedSku.stock : 'è¯·é€‰æ‹©è§„æ ¼'}}</view>
          </view>
        </view>
        <view class="modal-close" bindtap="closeSkuModal">âœ•</view>
      </view>
      
      <view class="modal-body">
        <view class="sku-section">
          <view class="sku-title">é€‰æ‹©è§„æ ¼</view>
          <view class="sku-options">
            <view 
              class="sku-option {{selectedSku && selectedSku.id === item.id ? 'selected' : ''}}"
              wx:for="{{product.skus}}" 
              wx:key="id"
              data-sku="{{item}}"
              bindtap="selectSku"
            >
              <view class="sku-volume">{{item.volume}}</view>
              <view class="sku-price-info">
                <text class="sku-current-price">Â¥{{item.price}}</text>
                <text class="sku-original-price" wx:if="{{item.originalPrice > item.price}}">Â¥{{item.originalPrice}}</text>
              </view>
            </view>
          </view>
        </view>
        
        <view class="quantity-section" wx:if="{{selectedSku}}">
          <view class="quantity-title">è´­ä¹°æ•°é‡</view>
          <view class="quantity-controls">
            <view class="quantity-btn" bindtap="decreaseQuantity">-</view>
            <view class="quantity-input">{{quantity}}</view>
            <view class="quantity-btn" bindtap="increaseQuantity">+</view>
          </view>
        </view>
      </view>
      
      <view class="modal-footer" wx:if="{{selectedSku}}">
        <view class="modal-btn add-cart-btn" bindtap="addToCart">åŠ å…¥è´­ç‰©è½¦</view>
        <view class="modal-btn buy-now-btn" bindtap="buyNow">ç«‹å³è´­ä¹°</view>
      </view>
    </view>
  </view>
</view>