<!--pages/profile/profile.wxml-->
<view class="profile-container">
  <!-- å¤´éƒ¨ä¿¡æ¯ -->
  <view class="profile-header">
    <view class="user-avatar">
      <image src="{{userInfo.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
    </view>
    <view class="user-info">
      <text class="username">{{userInfo.nickName || 'æŠ¤è‚¤è¾¾äºº'}}</text>
      <text class="join-date">åŠ å…¥æ—¶é—´ï¼š{{userInfo.createTime || '2024-01-01'}}</text>
    </view>
    <view class="profile-stats">
      <view class="stat-item">
        <text class="stat-number">{{detectionHistory.length || 0}}</text>
        <text class="stat-label">æ£€æµ‹æ¬¡æ•°</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{profileData.skinAge || '--'}}</text>
        <text class="stat-label">è‚Œé¾„</text>
      </view>
      <view class="stat-item">
        <text class="stat-number">{{profileData.skinScore || '--'}}</text>
        <text class="stat-label">è‚Œè‚¤è¯„åˆ†</text>
      </view>
    </view>
  </view>

  <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
  <view class="tab-nav">
    <view class="tab-item {{currentTab === 'overview' ? 'active' : ''}}" 
          data-tab="overview" bindtap="switchTab">
      <text>æ¡£æ¡ˆæ¦‚è§ˆ</text>
    </view>
    <view class="tab-item {{currentTab === 'history' ? 'active' : ''}}" 
          data-tab="history" bindtap="switchTab">
      <text>æ£€æµ‹å†å²</text>
    </view>
    <view class="tab-item {{currentTab === 'analysis' ? 'active' : ''}}" 
          data-tab="analysis" bindtap="switchTab">
      <text>è¶‹åŠ¿åˆ†æ</text>
    </view>
    <view class="tab-item {{currentTab === 'settings' ? 'active' : ''}}" 
          data-tab="settings" bindtap="switchTab">
      <text>è®¾ç½®</text>
    </view>
  </view>

  <!-- æ¡£æ¡ˆæ¦‚è§ˆ -->
  <view class="tab-content" wx:if="{{currentTab === 'overview'}}">
    <!-- çš®è‚¤æ¡£æ¡ˆå¡ç‰‡ -->
    <view class="profile-card">
      <view class="card-header">
        <text class="card-title">çš®è‚¤æ¡£æ¡ˆ</text>
        <view class="edit-btn" bindtap="{{isEditing ? 'saveEdit' : 'startEdit'}}">
          <text>{{isEditing ? 'ä¿å­˜' : 'ç¼–è¾‘'}}</text>
        </view>
        <view class="cancel-btn" wx:if="{{isEditing}}" bindtap="cancelEdit">
          <text>å–æ¶ˆ</text>
        </view>
      </view>
      
      <!-- çš®è‚¤ç±»å‹ -->
      <view class="profile-section">
        <text class="section-title">çš®è‚¤ç±»å‹</text>
        <view class="skin-types" wx:if="{{!isEditing}}">
          <view class="skin-type-tag selected" wx:if="{{skinProfile.skinType}}">
            {{getSkinTypeName(skinProfile.skinType)}}
          </view>
          <text class="empty-text" wx:else>æœªè®¾ç½®</text>
        </view>
        <view class="skin-types-edit" wx:else>
          <view class="skin-type-option {{editData.skinType === item.id ? 'selected' : ''}}"
                wx:for="{{skinTypes}}" wx:key="id"
                data-type="{{item.id}}" bindtap="selectSkinType">
            <text class="type-name">{{item.name}}</text>
            <text class="type-desc">{{item.desc}}</text>
          </view>
        </view>
      </view>

      <!-- æŠ¤è‚¤å…³æ³¨ç‚¹ -->
      <view class="profile-section">
        <text class="section-title">æŠ¤è‚¤å…³æ³¨ç‚¹</text>
        <view class="concerns-list" wx:if="{{!isEditing}}">
          <view class="concern-tag" wx:for="{{skinProfile.concerns}}" wx:key="*this">
            <text class="concern-icon">{{getSkinConcernInfo(item, 'icon')}}</text>
            <text class="concern-name">{{getSkinConcernInfo(item, 'name')}}</text>
          </view>
          <text class="empty-text" wx:if="{{!skinProfile.concerns.length}}">æœªè®¾ç½®</text>
        </view>
        <view class="concerns-edit" wx:else>
          <view class="concern-option {{editData.concerns.includes(item.id) ? 'selected' : ''}}"
                wx:for="{{skinConcerns}}" wx:key="id"
                data-id="{{item.id}}" bindtap="toggleConcern">
            <text class="concern-icon">{{item.icon}}</text>
            <text class="concern-name">{{item.name}}</text>
          </view>
        </view>
      </view>

      <!-- æŠ¤è‚¤ç›®æ ‡ -->
      <view class="profile-section">
        <text class="section-title">æŠ¤è‚¤ç›®æ ‡</text>
        <view class="goals-list" wx:if="{{!isEditing}}">
          <view class="goal-tag" wx:for="{{skinProfile.goals}}" wx:key="*this">
            <text class="goal-icon">{{getSkinGoalInfo(item, 'icon')}}</text>
            <text class="goal-name">{{getSkinGoalInfo(item, 'name')}}</text>
          </view>
          <text class="empty-text" wx:if="{{!skinProfile.goals.length}}">æœªè®¾ç½®</text>
        </view>
        <view class="goals-edit" wx:else>
          <view class="goal-option {{editData.goals.includes(item.id) ? 'selected' : ''}}"
                wx:for="{{skinGoals}}" wx:key="id"
                data-id="{{item.id}}" bindtap="toggleGoal">
            <text class="goal-icon">{{item.icon}}</text>
            <text class="goal-name">{{item.name}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æœ€è¿‘æ£€æµ‹ -->
    <view class="recent-detection" wx:if="{{detectionHistory.length > 0}}">
      <view class="section-header">
        <text class="section-title">æœ€è¿‘æ£€æµ‹</text>
        <text class="view-all" bindtap="switchTab" data-tab="history">æŸ¥çœ‹å…¨éƒ¨</text>
      </view>
      <view class="detection-item" wx:for="{{detectionHistory.slice(0, 3)}}" wx:key="id"
            data-id="{{item.id}}" bindtap="viewDetectionDetail">
        <view class="detection-info">
          <text class="detection-type">{{item.type}}</text>
          <text class="detection-date">{{item.createTime}}</text>
        </view>
        <view class="detection-score">
          <text class="score-number">{{item.overallScore}}</text>
          <text class="score-label">åˆ†</text>
        </view>
      </view>
    </view>

    <!-- å¿«æ·æ“ä½œ -->
    <view class="quick-actions">
      <view class="action-item" bindtap="startNewDetection">
        <view class="action-icon">ğŸ“·</view>
        <text class="action-text">å¼€å§‹æ£€æµ‹</text>
      </view>
      <view class="action-item" bindtap="viewTrendAnalysis">
        <view class="action-icon">ğŸ“Š</view>
        <text class="action-text">è¶‹åŠ¿åˆ†æ</text>
      </view>
      <view class="action-item" bindtap="shareProfile">
        <view class="action-icon">ğŸ“¤</view>
        <text class="action-text">åˆ†äº«æ¡£æ¡ˆ</text>
      </view>
    </view>
  </view>

  <!-- æ£€æµ‹å†å² -->
  <view class="tab-content" wx:if="{{currentTab === 'history'}}">
    <view class="history-list" wx:if="{{detectionHistory.length > 0}}">
      <view class="history-item" wx:for="{{detectionHistory}}" wx:key="id">
        <view class="history-info" data-id="{{item.id}}" bindtap="viewDetectionDetail">
          <view class="history-header">
            <text class="history-type">{{item.type}}</text>
            <text class="history-date">{{item.createTime}}</text>
          </view>
          <view class="history-summary">
            <text class="summary-text">ç»¼åˆè¯„åˆ†ï¼š{{item.overallScore}}åˆ†</text>
            <text class="summary-issues" wx:if="{{item.mainIssues}}">
              ä¸»è¦é—®é¢˜ï¼š{{item.mainIssues}}
            </text>
          </view>
        </view>
        <view class="history-actions">
          <view class="action-btn view-btn" data-id="{{item.id}}" bindtap="viewDetectionDetail">
            <text>æŸ¥çœ‹</text>
          </view>
          <view class="action-btn delete-btn" data-id="{{item.id}}" bindtap="deleteDetection">
            <text>åˆ é™¤</text>
          </view>
        </view>
      </view>
    </view>
    <view class="empty-state" wx:else>
      <view class="empty-icon">ğŸ“‹</view>
      <text class="empty-text">æš‚æ— æ£€æµ‹è®°å½•</text>
      <view class="empty-action" bindtap="startNewDetection">
        <text>å¼€å§‹ç¬¬ä¸€æ¬¡æ£€æµ‹</text>
      </view>
    </view>
  </view>

  <!-- è¶‹åŠ¿åˆ†æ -->
  <view class="tab-content" wx:if="{{currentTab === 'analysis'}}">
    <view class="trend-analysis" wx:if="{{trendData}}">
      <view class="trend-summary">
        <text class="trend-title">è‚Œè‚¤å˜åŒ–è¶‹åŠ¿</text>
        <view class="trend-period">
          <text>è¿‘30å¤©æ•°æ®åˆ†æ</text>
        </view>
      </view>
      
      <!-- è¿™é‡Œå¯ä»¥æ·»åŠ å›¾è¡¨ç»„ä»¶ -->
      <view class="trend-chart">
        <text class="chart-placeholder">è¶‹åŠ¿å›¾è¡¨ï¼ˆå¾…å®ç°ï¼‰</text>
      </view>
      
      <view class="trend-insights">
        <view class="insight-item" wx:for="{{trendData.insights}}" wx:key="*this">
          <text class="insight-text">{{item}}</text>
        </view>
      </view>
    </view>
    <view class="empty-state" wx:else>
      <view class="empty-icon">ğŸ“ˆ</view>
      <text class="empty-text">æ•°æ®ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆè¶‹åŠ¿åˆ†æ</text>
      <text class="empty-desc">è‡³å°‘éœ€è¦3æ¬¡æ£€æµ‹è®°å½•</text>
    </view>
  </view>

  <!-- è®¾ç½® -->
  <view class="tab-content" wx:if="{{currentTab === 'settings'}}">
    <view class="settings-list">
      <view class="setting-item" bindtap="exportData">
        <text class="setting-text">å¯¼å‡ºæ•°æ®</text>
        <text class="setting-arrow">></text>
      </view>
      <view class="setting-item">
        <text class="setting-text">éšç§è®¾ç½®</text>
        <text class="setting-arrow">></text>
      </view>
      <view class="setting-item">
        <text class="setting-text">é€šçŸ¥è®¾ç½®</text>
        <text class="setting-arrow">></text>
      </view>
      <view class="setting-item">
        <text class="setting-text">å…³äºæˆ‘ä»¬</text>
        <text class="setting-arrow">></text>
      </view>
    </view>
  </view>
</view>