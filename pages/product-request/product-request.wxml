<!--pages/product-request/product-request.wxml-->
<view class="container">
  <!-- å¤´éƒ¨åŒºåŸŸ -->
  <view class="header">
    <view class="header-content">
      <text class="title">äº§å“å‚¬æ›´</text>
      <text class="subtitle">æäº¤æ–°äº§å“ä¿¡æ¯ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸</text>
    </view>
  </view>

  <!-- è¡¨å•åŒºåŸŸ -->
  <view class="form-section">
    <form bindsubmit="submitRequest">
      <!-- äº§å“åŸºæœ¬ä¿¡æ¯ -->
      <view class="form-group">
        <text class="form-label">äº§å“åç§° <text class="required">*</text></text>
        <input 
          class="form-input" 
          placeholder="è¯·è¾“å…¥äº§å“å®Œæ•´åç§°"
          value="{{formData.productName}}"
          bindinput="onInputChange"
          data-field="productName"
          maxlength="100"
        />
        <text class="form-hint">è¯·è¾“å…¥äº§å“çš„å®Œæ•´åç§°ï¼ŒåŒ…æ‹¬ç³»åˆ—åï¼ˆXXç³»åˆ—-XXXXï¼‰</text>
      </view>

      <view class="form-group">
        <text class="form-label">å“ç‰Œåç§° <text class="required">*</text></text>
        <input 
          class="form-input" 
          placeholder="è¯·è¾“å…¥å“ç‰Œåç§°"
          value="{{formData.brand}}"
          bindinput="onInputChange"
          data-field="brand"
          maxlength="50"
        />
      </view>

      <view class="form-group">
        <text class="form-label">äº§å“åˆ†ç±» <text class="required">*</text></text>
        <view class="category-selector" bindtap="showCategoryPicker">
          <text class="{{formData.category ? 'selected' : 'placeholder'}}">
            {{categoryDisplay || 'è¯·é€‰æ‹©äº§å“åˆ†ç±»'}}
          </text>
          <text class="arrow">â–¼</text>
        </view>
      </view>

      <view class="form-group">
        <text class="form-label">äº§å“æè¿°</text>
        <textarea 
          class="form-textarea" 
          placeholder="è¯·æè¿°äº§å“çš„åŠŸæ•ˆã€æˆåˆ†ã€é€‚ç”¨è‚Œè‚¤ç±»å‹ç­‰ä¿¡æ¯"
          value="{{formData.description}}"
          bindinput="onInputChange"
          data-field="description"
          maxlength="500"
          show-confirm-bar="{{false}}"
        />
        <text class="char-count">{{formData.description.length}}/500</text>
      </view>

      <!-- äº§å“å›¾ç‰‡ -->
      <view class="form-group">
        <text class="form-label">äº§å“å›¾ç‰‡ <text class="required">*</text></text>
        <view class="image-upload-section">
          <view class="uploaded-images" wx:if="{{uploadedImages.length > 0}}">
            <view 
              class="image-item" 
              wx:for="{{uploadedImages}}" 
              wx:key="index"
            >
              <image 
                class="uploaded-image" 
                src="{{item.url}}" 
                mode="aspectFill"
                bindtap="previewImage"
                data-url="{{item.url}}"
              />
              <view 
                class="image-delete" 
                bindtap="deleteImage"
                data-index="{{index}}"
              >
                <text>Ã—</text>
              </view>
              <view class="image-status" wx:if="{{item.uploading}}">
                <view class="uploading-spinner"></view>
              </view>
            </view>
          </view>
          
          <view 
            class="image-upload-btn" 
            bindtap="chooseImage"
            wx:if="{{uploadedImages.length < maxImages}}"
          >
            <text class="upload-icon">ğŸ“·</text>
            <text class="upload-text">æ·»åŠ å›¾ç‰‡</text>
            <text class="upload-hint">{{uploadedImages.length}}/{{maxImages}}</text>
          </view>
        </view>
        <text class="form-hint">è¯·ä¸Šä¼ äº§å“çš„æ¸…æ™°å›¾ç‰‡ï¼Œæœ€å¤š{{maxImages}}å¼ </text>
      </view>

      <!-- è”ç³»ä¿¡æ¯ -->
      <view class="form-group">
        <text class="form-label">è”ç³»æ–¹å¼</text>
        <input 
          class="form-input" 
          placeholder="å¾®ä¿¡å·ã€QQå·æˆ–å…¶ä»–è”ç³»æ–¹å¼ï¼ˆå¯é€‰ï¼‰"
          value="{{formData.contact}}"
          bindinput="onInputChange"
          data-field="contact"
          maxlength="50"
        />
        <text class="form-hint">æ–¹ä¾¿ç®¡ç†å‘˜è”ç³»æ‚¨ç¡®è®¤äº§å“ä¿¡æ¯</text>
      </view>

      <!-- å¤‡æ³¨ä¿¡æ¯ -->
      <view class="form-group">
        <text class="form-label">å¤‡æ³¨ä¿¡æ¯</text>
        <textarea 
          class="form-textarea" 
          placeholder="å…¶ä»–éœ€è¦è¯´æ˜çš„ä¿¡æ¯ï¼Œå¦‚è´­ä¹°æ¸ é“ã€ä½¿ç”¨æ„Ÿå—ç­‰"
          value="{{formData.notes}}"
          bindinput="onInputChange"
          data-field="notes"
          maxlength="300"
          show-confirm-bar="{{false}}"
        />
        <text class="char-count">{{formData.notes.length}}/300</text>
      </view>

      <!-- æäº¤æŒ‰é’® -->
      <view class="submit-section">
        <button 
          class="submit-btn {{canSubmit ? 'active' : 'disabled'}}" 
          form-type="submit"
          disabled="{{!canSubmit || submitting}}"
        >
          <text wx:if="{{!submitting}}">æäº¤ç”³è¯·</text>
          <view wx:else class="submitting">
            <view class="loading-spinner"></view>
            <text>æäº¤ä¸­...</text>
          </view>
        </button>
        <text class="submit-hint">æäº¤åå°†è¿›å…¥å®¡æ ¸æµç¨‹ï¼Œè¯·è€å¿ƒç­‰å¾…</text>
      </view>
    </form>
  </view>

  <!-- æˆ‘çš„ç”³è¯·è®°å½• -->
  <view class="history-section">
    <view class="section-header" bindtap="toggleHistory">
      <text class="section-title">æˆ‘çš„ç”³è¯·è®°å½•</text>
      <text class="toggle-icon {{showHistory ? 'expanded' : ''}}">â–¼</text>
    </view>
    
    <view class="history-content" wx:if="{{showHistory}}">
      <!-- åŠ è½½çŠ¶æ€ -->
      <view class="loading-container" wx:if="{{historyLoading}}">
        <view class="loading-spinner"></view>
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-container" wx:elif="{{requestHistory.length === 0}}">
        <text class="empty-text">æš‚æ— ç”³è¯·è®°å½•</text>
      </view>

      <!-- ç”³è¯·åˆ—è¡¨ -->
      <view class="request-list" wx:else>
        <view 
          class="request-item" 
          wx:for="{{requestHistory}}" 
          wx:key="_id"
        >
          <view class="request-header">
            <text class="request-name">{{item.productName}}</text>
            <view class="request-status {{item.status}}">
              <text>{{getStatusText(item.status)}}</text>
            </view>
          </view>
          <view class="request-info">
            <text class="request-brand">{{item.brand}}</text>
            <text class="request-date">{{item.submitDateDisplay}}</text>
          </view>
          <view class="request-description" wx:if="{{item.description}}">
            <text>{{item.description}}</text>
          </view>
          <view class="request-feedback" wx:if="{{item.adminFeedback}}">
            <text class="feedback-label">ç®¡ç†å‘˜åé¦ˆï¼š</text>
            <text class="feedback-text">{{item.adminFeedback}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åˆ†ç±»é€‰æ‹©å™¨ -->
  <view class="modal-overlay" wx:if="{{showCategoryModal}}" bindtap="hideCategoryModal">
    <view class="category-modal" catchtap="true">
      <view class="modal-header">
        <text class="modal-title">é€‰æ‹©äº§å“åˆ†ç±»</text>
        <view class="modal-close" bindtap="hideCategoryModal">Ã—</view>
      </view>
      <view class="modal-content">
        <view 
          class="category-option {{formData.category === item.value ? 'selected' : ''}}"
          wx:for="{{categoryOptions}}" 
          wx:key="value"
          bindtap="selectCategory"
          data-value="{{item.value}}"
          data-label="{{item.label}}"
        >
          <text>{{item.label}}</text>
          <text class="check-icon" wx:if="{{formData.category === item.value}}">âœ“</text>
        </view>
      </view>
    </view>
  </view>
</view>