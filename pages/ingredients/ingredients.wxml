<!--pages/ingredients/ingredients.wxml-->
<view class="container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="header">
    <view class="title">æˆåˆ†æ•°æ®åº“</view>
    <view class="header-actions">
      <view class="search-btn" bindtap="toggleSearchBar">
        <text class="icon">ğŸ”</text>
      </view>
      <view class="filter-btn" bindtap="toggleFilterPanel">
        <text class="icon">âš™ï¸</text>
      </view>
    </view>
  </view>

  <!-- æœç´¢æ  -->
  <view class="search-bar {{showSearchBar ? 'show' : ''}}">
    <view class="search-input-wrapper">
      <input 
        class="search-input" 
        placeholder="æœç´¢æˆåˆ†åç§°æˆ–åŠŸæ•ˆ" 
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearchConfirm"
      />
      <view class="search-actions">
        <button class="search-btn" bindtap="onSearchConfirm">æœç´¢</button>
        <button class="cancel-btn" bindtap="toggleSearchBar">å–æ¶ˆ</button>
      </view>
    </view>
  </view>

  <!-- æœç´¢å»ºè®® -->
  <view class="search-suggestions" wx:if="{{showSearchBar}}">
    <!-- çƒ­é—¨æœç´¢ -->
    <view class="suggestion-section">
      <view class="section-header">
        <text class="section-title">çƒ­é—¨æœç´¢</text>
      </view>
      <view class="hot-searches">
        <text 
          class="hot-search-item" 
          wx:for="{{hotSearches}}" 
          wx:key="*this"
          data-keyword="{{item}}"
          bindtap="onHotSearchTap"
        >
          {{item}}
        </text>
      </view>
    </view>

    <!-- æœç´¢å†å² -->
    <view class="suggestion-section" wx:if="{{searchHistory.length > 0}}">
      <view class="section-header">
        <text class="section-title">æœç´¢å†å²</text>
        <text class="clear-btn" bindtap="clearSearchHistory">æ¸…ç©º</text>
      </view>
      <view class="search-history">
        <view 
          class="history-item" 
          wx:for="{{searchHistory}}" 
          wx:key="*this"
          data-keyword="{{item}}"
          bindtap="onHistoryItemTap"
        >
          <text class="history-icon">ğŸ•</text>
          <text class="history-text">{{item}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-number">{{stats.totalIngredients}}</text>
        <text class="stat-label">æ€»æˆåˆ†</text>
      </view>
      <view class="stat-item safe">
        <text class="stat-number">{{stats.safeCount}}</text>
        <text class="stat-label">å®‰å…¨</text>
      </view>
      <view class="stat-item caution">
        <text class="stat-number">{{stats.cautionCount}}</text>
        <text class="stat-label">æ³¨æ„</text>
      </view>
      <view class="stat-item danger">
        <text class="stat-number">{{stats.dangerCount}}</text>
        <text class="stat-label">å±é™©</text>
      </view>
    </view>
  </view>

  <!-- å·¥å…·æ  -->
  <view class="toolbar">
    <view class="sort-picker">
      <picker 
        range="{{sortOptions}}" 
        range-key="label" 
        bindchange="onSortChange"
      >
        <view class="picker-display">
          <text>{{sortOptions[0].label}}</text>
          <text class="arrow">â–¼</text>
        </view>
      </picker>
    </view>
    <view class="result-count">
      å…± {{filteredIngredients.length}} ä¸ªæˆåˆ†
    </view>
  </view>

  <!-- æˆåˆ†åˆ—è¡¨ -->
  <scroll-view class="content" scroll-y="true" bindscrolltolower="onReachBottom">
    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading" wx:if="{{loading && ingredientList.length === 0}}">
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty" wx:elif="{{!loading && filteredIngredients.length === 0}}">
      <text class="empty-icon">ğŸ”</text>
      <text class="empty-text">æš‚æ— ç›¸å…³æˆåˆ†</text>
    </view>

    <!-- æˆåˆ†åˆ—è¡¨ -->
    <view class="ingredient-items" wx:else>
      <view 
        class="ingredient-item" 
        wx:for="{{filteredIngredients}}" 
        wx:key="id"
        data-ingredient="{{item}}"
        bindtap="onIngredientTap"
      >
        <!-- æˆåˆ†å¤´éƒ¨ä¿¡æ¯ -->
        <view class="ingredient-header">
          <view class="ingredient-names">
            <text class="ingredient-name">{{item.name}}</text>
            <text class="ingredient-english">{{item.englishName}}</text>
          </view>
          <view class="ingredient-actions">
            <view 
              class="favorite-btn {{isFavorite(item.id) ? 'active' : ''}}"
              data-ingredient="{{item}}"
              bindtap="toggleFavorite"
              catchtap="true"
            >
              <text class="favorite-icon">{{isFavorite(item.id) ? 'â¤ï¸' : 'ğŸ¤'}}</text>
            </view>
          </view>
        </view>

        <!-- å®‰å…¨æ€§è¯„çº§ -->
        <view class="ingredient-safety">
          <view class="safety-level {{item.safetyLevel}}">
            <text class="safety-icon">
              {{item.safetyLevel === 'safe' ? 'âœ…' : item.safetyLevel === 'caution' ? 'âš ï¸' : 'âŒ'}}
            </text>
            <text class="safety-text">
              {{item.safetyLevel === 'safe' ? 'å®‰å…¨' : item.safetyLevel === 'caution' ? 'æ³¨æ„' : 'å±é™©'}}
            </text>
            <text class="safety-score">{{item.safetyScore}}/10</text>
          </view>
        </view>

        <!-- åŠŸæ•ˆæ ‡ç­¾ -->
        <view class="ingredient-effects">
          <text 
            class="effect-tag" 
            wx:for="{{item.effects}}" 
            wx:key="*this"
            wx:for-item="effect"
          >
            {{effect}}
          </text>
        </view>

        <!-- æˆåˆ†æè¿° -->
        <view class="ingredient-description">
          {{item.description}}
        </view>

        <!-- æˆåˆ†å…ƒä¿¡æ¯ -->
        <view class="ingredient-meta">
          <view class="meta-item">
            <text class="meta-label">æµ“åº¦èŒƒå›´:</text>
            <text class="meta-value">{{item.concentration}}</text>
          </view>
          <view class="meta-item">
            <text class="meta-label">é€‚ç”¨pH:</text>
            <text class="meta-value">{{item.pH}}</text>
          </view>
          <view class="meta-item">
            <text class="meta-label">çƒ­åº¦:</text>
            <text class="meta-value">{{item.popularity}}%</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{loading && ingredientList.length > 0}}">
      <text class="load-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤šæ•°æ® -->
    <view class="no-more" wx:if="{{!hasMore && ingredientList.length > 0}}">
      <text class="no-more-text">æ²¡æœ‰æ›´å¤šæ•°æ®äº†</text>
    </view>
  </scroll-view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view class="filter-panel {{showFilterPanel ? 'show' : ''}}">
    <view class="filter-mask" bindtap="onFilterMaskTap"></view>
    <view class="filter-content">
      <!-- ç­›é€‰å¤´éƒ¨ -->
      <view class="filter-header">
        <text class="filter-title">ç­›é€‰æ¡ä»¶</text>
        <text class="filter-reset" bindtap="resetFilters">é‡ç½®</text>
      </view>

      <!-- ç­›é€‰å†…å®¹ -->
      <scroll-view class="filter-body" scroll-y="true">
        <!-- å®‰å…¨ç­‰çº§ -->
        <view class="filter-section">
          <text class="filter-section-title">å®‰å…¨ç­‰çº§</text>
          <view class="filter-options">
            <view 
              class="filter-option {{filterOptions.safetyLevel === item.value ? 'active' : ''}}"
              wx:for="{{safetyLevels}}" 
              wx:key="value"
              data-value="{{item.value}}"
              bindtap="onSafetyLevelTap"
            >
              <text class="option-icon">{{item.icon}}</text>
              <text>{{item.label}}</text>
            </view>
          </view>
        </view>

        <!-- åŠŸæ•ˆç±»å‹ -->
        <view class="filter-section">
          <text class="filter-section-title">åŠŸæ•ˆç±»å‹</text>
          <view class="filter-options">
            <view 
              class="filter-option {{filterOptions.effectType === item.value ? 'active' : ''}}"
              wx:for="{{effectTypes}}" 
              wx:key="value"
              data-value="{{item.value}}"
              bindtap="onEffectTypeTap"
            >
              <text class="option-icon">{{item.icon}}</text>
              <text>{{item.label}}</text>
            </view>
          </view>
        </view>

        <!-- æˆåˆ†ç±»åˆ« -->
        <view class="filter-section">
          <text class="filter-section-title">æˆåˆ†ç±»åˆ«</text>
          <view class="filter-options">
            <view 
              class="filter-option {{filterOptions.category === item.value ? 'active' : ''}}"
              wx:for="{{categories}}" 
              wx:key="value"
              data-value="{{item.value}}"
              bindtap="onCategoryTap"
            >
              <text class="option-icon">{{item.icon}}</text>
              <text>{{item.label}}</text>
            </view>
          </view>
        </view>
      </scroll-view>

      <!-- ç­›é€‰åº•éƒ¨ -->
      <view class="filter-footer">
        <button class="filter-cancel" bindtap="onFilterMaskTap">å–æ¶ˆ</button>
        <button class="filter-confirm" bindtap="confirmFilters">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- æˆåˆ†è¯¦æƒ…å¼¹çª— -->
  <view class="ingredient-detail-modal {{showIngredientDetail ? 'show' : ''}}">
    <view class="modal-mask" bindtap="onDetailMaskTap"></view>
    <view class="modal-content">
      <!-- å¼¹çª—å¤´éƒ¨ -->
      <view class="modal-header">
        <text class="modal-title">æˆåˆ†è¯¦æƒ…</text>
        <text class="modal-close" bindtap="closeIngredientDetail">âœ•</text>
      </view>

      <!-- å¼¹çª—å†…å®¹ -->
      <scroll-view class="modal-body" scroll-y="true" wx:if="{{selectedIngredient}}">
        <view class="ingredient-detail">
          <!-- æˆåˆ†åŸºæœ¬ä¿¡æ¯ -->
          <view class="ingredient-header">
            <text class="ingredient-name">{{selectedIngredient.name}}</text>
            <text class="ingredient-english">{{selectedIngredient.englishName}}</text>
          </view>

          <!-- å®‰å…¨æ€§è¯„åˆ† -->
          <view class="ingredient-safety">
            <view class="safety-score">
              <text class="score-label">å®‰å…¨è¯„åˆ†</text>
              <text class="score-value">{{selectedIngredient.safetyScore}}/10</text>
            </view>
            <view class="safety-level {{selectedIngredient.safetyLevel}}">
              <text class="safety-icon">
                {{selectedIngredient.safetyLevel === 'safe' ? 'âœ…' : selectedIngredient.safetyLevel === 'caution' ? 'âš ï¸' : 'âŒ'}}
              </text>
              <text class="safety-text">
                {{selectedIngredient.safetyLevel === 'safe' ? 'å®‰å…¨' : selectedIngredient.safetyLevel === 'caution' ? 'æ³¨æ„ä½¿ç”¨' : 'è°¨æ…ä½¿ç”¨'}}
              </text>
            </view>
          </view>

          <!-- åŠŸæ•ˆåˆ—è¡¨ -->
          <view class="detail-section">
            <text class="section-title">ä¸»è¦åŠŸæ•ˆ</text>
            <view class="effect-list">
              <text 
                class="effect-tag" 
                wx:for="{{selectedIngredient.effects}}" 
                wx:key="*this"
                wx:for-item="effect"
              >
                {{effect}}
              </text>
            </view>
          </view>

          <!-- æˆåˆ†æè¿° -->
          <view class="detail-section">
            <text class="section-title">æˆåˆ†ä»‹ç»</text>
            <text class="description-text">{{selectedIngredient.description}}</text>
          </view>

          <!-- ä½¿ç”¨æ–¹æ³• -->
          <view class="detail-section">
            <text class="section-title">ä½¿ç”¨æ–¹æ³•</text>
            <text class="usage-text">{{selectedIngredient.usage}}</text>
          </view>

          <!-- æ³¨æ„äº‹é¡¹ -->
          <view class="detail-section">
            <text class="section-title">æ³¨æ„äº‹é¡¹</text>
            <text class="precautions-text">{{selectedIngredient.precautions}}</text>
          </view>

          <!-- æŠ€æœ¯å‚æ•° -->
          <view class="detail-section">
            <text class="section-title">æŠ€æœ¯å‚æ•°</text>
            <view class="tech-params">
              <view class="param-item">
                <text class="param-label">æ¨èæµ“åº¦:</text>
                <text class="param-value">{{selectedIngredient.concentration}}</text>
              </view>
              <view class="param-item">
                <text class="param-label">é€‚ç”¨pHå€¼:</text>
                <text class="param-value">{{selectedIngredient.pH}}</text>
              </view>
              <view class="param-item">
                <text class="param-label">æˆåˆ†ç±»åˆ«:</text>
                <text class="param-value">
                  {{selectedIngredient.category === 'active' ? 'æ´»æ€§æˆåˆ†' : 
                    selectedIngredient.category === 'preservative' ? 'é˜²è…å‰‚' : 
                    selectedIngredient.category === 'surfactant' ? 'è¡¨é¢æ´»æ€§å‰‚' : 'ä¹³åŒ–å‰‚'}}
                </text>
              </view>
            </view>
          </view>

          <!-- ç›¸å…³äº§å“ -->
          <view class="detail-section" wx:if="{{selectedIngredient.products}}">
            <text class="section-title">å«æœ‰è¯¥æˆåˆ†çš„çƒ­é—¨äº§å“</text>
            <view class="related-products">
              <text 
                class="product-tag" 
                wx:for="{{selectedIngredient.products}}" 
                wx:key="*this"
                wx:for-item="product"
                data-ingredient="{{selectedIngredient}}"
                bindtap="viewRelatedProducts"
              >
                {{product}}
              </text>
            </view>
          </view>
        </view>
      </scroll-view>

      <!-- å¼¹çª—åº•éƒ¨ -->
      <view class="modal-footer">
        <button 
          class="favorite-btn {{isFavorite(selectedIngredient.id) ? 'active' : ''}}"
          data-ingredient="{{selectedIngredient}}"
          bindtap="toggleFavorite"
        >
          {{isFavorite(selectedIngredient.id) ? 'å·²æ”¶è—' : 'æ”¶è—'}}
        </button>
        <button 
          class="share-btn"
          data-ingredient="{{selectedIngredient}}"
          bindtap="onShareIngredient"
        >
          åˆ†äº«
        </button>
      </view>
    </view>
  </view>
</view>