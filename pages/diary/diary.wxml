<!--pages/diary/diary.wxml-->
<view class="diary-container">
  <!-- å¤´éƒ¨å·¥å…·æ  -->
  <view class="diary-header">
    <view class="header-title">æŠ¤è‚¤æ—¥è®°</view>
    <view class="header-actions">
      <view class="add-btn" bindtap="showAddDiary">
        <text>+</text>
      </view>
    </view>
  </view>

  <!-- è§†å›¾æ¨¡å¼åˆ‡æ¢ -->
  <view class="view-mode-tabs">
    <view class="mode-tab {{viewMode === 'list' ? 'active' : ''}}" 
          data-mode="list" bindtap="switchViewMode">
      <text>åˆ—è¡¨</text>
    </view>
    <view class="mode-tab {{viewMode === 'calendar' ? 'active' : ''}}" 
          data-mode="calendar" bindtap="switchViewMode">
      <text>æ—¥å†</text>
    </view>
    <view class="mode-tab {{viewMode === 'chart' ? 'active' : ''}}" 
          data-mode="chart" bindtap="switchViewMode">
      <text>ç»Ÿè®¡</text>
    </view>
  </view>

  <!-- ç­›é€‰å’Œæ’åº -->
  <view class="filter-bar" wx:if="{{viewMode === 'list'}}">
    <view class="filter-section">
      <text class="filter-label">ç­›é€‰ï¼š</text>
      <view class="filter-options">
        <view class="filter-option {{filterType === 'all' ? 'active' : ''}}"
              data-type="all" bindtap="switchFilter">å…¨éƒ¨</view>
        <view class="filter-option {{filterType === 'skincare' ? 'active' : ''}}"
              data-type="skincare" bindtap="switchFilter">æŠ¤è‚¤</view>
        <view class="filter-option {{filterType === 'mood' ? 'active' : ''}}"
              data-type="mood" bindtap="switchFilter">å¿ƒæƒ…</view>
      </view>
    </view>
    <view class="sort-section">
      <text class="sort-label">æ’åºï¼š</text>
      <view class="sort-options">
        <view class="sort-option {{sortBy === 'date' ? 'active' : ''}}"
              data-sort="date" bindtap="switchSort">æ—¥æœŸ</view>
        <view class="sort-option {{sortBy === 'mood' ? 'active' : ''}}"
              data-sort="mood" bindtap="switchSort">å¿ƒæƒ…</view>
      </view>
    </view>
  </view>

  <!-- åˆ—è¡¨è§†å›¾ -->
  <view class="diary-list" wx:if="{{viewMode === 'list'}}">
    <view class="diary-item" wx:for="{{diaryList}}" wx:key="id">
      <view class="diary-content" data-id="{{item.id}}" bindtap="viewDiaryDetail">
        <view class="diary-date">
          <text class="date-text">{{item.date}}</text>
          <text class="weekday">{{item.weekday}}</text>
        </view>
        <view class="diary-info">
          <view class="condition-row">
            <view class="condition-item">
              <text class="condition-label">è‚Œè‚¤ï¼š</text>
              <view class="condition-stars">
                <text class="star {{index < item.skinCondition ? 'filled' : ''}}"
                      wx:for="{{[1,2,3,4,5,6,7,8,9,10]}}" wx:key="*this">â˜…</text>
              </view>
            </view>
            <view class="condition-item">
              <text class="condition-label">å¿ƒæƒ…ï¼š</text>
              <view class="condition-stars">
                <text class="star {{index < item.mood ? 'filled' : ''}}"
                      wx:for="{{[1,2,3,4,5,6,7,8,9,10]}}" wx:key="*this">â˜…</text>
              </view>
            </view>
          </view>
          <view class="weather-products">
            <view class="weather-info">
              <text class="weather-icon">{{getWeatherInfo(item.weather, 'icon')}}</text>
              <text class="weather-name">{{getWeatherInfo(item.weather, 'name')}}</text>
            </view>
            <view class="products-count" wx:if="{{item.products.length > 0}}">
              <text>ä½¿ç”¨äº†{{item.products.length}}ä¸ªäº§å“</text>
            </view>
          </view>
          <view class="diary-notes" wx:if="{{item.notes}}">
            <text class="notes-text">{{item.notes}}</text>
          </view>
        </view>
        <view class="diary-photos" wx:if="{{item.photos.length > 0}}">
          <image class="photo-thumb" src="{{item.photos[0]}}" mode="aspectFill"></image>
          <view class="photos-count" wx:if="{{item.photos.length > 1}}">
            <text>+{{item.photos.length - 1}}</text>
          </view>
        </view>
      </view>
      <view class="diary-actions">
        <view class="action-btn edit-btn" data-id="{{item.id}}" bindtap="editDiary">
          <text>ç¼–è¾‘</text>
        </view>
        <view class="action-btn delete-btn" data-id="{{item.id}}" bindtap="deleteDiary">
          <text>åˆ é™¤</text>
        </view>
        <view class="action-btn share-btn" data-id="{{item.id}}" bindtap="shareDiary">
          <text>åˆ†äº«</text>
        </view>
      </view>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{diaryList.length === 0}}">
      <view class="empty-icon">ğŸ“</view>
      <text class="empty-text">è¿˜æ²¡æœ‰æ—¥è®°è®°å½•</text>
      <view class="empty-action" bindtap="showAddDiary">
        <text>å†™ç¬¬ä¸€ç¯‡æ—¥è®°</text>
      </view>
    </view>
  </view>

  <!-- æ—¥å†è§†å›¾ -->
  <view class="calendar-view" wx:if="{{viewMode === 'calendar'}}">
    <view class="calendar-header">
      <text class="calendar-title">{{currentDate.substring(0, 7)}}</text>
    </view>
    <view class="calendar-grid">
      <view class="calendar-weekdays">
        <text class="weekday-item">æ—¥</text>
        <text class="weekday-item">ä¸€</text>
        <text class="weekday-item">äºŒ</text>
        <text class="weekday-item">ä¸‰</text>
        <text class="weekday-item">å››</text>
        <text class="weekday-item">äº”</text>
        <text class="weekday-item">å…­</text>
      </view>
      <!-- è¿™é‡Œå¯ä»¥æ·»åŠ æ—¥å†æ—¥æœŸç½‘æ ¼ -->
      <view class="calendar-placeholder">
        <text>æ—¥å†è§†å›¾ï¼ˆå¾…å®Œå–„ï¼‰</text>
      </view>
    </view>
  </view>

  <!-- ç»Ÿè®¡è§†å›¾ -->
  <view class="stats-view" wx:if="{{viewMode === 'chart'}}">
    <view class="stats-summary" wx:if="{{statsData}}">
      <view class="stats-card">
        <text class="stats-title">æœ¬æœˆç»Ÿè®¡</text>
        <view class="stats-grid">
          <view class="stat-item">
            <text class="stat-number">{{statsData.monthlyEntries || 0}}</text>
            <text class="stat-label">æ—¥è®°æ¡æ•°</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{statsData.avgSkinCondition || 0}}</text>
            <text class="stat-label">å¹³å‡è‚Œè‚¤çŠ¶æ€</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{statsData.avgMood || 0}}</text>
            <text class="stat-label">å¹³å‡å¿ƒæƒ…</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{statsData.totalProducts || 0}}</text>
            <text class="stat-label">ä½¿ç”¨äº§å“æ•°</text>
          </view>
        </view>
      </view>
      
      <view class="trend-chart">
        <text class="chart-title">è‚Œè‚¤çŠ¶æ€è¶‹åŠ¿</text>
        <view class="chart-placeholder">
          <text>è¶‹åŠ¿å›¾è¡¨ï¼ˆå¾…å®ç°ï¼‰</text>
        </view>
      </view>
    </view>
    
    <view class="empty-state" wx:else>
      <view class="empty-icon">ğŸ“Š</view>
      <text class="empty-text">æ•°æ®ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆç»Ÿè®¡</text>
      <text class="empty-desc">è‡³å°‘éœ€è¦5æ¡æ—¥è®°è®°å½•</text>
    </view>
  </view>

  <!-- æ·»åŠ /ç¼–è¾‘æ—¥è®°å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showAddModal}}" bindtap="closeAddModal">
    <view class="add-diary-modal" catchtap="">
      <view class="modal-header">
        <text class="modal-title">{{editingId ? 'ç¼–è¾‘æ—¥è®°' : 'æ·»åŠ æ—¥è®°'}}</text>
        <view class="close-btn" bindtap="closeAddModal">Ã—</view>
      </view>
      
      <scroll-view class="modal-content" scroll-y>
        <!-- æ—¥æœŸé€‰æ‹© -->
        <view class="form-item">
          <text class="form-label">æ—¥æœŸ</text>
          <picker mode="date" value="{{newDiary.date}}" bindchange="onDateChange">
            <view class="date-picker">
              <text>{{newDiary.date}}</text>
            </view>
          </picker>
        </view>

        <!-- è‚Œè‚¤çŠ¶æ€ -->
        <view class="form-item">
          <text class="form-label">è‚Œè‚¤çŠ¶æ€ ({{newDiary.skinCondition}}/10)</text>
          <slider value="{{newDiary.skinCondition}}" min="1" max="10" 
                  show-value bindchange="onSkinConditionChange" 
                  activeColor="#4CAF50" backgroundColor="#e0e0e0"/>
        </view>

        <!-- å¿ƒæƒ…çŠ¶æ€ -->
        <view class="form-item">
          <text class="form-label">å¿ƒæƒ…çŠ¶æ€ ({{newDiary.mood}}/10)</text>
          <slider value="{{newDiary.mood}}" min="1" max="10" 
                  show-value bindchange="onMoodChange" 
                  activeColor="#FF9800" backgroundColor="#e0e0e0"/>
        </view>

        <!-- å¤©æ°”é€‰æ‹© -->
        <view class="form-item">
          <text class="form-label">å¤©æ°”</text>
          <view class="weather-options">
            <view class="weather-option {{newDiary.weather === item.id ? 'selected' : ''}}"
                  wx:for="{{weatherOptions}}" wx:key="id"
                  data-weather="{{item.id}}" bindtap="selectWeather">
              <text class="weather-icon">{{item.icon}}</text>
              <text class="weather-name">{{item.name}}</text>
            </view>
          </view>
        </view>

        <!-- ä½¿ç”¨äº§å“ -->
        <view class="form-item">
          <text class="form-label">ä½¿ç”¨äº§å“</text>
          <view class="products-selector {{newDiary.products.length > 0 ? 'has-products' : ''}}" bindtap="showProductSelector">
            <view class="selector-content">
              <text class="selector-text {{newDiary.products.length > 0 ? 'has-products' : ''}}">
                {{newDiary.products.length > 0 ? 'å·²é€‰æ‹©' + newDiary.products.length + 'ä¸ªäº§å“' : 'ç‚¹å‡»é€‰æ‹©äº§å“'}}
              </text>
              <view class="selected-products-preview" wx:if="{{newDiary.products.length > 0}}">
                <view class="product-tag" wx:for="{{newDiary.products.slice(0, 3)}}" wx:key="*this">
                  {{item.name}}
                </view>
                <text class="more-indicator" wx:if="{{newDiary.products.length > 3}}">+{{newDiary.products.length - 3}}</text>
              </view>
            </view>
            <text class="selector-arrow">></text>
          </view>
        </view>

        <!-- ç…§ç‰‡ -->
        <view class="form-item">
          <text class="form-label">ç…§ç‰‡ (æœ€å¤š3å¼ )</text>
          <view class="photos-section">
            <view class="photo-item" wx:for="{{newDiary.photos}}" wx:key="*this">
              <image src="{{item}}" mode="aspectFill"></image>
              <view class="delete-photo" data-index="{{index}}" bindtap="deletePhoto">Ã—</view>
            </view>
            <view class="add-photo" wx:if="{{newDiary.photos.length < 3}}" bindtap="choosePhotos">
              <text>+</text>
            </view>
          </view>
        </view>

        <!-- å¤‡æ³¨ -->
        <view class="form-item">
          <text class="form-label">å¤‡æ³¨</text>
          <textarea class="notes-input" placeholder="è®°å½•ä»Šå¤©çš„æŠ¤è‚¤å¿ƒå¾—..."
                    value="{{newDiary.notes}}" bindinput="onNotesInput"
                    maxlength="200" auto-height/>
        </view>
      </scroll-view>

      <view class="modal-footer">
        <view class="cancel-btn" bindtap="closeAddModal">å–æ¶ˆ</view>
        <view class="save-btn" bindtap="saveDiary">ä¿å­˜</view>
      </view>
    </view>
  </view>

  <!-- äº§å“é€‰æ‹©å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showProductModal}}" bindtap="closeProductModal">
    <view class="product-modal" catchtap="">
      <view class="modal-header">
        <text class="modal-title">é€‰æ‹©æŠ¤è‚¤äº§å“</text>
        <view class="close-btn" bindtap="closeProductModal">Ã—</view>
      </view>
      
      <!-- æœç´¢æ¡† -->
      <view class="product-search">
        <input class="search-input" placeholder="æœç´¢äº§å“åç§°æˆ–å“ç‰Œ..." 
               value="{{productSearchText}}" bindinput="onProductSearch"/>
      </view>
      
      <scroll-view class="product-list" scroll-y>
        <view class="product-item {{selectedProducts.includes(item.id) ? 'selected' : ''}}"
              wx:for="{{filteredProducts}}" wx:key="id"
              data-id="{{item.id}}" bindtap="toggleProduct">
          <image class="product-image" src="{{item.image}}" mode="aspectFill"></image>
          <view class="product-info">
            <text class="product-name">{{item.name}}</text>
            <text class="product-brand">{{item.brand}}</text>
          </view>
          <view class="product-check">
            <text wx:if="{{selectedProducts.includes(item.id)}}">âœ“</text>
          </view>
        </view>
        
        <!-- ç©ºçŠ¶æ€ -->
        <view class="empty-state" wx:if="{{filteredProducts.length === 0}}">
          <text class="empty-text">æœªæ‰¾åˆ°ç›¸å…³äº§å“</text>
          <text class="empty-desc">è¯·å°è¯•å…¶ä»–å…³é”®è¯</text>
        </view>
      </scroll-view>

      <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <view class="product-stats" wx:if="{{selectedProducts.length > 0}}">
        <text class="selected-count">å·²é€‰æ‹© {{selectedProducts.length}} ä¸ªäº§å“</text>
        <view class="clear-all-btn" bindtap="clearAllProducts">æ¸…ç©ºé€‰æ‹©</view>
      </view>

      <view class="modal-footer">
        <view class="cancel-btn" bindtap="closeProductModal">å–æ¶ˆ</view>
        <view class="confirm-btn" bindtap="confirmProducts">
          ç¡®å®š ({{selectedProducts.length}})
        </view>
      </view>
    </view>
  </view>
</view>