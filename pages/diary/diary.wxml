<!--pages/diary/diary.wxml-->
<view class="diary-container">
  <!-- å…¨å±€åŠ è½½é®ç½© -->
  <view class="loading-overlay" wx:if="{{isLoading}}">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
  </view>

  <!-- å¤´éƒ¨å·¥å…·æ  -->
  <view class="diary-header">
    <view class="header-title">æŠ¤è‚¤æ—¥è®°</view>
    <view class="header-actions">
      <!-- è‰ç¨¿æç¤º -->
      <view class="draft-indicator" wx:if="{{hasDraft}}" bindtap="restoreDraft">
        <text class="draft-icon">ğŸ“</text>
        <text class="draft-text">è‰ç¨¿</text>
      </view>
      <!-- å¯¼å‡ºæŒ‰é’® -->
      <view class="export-btn" bindtap="showExportOptions">
        <text class="export-icon">ğŸ“¤</text>
      </view>
      <view class="add-btn" bindtap="showAddDiary">
        <text>+</text>
      </view>
    </view>
  </view>

  <!-- è§†å›¾æ¨¡å¼åˆ‡æ¢ -->
  <view class="view-mode-tabs">
    <view class="mode-tab {{viewMode === 'list' ? 'active' : ''}}" 
          data-mode="list" bindtap="switchViewMode">
      <text>åˆ—è¡¨</text>
    </view>
    <view class="mode-tab {{viewMode === 'calendar' ? 'active' : ''}}" 
          data-mode="calendar" bindtap="switchViewMode">
      <text>æ—¥å†</text>
    </view>
    <view class="mode-tab {{viewMode === 'chart' ? 'active' : ''}}" 
          data-mode="chart" bindtap="switchViewMode">
      <text>ç»Ÿè®¡</text>
    </view>
  </view>

  <!-- ç­›é€‰å’Œæ’åº -->
  <view class="filter-bar" wx:if="{{viewMode === 'list'}}">
    <view class="filter-section">
      <text class="filter-label">ç­›é€‰ï¼š</text>
      <view class="filter-options">
        <view class="filter-option {{filterType === 'all' ? 'active' : ''}}"
              data-type="all" bindtap="switchFilter">å…¨éƒ¨</view>
        <view class="filter-option {{filterType === 'skincare' ? 'active' : ''}}"
              data-type="skincare" bindtap="switchFilter">æŠ¤è‚¤</view>
        <view class="filter-option {{filterType === 'mood' ? 'active' : ''}}"
              data-type="mood" bindtap="switchFilter">å¿ƒæƒ…</view>
      </view>
    </view>
    <view class="sort-section">
      <text class="sort-label">æ’åºï¼š</text>
      <view class="sort-options">
        <view class="sort-option {{sortBy === 'date' ? 'active' : ''}}"
              data-sort="date" bindtap="switchSort">æ—¥æœŸ</view>
        <view class="sort-option {{sortBy === 'mood' ? 'active' : ''}}"
              data-sort="mood" bindtap="switchSort">å¿ƒæƒ…</view>
      </view>
    </view>
  </view>

  <!-- åˆ—è¡¨è§†å›¾ -->
  <view class="diary-list" wx:if="{{viewMode === 'list'}}">
    <view class="diary-item" wx:for="{{diaryList}}" wx:key="id">
      <view class="diary-content" data-id="{{item._id || item.id}}" bindtap="viewDiaryDetail">
        <view class="diary-date">
          <text class="date-text">{{item.date}}</text>
          <text class="weekday">{{item.weekday}}</text>
        </view>
        <view class="diary-info">
          <view class="condition-row">
            <view class="condition-item">
              <text class="condition-label">è‚Œè‚¤ï¼š</text>
              <view class="condition-stars">
                <text class="star {{index < item.skinCondition ? 'filled' : ''}}"
                      wx:for="{{[1,2,3,4,5,6,7,8,9,10]}}" wx:key="*this">â˜…</text>
              </view>
            </view>
            <view class="condition-item">
              <text class="condition-label">å¿ƒæƒ…ï¼š</text>
              <view class="condition-stars">
                <text class="star {{index < item.mood ? 'filled' : ''}}"
                      wx:for="{{[1,2,3,4,5,6,7,8,9,10]}}" wx:key="*this">â˜…</text>
              </view>
            </view>
          </view>
          <view class="weather-products">
            <view class="weather-info">
              <text class="weather-icon">{{getWeatherInfo(item.weather, 'icon')}}</text>
              <text class="weather-name">{{getWeatherInfo(item.weather, 'name')}}</text>
            </view>
            <view class="products-count" wx:if="{{item.products.length > 0}}">
              <text>ä½¿ç”¨äº†{{item.products.length}}ä¸ªäº§å“</text>
            </view>
          </view>
          <view class="diary-notes" wx:if="{{item.notes}}">
            <text class="notes-text">{{item.notes}}</text>
          </view>
        </view>
        <view class="diary-photos" wx:if="{{item.photos.length > 0}}">
          <image class="photo-thumb" src="{{item.photos[0]}}" mode="aspectFill"></image>
          <view class="photos-count" wx:if="{{item.photos.length > 1}}">
            <text>+{{item.photos.length - 1}}</text>
          </view>
        </view>
      </view>
      <view class="diary-actions">
        <view class="action-btn edit-btn" data-id="{{item._id || item.id}}" bindtap="editDiary">
          <text>ç¼–è¾‘</text>
        </view>
        <view class="action-btn delete-btn" data-id="{{item._id || item.id}}" bindtap="deleteDiary">
          <text>åˆ é™¤</text>
        </view>
        <view class="action-btn share-btn" data-id="{{item._id || item.id}}" bindtap="shareDiary">
          <text>åˆ†äº«</text>
        </view>
      </view>
    </view>
    
    <!-- åŠ è½½æ›´å¤šçŠ¶æ€ -->
    <view class="load-more-container" wx:if="{{diaryList.length > 0}}">
      <view class="load-more-loading" wx:if="{{isLoadingMore}}">
        <view class="loading-spinner small"></view>
        <text class="loading-text">åŠ è½½æ›´å¤š...</text>
      </view>
      <view class="load-more-end" wx:elif="{{!hasMore}}">
        <text class="end-text">æ²¡æœ‰æ›´å¤šæ•°æ®äº†</text>
      </view>
      <view class="load-more-error" wx:elif="{{loadError}}" bindtap="loadMoreDiary">
        <text class="error-text">åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•</text>
      </view>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{diaryList.length === 0 && !isLoading}}">
      <view class="empty-icon">ğŸ“</view>
      <text class="empty-text">è¿˜æ²¡æœ‰æ—¥è®°è®°å½•</text>
      <view class="empty-action" bindtap="showAddDiary">
        <text>å†™ç¬¬ä¸€ç¯‡æ—¥è®°</text>
      </view>
    </view>
  </view>

  <!-- æ—¥å†è§†å›¾ -->
  <view class="calendar-view" wx:if="{{viewMode === 'calendar'}}">
    <view class="calendar-header">
      <view class="calendar-nav">
        <view class="nav-btn" bindtap="prevMonth">
          <text class="nav-icon">â€¹</text>
        </view>
        <view class="calendar-title-container">
          <text class="calendar-title">{{currentYear}}å¹´{{currentMonth}}æœˆ</text>
          <view class="today-btn" bindtap="goToToday">
            <text>ä»Šå¤©</text>
          </view>
        </view>
        <view class="nav-btn" bindtap="nextMonth">
          <text class="nav-icon">â€º</text>
        </view>
      </view>
    </view>
    
    <view class="calendar-container">
      <view class="calendar-weekdays">
        <text class="weekday-item">æ—¥</text>
        <text class="weekday-item">ä¸€</text>
        <text class="weekday-item">äºŒ</text>
        <text class="weekday-item">ä¸‰</text>
        <text class="weekday-item">å››</text>
        <text class="weekday-item">äº”</text>
        <text class="weekday-item">å…­</text>
      </view>
      
      <view class="calendar-days">
        <view class="calendar-day {{item.isCurrentMonth ? 'current-month' : 'other-month'}} {{item.isToday ? 'today' : ''}} {{item.hasDiary ? 'has-diary' : ''}} {{selectedDate === item.date ? 'selected' : ''}}"
              wx:for="{{calendarDays}}" wx:key="date"
              data-date="{{item.date}}"
              bindtap="onCalendarDateTap">
          <text class="day-number">{{item.day}}</text>
          
          <!-- æ—¥è®°æ ‡è®° -->
          <view class="diary-indicators" wx:if="{{item.hasDiary && item.diaryData}}">
            <!-- å¿ƒæƒ…æ ‡è®° -->
            <view class="mood-indicator" 
                  style="background-color: {{getMoodColor(item.diaryData.mood)}}">
            </view>
            
            <!-- è‚Œè‚¤çŠ¶æ€æ ‡è®° -->
            <view class="skin-indicator">
              <text class="skin-score">{{getSkinConditionAverage(item.diaryData.skinCondition)}}</text>
            </view>
          </view>
          
          <!-- ä»Šå¤©æ ‡è®° -->
          <view class="today-mark" wx:if="{{item.isToday}}"></view>
        </view>
      </view>
    </view>
    
    <!-- æ—¥å†å›¾ä¾‹ -->
    <view class="calendar-legend">
      <view class="legend-item">
        <view class="legend-dot mood-dot"></view>
        <text class="legend-text">å¿ƒæƒ…è®°å½•</text>
      </view>
      <view class="legend-item">
        <view class="legend-dot skin-dot"></view>
        <text class="legend-text">è‚Œè‚¤è¯„åˆ†</text>
      </view>
      <view class="legend-item">
        <view class="legend-dot today-dot"></view>
        <text class="legend-text">ä»Šå¤©</text>
      </view>
    </view>
  </view>

  <!-- ç»Ÿè®¡è§†å›¾ -->
  <view class="stats-view" wx:if="{{viewMode === 'chart'}}">
    <view class="stats-summary" wx:if="{{statsData}}">
      <!-- åŸºç¡€ç»Ÿè®¡å¡ç‰‡ -->
      <view class="stats-card">
        <text class="stats-title">è®°å½•ç»Ÿè®¡</text>
        <view class="stats-grid">
          <view class="stat-item">
            <text class="stat-number">{{statsData.basic.totalCount || 0}}</text>
            <text class="stat-label">æ€»è®°å½•æ•°</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{statsData.basic.thisMonthCount || 0}}</text>
            <text class="stat-label">æœ¬æœˆè®°å½•</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{statsData.basic.consecutiveDays || 0}}</text>
            <text class="stat-label">è¿ç»­å¤©æ•°</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{statsData.summary.completionRate || 0}}%</text>
            <text class="stat-label">å®Œæˆç‡</text>
          </view>
        </view>
      </view>
      
      <!-- è‚Œè‚¤çŠ¶æ€ç»Ÿè®¡ -->
      <view class="stats-card">
        <text class="stats-title">è‚Œè‚¤çŠ¶æ€å¹³å‡å€¼</text>
        <view class="skin-stats-grid">
          <view class="skin-stat-item">
            <text class="skin-stat-label">æ°´åˆ†</text>
            <view class="skin-stat-bar">
              <view class="skin-stat-fill" style="width: {{(statsData.skinCondition.moisture / 10) * 100}}%"></view>
            </view>
            <text class="skin-stat-value">{{statsData.skinCondition.moisture}}</text>
          </view>
          <view class="skin-stat-item">
            <text class="skin-stat-label">å‡ºæ²¹</text>
            <view class="skin-stat-bar">
              <view class="skin-stat-fill" style="width: {{(statsData.skinCondition.oiliness / 10) * 100}}%"></view>
            </view>
            <text class="skin-stat-value">{{statsData.skinCondition.oiliness}}</text>
          </view>
          <view class="skin-stat-item">
            <text class="skin-stat-label">æ•æ„Ÿ</text>
            <view class="skin-stat-bar">
              <view class="skin-stat-fill" style="width: {{(statsData.skinCondition.sensitivity / 10) * 100}}%"></view>
            </view>
            <text class="skin-stat-value">{{statsData.skinCondition.sensitivity}}</text>
          </view>
          <view class="skin-stat-item">
            <text class="skin-stat-label">ç—˜ç—˜</text>
            <view class="skin-stat-bar">
              <view class="skin-stat-fill" style="width: {{(statsData.skinCondition.breakouts / 10) * 100}}%"></view>
            </view>
            <text class="skin-stat-value">{{statsData.skinCondition.breakouts}}</text>
          </view>
          <view class="skin-stat-item">
            <text class="skin-stat-label">æ•´ä½“</text>
            <view class="skin-stat-bar">
              <view class="skin-stat-fill" style="width: {{(statsData.skinCondition.overall / 10) * 100}}%"></view>
            </view>
            <text class="skin-stat-value">{{statsData.skinCondition.overall}}</text>
          </view>
        </view>
      </view>
      
      <!-- å¿ƒæƒ…ç»Ÿè®¡ -->
      <view class="stats-card">
        <text class="stats-title">å¿ƒæƒ…åˆ†å¸ƒ</text>
        <view class="mood-stats-grid">
          <view class="mood-stat-item" wx:for="{{moodOptions}}" wx:key="id">
            <view class="mood-stat-icon" style="background-color: {{item.color}}">
              <text>{{item.icon}}</text>
            </view>
            <text class="mood-stat-label">{{item.name}}</text>
            <text class="mood-stat-count">{{statsData.mood[item.id] || 0}}</text>
          </view>
        </view>
      </view>
      
      <!-- æœ€è¿‘7å¤©è®°å½• -->
      <view class="stats-card">
        <text class="stats-title">æœ€è¿‘7å¤©</text>
        <view class="recent-days">
          <view class="day-item {{item.hasDiary ? 'has-record' : 'no-record'}}" 
                wx:for="{{statsData.last7Days}}" wx:key="date">
            <text class="day-date">{{item.date.substring(5)}}</text>
            <view class="day-indicator"></view>
          </view>
        </view>
      </view>
      
      <!-- å¸¸ç”¨äº§å“ -->
      <view class="stats-card" wx:if="{{statsData.topProducts.length > 0}}">
        <text class="stats-title">å¸¸ç”¨äº§å“ TOP5</text>
        <view class="product-stats">
          <view class="product-item" wx:for="{{statsData.topProducts}}" wx:key="productId">
            <text class="product-name">{{item.productName || item.productId}}</text>
            <view class="product-usage">
              <view class="usage-bar">
                <view class="usage-fill" style="width: {{(item.usageCount / statsData.topProducts[0].usageCount) * 100}}%"></view>
              </view>
              <text class="usage-count">{{item.usageCount}}æ¬¡</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <view class="empty-state" wx:else>
      <view class="empty-icon">ğŸ“Š</view>
      <text class="empty-text">æ•°æ®ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆç»Ÿè®¡</text>
      <text class="empty-desc">è‡³å°‘éœ€è¦1æ¡æ—¥è®°è®°å½•</text>
    </view>
  </view>

  <!-- æ·»åŠ /ç¼–è¾‘æ—¥è®°å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showAddModal}}" bindtap="closeAddModal">
    <view class="add-diary-modal" catchtap="noop">
      <view class="modal-header">
        <text class="modal-title">{{editingId ? 'ç¼–è¾‘æ—¥è®°' : 'æ·»åŠ æ—¥è®°'}}</text>
        <view class="close-btn" bindtap="closeAddModal">Ã—</view>
      </view>
      
      <scroll-view class="modal-content" scroll-y catchtap="noop">
        <!-- æ—¥æœŸé€‰æ‹© -->
        <view class="form-item">
          <text class="form-label">æ—¥æœŸ</text>
          <picker mode="date" value="{{newDiary.date}}" bindchange="onDateChange">
            <view class="date-picker">
              <text>{{newDiary.date}}</text>
            </view>
          </picker>
        </view>

        <!-- è‚Œè‚¤çŠ¶æ€ -->
        <view class="form-item" catchtap="">
          <text class="form-label">è‚Œè‚¤çŠ¶æ€</text>
          <view class="skin-condition-options" catchtap="">
            <view class="skin-condition-option" 
                  data-field="moisture" bindtap="onSkinConditionTap">
              <text class="condition-icon">ğŸ’§</text>
              <text class="condition-name">æ°´åˆ†</text>
              <text class="condition-level">{{newDiary.skinCondition.moisture}}/5</text>
            </view>
            <view class="skin-condition-option" 
                  data-field="oiliness" bindtap="onSkinConditionTap">
              <text class="condition-icon">ğŸ›¢ï¸</text>
              <text class="condition-name">å‡ºæ²¹</text>
              <text class="condition-level">{{newDiary.skinCondition.oiliness}}/5</text>
            </view>
            <view class="skin-condition-option" 
                  data-field="sensitivity" bindtap="onSkinConditionTap">
              <text class="condition-icon">âš ï¸</text>
              <text class="condition-name">æ•æ„Ÿ</text>
              <text class="condition-level">{{newDiary.skinCondition.sensitivity}}/5</text>
            </view>
            <view class="skin-condition-option" 
                  data-field="breakouts" bindtap="onSkinConditionTap">
              <text class="condition-icon">ğŸ”´</text>
              <text class="condition-name">ç—˜ç—˜</text>
              <text class="condition-level">{{newDiary.skinCondition.breakouts}}/5</text>
            </view>
            <view class="skin-condition-option" 
                  data-field="overall" bindtap="onSkinConditionTap">
              <text class="condition-icon">âœ¨</text>
              <text class="condition-name">æ•´ä½“</text>
              <text class="condition-level">{{newDiary.skinCondition.overall}}/5</text>
            </view>
          </view>
        </view>

        <!-- å¿ƒæƒ…çŠ¶æ€ -->
        <view class="form-item" catchtap="">
          <text class="form-label">å¿ƒæƒ…çŠ¶æ€</text>
          <view class="mood-options" catchtap="">
            <view class="mood-option {{newDiary.mood === item.id ? 'selected' : ''}}"
                  wx:for="{{moodOptions}}" wx:key="id"
                  data-mood="{{item.id}}" bindtap="selectMood">
              <text class="mood-icon">{{item.icon}}</text>
              <text class="mood-name">{{item.name}}</text>
            </view>
          </view>
        </view>

        <!-- å¤©æ°”ä¿¡æ¯ -->
        <view class="form-item" catchtap="">
          <text class="form-label">å¤©æ°”ä¿¡æ¯</text>
          <view class="weather-section" catchtap="">
            <view class="weather-condition" catchtap="">
              <text class="weather-sub-label">å¤©æ°”çŠ¶å†µ</text>
              <view class="weather-options" catchtap="">
                <view class="weather-option {{newDiary.weather.condition === item.id ? 'selected' : ''}}"
                      wx:for="{{weatherOptions}}" wx:key="id"
                      data-condition="{{item.id}}" bindtap="selectWeatherCondition">
                  <text class="weather-icon">{{item.icon}}</text>
                  <text class="weather-name">{{item.name}}</text>
                </view>
              </view>
            </view>
            <view class="weather-details">
              <view class="weather-detail-item">
                <text class="weather-sub-label">æ¸©åº¦ ({{newDiary.weather.temperature}}Â°C)</text>
                <slider value="{{newDiary.weather.temperature}}" min="-10" max="40" 
                        show-value bindchange="onTemperatureChange" 
                        activeColor="#FF5722" backgroundColor="#e0e0e0"/>
              </view>
              <view class="weather-detail-item">
                <text class="weather-sub-label">æ¹¿åº¦ ({{newDiary.weather.humidity}}%)</text>
                <slider value="{{newDiary.weather.humidity}}" min="0" max="100" 
                        show-value bindchange="onHumidityChange" 
                        activeColor="#2196F3" backgroundColor="#e0e0e0"/>
              </view>
            </view>
          </view>
        </view>

        <!-- æ—©é—´æŠ¤è‚¤ -->
        <view class="form-item" catchtap="">
          <text class="form-label">æ—©é—´æŠ¤è‚¤</text>
          <view class="routine-section" catchtap="">
            <!-- äº§å“é€‰æ‹©æ¡† -->
            <view class="product-selector-container" catchtap="">
              <view class="product-selector" data-type="morning" bindtap="toggleProductSelector">
                <text class="selector-label">é€‰æ‹©æ—©é—´æŠ¤è‚¤äº§å“</text>
                <text class="selector-arrow {{showMorningSelector ? 'expanded' : ''}}">â–¼</text>
              </view>
              
              <!-- äº§å“é€‰æ‹©åˆ—è¡¨ -->
              <view class="product-dropdown {{showMorningSelector ? 'show' : ''}}" wx:if="{{showMorningSelector}}" catchtap="">
                <!-- æœç´¢æ¡† -->
                <view class="dropdown-search" catchtap="">
                  <input class="search-input" placeholder="æœç´¢äº§å“..." 
                         value="{{morningSearchText}}" bindinput="onMorningProductSearch"/>
                </view>
                
                <!-- äº§å“åˆ—è¡¨ -->
                <scroll-view class="product-options" scroll-y="true" catchtap="">
                  <view class="product-option {{item.selected ? 'selected' : ''}}" 
                        wx:for="{{filteredMorningProducts}}" wx:key="id"
                        data-product="{{item}}" data-type="morning" bindtap="toggleProductSelection">
                    <image class="option-image" src="{{item.image || '/images/default-product.png'}}" mode="aspectFill"/>
                    <view class="option-info">
                      <text class="option-name">{{item.name}}</text>
                      <text class="option-brand">{{item.brand}}</text>
                    </view>
                    <view class="option-checkbox {{item.selected ? 'checked' : ''}}">
                      <text wx:if="{{item.selected}}">âœ“</text>
                    </view>
                  </view>
                </scroll-view>
              </view>
            </view>
            
            <!-- å·²é€‰äº§å“åˆ—è¡¨ -->
            <view class="routine-products" wx:if="{{newDiary.morningRoutine.length > 0}}" catchtap="">
              <view class="routine-product" wx:for="{{newDiary.morningRoutine}}" wx:key="productId">
                <view class="product-header">
                  <text class="product-name">{{item.productName}}</text>
                  <view class="remove-btn" data-routine="morning" data-index="{{index}}" bindtap="removeProductFromRoutine">Ã—</view>
                </view>
                <view class="product-details">
                  <input class="usage-input" placeholder="ç”¨é‡" value="{{item.usage}}" 
                         data-routine="morning" data-index="{{index}}" bindinput="onUsageInput"/>
                  <textarea class="notes-input" placeholder="ä½¿ç”¨æ„Ÿå—" value="{{item.notes}}" 
                            data-routine="morning" data-index="{{index}}" bindinput="onProductNotesInput"/>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- æ™šé—´æŠ¤è‚¤ -->
        <view class="form-item" catchtap="">
          <text class="form-label">æ™šé—´æŠ¤è‚¤</text>
          <view class="routine-section" catchtap="">
            <!-- äº§å“é€‰æ‹©æ¡† -->
            <view class="product-selector-container" catchtap="">
              <view class="product-selector" data-type="evening" bindtap="toggleProductSelector">
                <text class="selector-label">é€‰æ‹©æ™šé—´æŠ¤è‚¤äº§å“</text>
                <text class="selector-arrow {{showEveningSelector ? 'expanded' : ''}}">â–¼</text>
              </view>
              
              <!-- äº§å“é€‰æ‹©åˆ—è¡¨ -->
              <view class="product-dropdown {{showEveningSelector ? 'show' : ''}}" wx:if="{{showEveningSelector}}" catchtap="">
                <!-- æœç´¢æ¡† -->
                <view class="dropdown-search" catchtap="">
                  <input class="search-input" placeholder="æœç´¢äº§å“..." 
                         value="{{eveningSearchText}}" bindinput="onEveningProductSearch"/>
                </view>
                
                <!-- äº§å“åˆ—è¡¨ -->
                <scroll-view class="product-options" scroll-y="true" catchtap="">
                  <view class="product-option {{item.selected ? 'selected' : ''}}" 
                        wx:for="{{filteredEveningProducts}}" wx:key="id"
                        data-product="{{item}}" data-type="evening" bindtap="toggleProductSelection">
                    <image class="option-image" src="{{item.image || '/images/default-product.png'}}" mode="aspectFill"/>
                    <view class="option-info">
                      <text class="option-name">{{item.name}}</text>
                      <text class="option-brand">{{item.brand}}</text>
                    </view>
                    <view class="option-checkbox {{item.selected ? 'checked' : ''}}">
                      <text wx:if="{{item.selected}}">âœ“</text>
                    </view>
                  </view>
                </scroll-view>
              </view>
            </view>
            
            <!-- å·²é€‰äº§å“åˆ—è¡¨ -->
            <view class="routine-products" wx:if="{{newDiary.eveningRoutine.length > 0}}" catchtap="">
              <view class="routine-product" wx:for="{{newDiary.eveningRoutine}}" wx:key="productId">
                <view class="product-header">
                  <text class="product-name">{{item.productName}}</text>
                  <view class="remove-btn" data-routine="evening" data-index="{{index}}" bindtap="removeProductFromRoutine">Ã—</view>
                </view>
                <view class="product-details">
                  <input class="usage-input" placeholder="ç”¨é‡" value="{{item.usage}}" 
                         data-routine="evening" data-index="{{index}}" bindinput="onUsageInput"/>
                  <textarea class="notes-input" placeholder="ä½¿ç”¨æ„Ÿå—" value="{{item.notes}}" 
                            data-routine="evening" data-index="{{index}}" bindinput="onProductNotesInput"/>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- ç…§ç‰‡ -->
        <view class="form-item">
          <text class="form-label">ç…§ç‰‡ (æœ€å¤š3å¼ )</text>
          <view class="photos-section">
            <view class="photo-item" wx:for="{{newDiary.photos}}" wx:key="*this">
              <image src="{{item}}" mode="aspectFill"></image>
              <view class="delete-photo" data-index="{{index}}" bindtap="deletePhoto">Ã—</view>
            </view>
            <view class="add-photo" wx:if="{{newDiary.photos.length < 3}}" bindtap="choosePhotos">
              <text>+</text>
            </view>
          </view>
        </view>

        <!-- å¤‡æ³¨ -->
        <view class="form-item" catchtap="">
          <text class="form-label">å¤‡æ³¨</text>
          <textarea class="notes-input" placeholder="è®°å½•ä»Šå¤©çš„æŠ¤è‚¤å¿ƒå¾—..."
                    value="{{newDiary.notes}}" bindinput="onNotesInput"
                    maxlength="200" auto-height/>
        </view>
      </scroll-view>

      <view class="modal-footer">
        <view class="cancel-btn" bindtap="closeAddModal">å–æ¶ˆ</view>
        <view class="save-btn" bindtap="saveDiary">ä¿å­˜</view>
      </view>
    </view>
  </view>

  <!-- äº§å“é€‰æ‹©å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showProductModal}}" bindtap="closeProductModal">
    <view class="modal-content product-modal" catchtap="noop">
      <view class="modal-header">
        <text class="modal-title">é€‰æ‹©{{currentRoutineType === 'morning' ? 'æ—©é—´' : 'æ™šé—´'}}æŠ¤è‚¤äº§å“</text>
        <view class="close-btn" bindtap="closeProductModal">Ã—</view>
      </view>
      
      <view class="modal-body">
        <!-- æœç´¢æ¡† -->
        <view class="search-box">
          <view class="search-input-wrapper">
            <text class="search-icon">ğŸ”</text>
            <input class="search-input" placeholder="æœç´¢äº§å“åç§°ã€å“ç‰Œæˆ–ç±»åˆ«" 
                   value="{{productSearchText}}" bindinput="onProductSearch"/>
            <view class="clear-search" wx:if="{{productSearchText}}" bindtap="clearSearch">
              <text>Ã—</text>
            </view>
          </view>
        </view>

        <!-- æœç´¢å»ºè®® -->
        <view class="search-suggestions" wx:if="{{searchSuggestions.length > 0 && productSearchText}}">
          <view class="suggestion-item" wx:for="{{searchSuggestions}}" wx:key="*this"
                data-text="{{item}}" bindtap="selectSuggestion">
            <text class="suggestion-text">{{item}}</text>
          </view>
        </view>
        
        <!-- äº§å“åˆ†ç±»ç­›é€‰ -->
        <view class="category-filter" wx:if="{{!productSearchText}}">
          <scroll-view class="category-tabs" scroll-x="true">
            <view class="category-tab {{selectedCategory === 'all' ? 'active' : ''}}"
                  data-category="all" bindtap="selectCategory">
              <text>å…¨éƒ¨</text>
            </view>
            <view class="category-tab {{selectedCategory === item ? 'active' : ''}}"
                  wx:for="{{productCategories}}" wx:key="*this"
                  data-category="{{item}}" bindtap="selectCategory">
              <text>{{item}}</text>
            </view>
          </scroll-view>
        </view>
        
        <!-- äº§å“åˆ—è¡¨ -->
        <scroll-view class="products-list" scroll-y="true">
          <!-- åŠ è½½çŠ¶æ€ -->
          <view class="products-loading" wx:if="{{isLoadingProducts}}">
            <view class="loading-spinner small"></view>
            <text class="loading-text">æœç´¢ä¸­...</text>
          </view>
          
          <view class="product-item {{item.selected ? 'selected' : ''}}" 
                wx:for="{{filteredProducts}}" wx:key="_id"
                data-product="{{item}}" bindtap="toggleProduct">
            <image class="product-image" src="{{item.image || '/images/default-product.png'}}" 
                   mode="aspectFill" lazy-load="true"/>
            <view class="product-info">
              <text class="product-name">{{item.name}}</text>
              <text class="product-brand">{{item.brand}}</text>
              <text class="product-category">{{item.category}}</text>
              <view class="product-rating" wx:if="{{item.rating}}">
                <text class="rating-stars">â˜…â˜…â˜…â˜…â˜…</text>
                <text class="rating-score">{{item.rating}}</text>
              </view>
            </view>
            <view class="product-checkbox {{item.selected ? 'checked' : ''}}">
              <text wx:if="{{item.selected}}">âœ“</text>
            </view>
          </view>
          
          <!-- ç©ºçŠ¶æ€ -->
          <view class="empty-state" wx:if="{{filteredProducts.length === 0 && !isLoadingProducts}}">
            <view class="empty-icon">ğŸ”</view>
            <text class="empty-text">{{productSearchText ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³äº§å“' : 'æš‚æ— äº§å“'}}</text>
            <view class="empty-action" wx:if="{{productSearchText}}" bindtap="clearSearch">
              <text>æ¸…é™¤æœç´¢æ¡ä»¶</text>
            </view>
          </view>
        </scroll-view>
        
        <!-- å·²é€‰äº§å“ç»Ÿè®¡ -->
        <view class="selected-summary" wx:if="{{selectedProducts.length > 0}}">
          <text class="summary-text">å·²é€‰æ‹© {{selectedProducts.length}} ä¸ªäº§å“</text>
          <view class="clear-all-btn" bindtap="clearAllProducts">æ¸…ç©º</view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="cancel-btn" bindtap="closeProductModal">å–æ¶ˆ</button>
        <button class="confirm-btn" bindtap="confirmProducts">ç¡®å®š</button>
      </view>
    </view>
  </view>
</view>