<!--pages/report/report.wxml-->
<view class="report-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{isLoading}}">
    <view class="loading-animation">
      <view class="loading-circle"></view>
    </view>
    <view class="loading-text">æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...</view>
  </view>

  <!-- æŠ¥å‘Šå†…å®¹ -->
  <view class="report-content" wx:if="{{!isLoading && reportData}}">
    <!-- æŠ¥å‘Šå¤´éƒ¨ -->
    <view class="report-header">
      <view class="header-bg">
        <view class="header-title">çš®è‚¤æ£€æµ‹æŠ¥å‘Š</view>
        <view class="header-date">{{reportData.detectionDate}}</view>
        <view class="header-type">{{reportData.detectionTypeName}}</view>
      </view>
      
      <!-- ç»¼åˆè¯„åˆ† -->
      <view class="score-section">
        <view class="score-circle">
          <view class="score-number">{{scoreAnimation}}</view>
          <view class="score-label">ç»¼åˆè¯„åˆ†</view>
        </view>
        <view class="score-desc">
          <view class="score-level">{{reportData.scoreLevel}}</view>
          <view class="score-summary">{{reportData.scoreSummary}}</view>
        </view>
      </view>
    </view>

    <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
    <view class="tab-nav">
      <view 
        class="tab-item {{currentTab === 'overview' ? 'active' : ''}}"
        data-tab="overview"
        bindtap="switchTab"
      >
        æ¦‚è§ˆ
      </view>
      <view 
        class="tab-item {{currentTab === 'details' ? 'active' : ''}}"
        data-tab="details"
        bindtap="switchTab"
      >
        è¯¦ç»†åˆ†æ
      </view>
      <view 
        class="tab-item {{currentTab === 'recommendations' ? 'active' : ''}}"
        data-tab="recommendations"
        bindtap="switchTab"
      >
        æŠ¤è‚¤å»ºè®®
      </view>
      <view 
        class="tab-item {{currentTab === 'history' ? 'active' : ''}}"
        data-tab="history"
        bindtap="switchTab"
      >
        å†å²å¯¹æ¯”
      </view>
    </view>

    <!-- æ¦‚è§ˆæ ‡ç­¾é¡µ -->
    <view class="tab-content" wx:if="{{currentTab === 'overview'}}">
      <!-- å…³é”®æŒ‡æ ‡ -->
      <view class="metrics-section">
        <view class="section-title">å…³é”®æŒ‡æ ‡</view>
        <view class="metrics-grid">
          <view 
            class="metric-item"
            wx:for="{{reportData.keyMetrics}}" 
            wx:key="name"
          >
            <view class="metric-icon">{{item.icon}}</view>
            <view class="metric-name">{{item.name}}</view>
            <view class="metric-value">{{item.value}}</view>
            <view class="metric-status {{item.status}}">{{item.statusText}}</view>
          </view>
        </view>
      </view>

      <!-- é—®é¢˜åˆ†æ -->
      <view class="issues-section" wx:if="{{reportData.issues.length > 0}}">
        <view class="section-title">å‘ç°çš„é—®é¢˜</view>
        <view class="issues-list">
          <view 
            class="issue-item"
            wx:for="{{reportData.issues}}" 
            wx:key="id"
          >
            <view class="issue-severity {{item.severity}}">{{item.severityText}}</view>
            <view class="issue-content">
              <view class="issue-name">{{item.name}}</view>
              <view class="issue-desc">{{item.description}}</view>
            </view>
            <view class="issue-arrow">></view>
          </view>
        </view>
      </view>

      <!-- æ”¹å–„å»ºè®® -->
      <view class="suggestions-section">
        <view class="section-title">æ”¹å–„å»ºè®®</view>
        <view class="suggestions-list">
          <view 
            class="suggestion-item"
            wx:for="{{reportData.suggestions}}" 
            wx:key="id"
          >
            <view class="suggestion-icon">ğŸ’¡</view>
            <view class="suggestion-text">{{item.text}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- è¯¦ç»†åˆ†ææ ‡ç­¾é¡µ -->
    <view class="tab-content" wx:if="{{currentTab === 'details'}}">
      <view class="analysis-sections">
        <view 
          class="analysis-section"
          wx:for="{{reportData.detailedAnalysis}}" 
          wx:key="category"
          data-category="{{item.category}}"
          bindtap="viewDetailAnalysis"
        >
          <view class="analysis-header">
            <view class="analysis-title">{{item.title}}</view>
            <view class="analysis-score">{{item.score}}åˆ†</view>
          </view>
          
          <view class="analysis-progress">
            <view class="progress-bar">
              <view 
                class="progress-fill" 
                style="width: {{item.score}}%"
              ></view>
            </view>
          </view>
          
          <view class="analysis-summary">{{item.summary}}</view>
          
          <!-- å­æŒ‡æ ‡ -->
          <view class="sub-metrics" wx:if="{{item.subMetrics}}">
            <view 
              class="sub-metric"
              wx:for="{{item.subMetrics}}" 
              wx:for-item="subItem"
              wx:key="name"
            >
              <view class="sub-metric-name">{{subItem.name}}</view>
              <view class="sub-metric-value">{{subItem.value}}</view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æŠ¤è‚¤å»ºè®®æ ‡ç­¾é¡µ -->
    <view class="tab-content" wx:if="{{currentTab === 'recommendations'}}">
      <!-- äº§å“æ¨è -->
      <view class="products-section">
        <view class="section-title">æ¨èäº§å“</view>
        <view class="products-list">
          <view 
            class="product-card"
            wx:for="{{reportData.recommendedProducts}}" 
            wx:key="id"
            data-product-id="{{item.id}}"
            bindtap="viewProductRecommendation"
          >
            <image class="product-image" src="{{item.image}}" />
            <view class="product-info">
              <view class="product-name">{{item.name}}</view>
              <view class="product-brand">{{item.brand}}</view>
              <view class="product-reason">{{item.recommendReason}}</view>
              <view class="product-match">åŒ¹é…åº¦: {{item.matchScore}}%</view>
            </view>
          </view>
        </view>
      </view>

      <!-- æŠ¤è‚¤æ­¥éª¤ -->
      <view class="routine-section">
        <view class="section-title">å»ºè®®æŠ¤è‚¤æµç¨‹</view>
        <view class="routine-tabs">
          <view class="routine-tab active">æ—¥é—´æŠ¤ç†</view>
          <view class="routine-tab">å¤œé—´æŠ¤ç†</view>
        </view>
        
        <view class="routine-steps">
          <view 
            class="routine-step"
            wx:for="{{reportData.recommendedRoutine.morning}}" 
            wx:key="step"
          >
            <view class="step-number">{{item.step}}</view>
            <view class="step-content">
              <view class="step-name">{{item.name}}</view>
              <view class="step-desc">{{item.description}}</view>
              <view class="step-products" wx:if="{{item.products}}">
                <text 
                  class="step-product"
                  wx:for="{{item.products}}" 
                  wx:for-item="product"
                  wx:key="*this"
                >
                  {{product}}
                </text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- ç”Ÿæ´»å»ºè®® -->
      <view class="lifestyle-section">
        <view class="section-title">ç”Ÿæ´»å»ºè®®</view>
        <view class="lifestyle-tips">
          <view 
            class="tip-item"
            wx:for="{{reportData.lifestyleTips}}" 
            wx:key="category"
          >
            <view class="tip-category">{{item.category}}</view>
            <view class="tip-content">{{item.content}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- å†å²å¯¹æ¯”æ ‡ç­¾é¡µ -->
    <view class="tab-content" wx:if="{{currentTab === 'history'}}">
      <view class="comparison-section" wx:if="{{showComparison}}">
        <view class="section-title">å†å²è¶‹åŠ¿</view>
        
        <!-- è¶‹åŠ¿å›¾è¡¨ -->
        <view class="chart-container">
          <canvas 
            canvas-id="trendChart" 
            class="trend-chart"
          ></canvas>
        </view>
        
        <!-- å¯¹æ¯”æ•°æ® -->
        <view class="comparison-list">
          <view 
            class="comparison-item"
            wx:for="{{comparisonData}}" 
            wx:key="date"
          >
            <view class="comparison-date">{{item.date}}</view>
            <view class="comparison-score">{{item.score}}åˆ†</view>
            <view class="comparison-change {{item.change >= 0 ? 'positive' : 'negative'}}">
              {{item.change >= 0 ? '+' : ''}}{{item.change}}
            </view>
          </view>
        </view>
        
        <button class="view-trends-btn" bindtap="viewTrends">
          æŸ¥çœ‹å®Œæ•´è¶‹åŠ¿
        </button>
      </view>
      
      <view class="no-history" wx:else>
        <view class="no-history-icon">ğŸ“Š</view>
        <view class="no-history-text">æš‚æ— å†å²æ•°æ®</view>
        <view class="no-history-desc">ç»§ç»­ä½¿ç”¨æ£€æµ‹åŠŸèƒ½ï¼Œç§¯ç´¯æ›´å¤šæ•°æ®</view>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <button class="action-btn secondary" bindtap="saveToProfile">
        ä¿å­˜åˆ°æ¡£æ¡ˆ
      </button>
      <button class="action-btn secondary" bindtap="shareReport" disabled="{{isSharing}}">
        {{isSharing ? 'ç”Ÿæˆä¸­...' : 'åˆ†äº«æŠ¥å‘Š'}}
      </button>
      <button class="action-btn primary" bindtap="startSkincarePlan">
        å¼€å§‹æŠ¤è‚¤è®¡åˆ’
      </button>
    </view>

    <!-- å…¶ä»–æ“ä½œ -->
    <view class="other-actions">
      <view class="other-action" bindtap="retakeDetection">
        <view class="other-action-icon">ğŸ”„</view>
        <view class="other-action-text">é‡æ–°æ£€æµ‹</view>
      </view>

      <view class="other-action" bindtap="goHome">
        <view class="other-action-icon">ğŸ </view>
        <view class="other-action-text">è¿”å›é¦–é¡µ</view>
      </view>
    </view>
  </view>

  <!-- åˆ†äº«ç”»å¸ƒ -->
  <canvas 
    canvas-id="shareCanvas" 
    class="share-canvas"
    style="width: 750rpx; height: 1334rpx; position: fixed; top: -9999rpx; left: -9999rpx;"
  ></canvas>
</view>