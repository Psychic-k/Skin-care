<!--ç®¡ç†åå° - äº§å“æ•°æ®ç®¡ç†é¡µé¢-->
<view class="container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="header">
    <view class="header-title">äº§å“æ•°æ®ç®¡ç†</view>
    <view class="header-subtitle">å…± {{totalCount}} ä¸ªäº§å“</view>
  </view>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view class="statistics-cards">
    <view class="stat-card">
      <view class="stat-number">{{statistics.totalProducts}}</view>
      <view class="stat-label">æ€»äº§å“æ•°</view>
    </view>
    <view class="stat-card">
      <view class="stat-number">{{statistics.activeProducts}}</view>
      <view class="stat-label">å·²å¯ç”¨</view>
    </view>
    <view class="stat-card">
      <view class="stat-number">{{statistics.inactiveProducts}}</view>
      <view class="stat-label">å·²ç¦ç”¨</view>
    </view>
    <view class="stat-card">
      <view class="stat-number">{{statistics.totalBrands}}</view>
      <view class="stat-label">å“ç‰Œæ•°</view>
    </view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰ -->
  <view class="search-filter-section">
    <!-- æœç´¢æ¡† -->
    <view class="search-box">
      <view class="search-icon">ğŸ”</view>
      <input class="search-input" 
             value="{{searchText}}" 
             placeholder="æœç´¢äº§å“åç§°æˆ–å“ç‰Œ"
             bindinput="onSearchInput" />
      <view wx:if="{{searchText}}" class="clear-search" bindtap="clearFilters">Ã—</view>
    </view>

    <!-- ç­›é€‰å™¨ -->
    <view class="filter-row">
      <picker class="filter-picker" 
              range="{{['å…¨éƒ¨'].concat(categories)}}" 
              value="{{filterCategory ? categories.indexOf(filterCategory) + 1 : 0}}"
              bindchange="onCategoryChange">
        <view class="filter-display">
          <view class="filter-text">{{filterCategory || 'å…¨éƒ¨åˆ†ç±»'}}</view>
          <view class="filter-arrow">â–¼</view>
        </view>
      </picker>

      <picker class="filter-picker" 
              range="{{brandOptions}}" 
              value="{{filterBrandIndex}}"
              bindchange="onBrandChange">
        <view class="filter-display">
          <view class="filter-text">{{filterBrand || 'å…¨éƒ¨å“ç‰Œ'}}</view>
          <view class="filter-arrow">â–¼</view>
        </view>
      </picker>

      <picker class="filter-picker" 
              range="{{['å…¨éƒ¨', 'å·²å¯ç”¨', 'å·²ç¦ç”¨']}}" 
              range-key="label"
              value="{{filterStatus === 'all' ? 0 : (filterStatus === 'active' ? 1 : 2)}}"
              bindchange="onStatusChange">
        <view class="filter-display">
          <view class="filter-text">
            {{filterStatus === 'all' ? 'å…¨éƒ¨çŠ¶æ€' : (filterStatus === 'active' ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨')}}
          </view>
          <view class="filter-arrow">â–¼</view>
        </view>
      </picker>
    </view>
  </view>

  <!-- æ“ä½œæ  -->
  <view class="action-bar">
    <view class="left-actions">
      <button class="action-btn primary" bindtap="goToUpload">
        <view class="btn-icon">â•</view>
        <view class="btn-text">æ·»åŠ äº§å“</view>
      </button>
      <button class="action-btn {{isSelectMode ? 'active' : ''}}" bindtap="toggleSelectMode">
        <view class="btn-icon">{{isSelectMode ? 'âœ“' : 'â˜'}}</view>
        <view class="btn-text">{{isSelectMode ? 'å–æ¶ˆé€‰æ‹©' : 'æ‰¹é‡æ“ä½œ'}}</view>
      </button>
      <button class="action-btn test" bindtap="showCloudFunctionTest">
        <view class="btn-icon">ğŸ§ª</view>
        <view class="btn-text">æµ‹è¯•äº‘å‡½æ•°</view>
      </button>
    </view>
    
    <view class="right-actions">
      <button class="action-btn" bindtap="exportData">
        <view class="btn-icon">ğŸ“¤</view>
        <view class="btn-text">å¯¼å‡º</view>
      </button>
    </view>
  </view>

  <!-- æ‰¹é‡æ“ä½œæ  -->
  <view wx:if="{{isSelectMode && selectedProducts.length > 0}}" class="batch-action-bar">
    <view class="selected-count">å·²é€‰æ‹© {{selectedProducts.length}} ä¸ªäº§å“</view>
    <view class="batch-actions">
      <button class="batch-btn" bindtap="showBatchActions">æ‰¹é‡æ“ä½œ</button>
      <button class="batch-btn" bindtap="toggleSelectAll">
        {{selectedProducts.length === filteredProducts.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}}
      </button>
    </view>
  </view>

  <!-- äº§å“åˆ—è¡¨ -->
  <view class="product-list">
    <view wx:if="{{loading && filteredProducts.length === 0}}" class="loading-state">
      <view class="loading-icon">â³</view>
      <view class="loading-text">åŠ è½½ä¸­...</view>
    </view>

    <view wx:elif="{{filteredProducts.length === 0}}" class="empty-state">
      <view class="empty-icon">ğŸ“¦</view>
      <view class="empty-text">æš‚æ— äº§å“æ•°æ®</view>
      <button class="empty-action" bindtap="goToUpload">æ·»åŠ ç¬¬ä¸€ä¸ªäº§å“</button>
    </view>

    <view wx:else>
      <view wx:for="{{filteredProducts}}" 
            wx:key="id" 
            class="product-item {{isSelectMode ? 'select-mode' : ''}}"
            bindtap="{{isSelectMode ? 'toggleProductSelect' : 'viewProductDetail'}}"
            data-id="{{item.id}}">
        
        <!-- é€‰æ‹©æ¡† -->
        <view wx:if="{{isSelectMode}}" class="select-checkbox">
          <view class="checkbox {{selectedProducts.includes(item.id) ? 'checked' : ''}}">
            {{selectedProducts.includes(item.id) ? 'âœ“' : ''}}
          </view>
        </view>

        <!-- äº§å“å›¾ç‰‡ -->
        <view class="product-image">
          <image src="{{item.image}}" mode="aspectFill" />
          <view class="status-badge {{item.status}}">
            {{item.status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨'}}
          </view>
        </view>

        <!-- äº§å“ä¿¡æ¯ -->
        <view class="product-info">
          <view class="product-name">{{item.name}}</view>
          <view class="product-brand">{{item.brand}}</view>
          <view class="product-category">{{item.category}}</view>
          <view class="product-price">Â¥{{item.price}}</view>
          
          <view class="product-meta">
            <view class="meta-item">
              <view class="meta-label">é”€é‡:</view>
              <view class="meta-value">{{item.sales}}</view>
            </view>
            <view class="meta-item">
              <view class="meta-label">è¯„åˆ†:</view>
              <view class="meta-value">{{item.rating}}</view>
            </view>
            <view class="meta-item">
              <view class="meta-label">æ›´æ–°:</view>
              <view class="meta-value">{{item.updateTime.split('T')[0]}}</view>
            </view>
          </view>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view wx:if="{{!isSelectMode}}" class="product-actions">
          <button class="action-icon edit" 
                  bindtap="editProduct" 
                  data-id="{{item.id}}"
                  catchtap="true">
            âœï¸
          </button>
          <button class="action-icon toggle" 
                  bindtap="toggleProductStatus" 
                  data-id="{{item.id}}"
                  catchtap="true">
            {{item.status === 'active' ? 'ğŸ”’' : 'ğŸ”“'}}
          </button>
          <button class="action-icon delete" 
                  bindtap="deleteProduct" 
                  data-id="{{item.id}}"
                  catchtap="true">
            ğŸ—‘ï¸
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view wx:if="{{hasMore && !loading}}" class="load-more">
    <button class="load-more-btn" bindtap="loadMoreProducts">åŠ è½½æ›´å¤š</button>
  </view>

  <view wx:if="{{loading && filteredProducts.length > 0}}" class="loading-more">
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>
</view>

<!-- äº§å“è¯¦æƒ…å¼¹çª— -->
<view wx:if="{{showProductDetail}}" class="product-detail-modal">
  <view class="modal-mask" bindtap="closeProductDetail"></view>
  <view class="detail-content">
    <view class="detail-header">
      <view class="detail-title">äº§å“è¯¦æƒ…</view>
      <view class="detail-close" bindtap="closeProductDetail">Ã—</view>
    </view>
    
    <scroll-view class="detail-body" scroll-y>
      <view wx:if="{{currentProduct}}" class="product-detail">
        <view class="detail-image">
          <image src="{{currentProduct.image}}" mode="aspectFill" />
        </view>
        
        <view class="detail-info">
          <view class="detail-row">
            <view class="detail-label">äº§å“åç§°:</view>
            <view class="detail-value">{{currentProduct.name}}</view>
          </view>
          <view class="detail-row">
            <view class="detail-label">å“ç‰Œ:</view>
            <view class="detail-value">{{currentProduct.brand}}</view>
          </view>
          <view class="detail-row">
            <view class="detail-label">åˆ†ç±»:</view>
            <view class="detail-value">{{currentProduct.category}}</view>
          </view>
          <view class="detail-row">
            <view class="detail-label">ä»·æ ¼:</view>
            <view class="detail-value">Â¥{{currentProduct.price}}</view>
          </view>
          <view class="detail-row">
            <view class="detail-label">çŠ¶æ€:</view>
            <view class="detail-value {{currentProduct.status}}">
              {{currentProduct.status === 'active' ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}}
            </view>
          </view>
          <view class="detail-row">
            <view class="detail-label">é”€é‡:</view>
            <view class="detail-value">{{currentProduct.sales}}</view>
          </view>
          <view class="detail-row">
            <view class="detail-label">è¯„åˆ†:</view>
            <view class="detail-value">{{currentProduct.rating}}</view>
          </view>
          <view class="detail-row">
            <view class="detail-label">åˆ›å»ºæ—¶é—´:</view>
            <view class="detail-value">{{currentProduct.createTime.split('T')[0]}}</view>
          </view>
          <view class="detail-row">
            <view class="detail-label">æ›´æ–°æ—¶é—´:</view>
            <view class="detail-value">{{currentProduct.updateTime.split('T')[0]}}</view>
          </view>
        </view>
      </view>
    </scroll-view>
    
    <view class="detail-actions">
      <button class="detail-btn edit" bindtap="editProduct" data-id="{{currentProduct.id}}">ç¼–è¾‘</button>
      <button class="detail-btn toggle" bindtap="toggleProductStatus" data-id="{{currentProduct.id}}">
        {{currentProduct.status === 'active' ? 'ç¦ç”¨' : 'å¯ç”¨'}}
      </button>
    </view>
  </view>
</view>

<!-- æ‰¹é‡æ“ä½œå¼¹çª— -->
<view wx:if="{{showBatchActions}}" class="batch-actions-modal">
  <view class="modal-mask" bindtap="hideBatchActions"></view>
  <view class="batch-content">
    <view class="batch-header">
      <view class="batch-title">æ‰¹é‡æ“ä½œ</view>
      <view class="batch-subtitle">å·²é€‰æ‹© {{selectedProducts.length}} ä¸ªäº§å“</view>
    </view>
    
    <view class="batch-options">
      <button class="batch-option enable" bindtap="batchEnable">
        <view class="option-icon">ğŸ”“</view>
        <view class="option-text">æ‰¹é‡å¯ç”¨</view>
      </button>
      <button class="batch-option disable" bindtap="batchDisable">
        <view class="option-icon">ğŸ”’</view>
        <view class="option-text">æ‰¹é‡ç¦ç”¨</view>
      </button>
      <button class="batch-option delete" bindtap="batchDelete">
        <view class="option-icon">ğŸ—‘ï¸</view>
        <view class="option-text">æ‰¹é‡åˆ é™¤</view>
      </button>
    </view>
    
    <button class="batch-cancel" bindtap="hideBatchActions">å–æ¶ˆ</button>
  </view>
</view>

<!-- äº‘å‡½æ•°æµ‹è¯•å¼¹çª— -->
<view wx:if="{{showCloudFunctionTest}}" class="cloud-test-modal">
  <view class="modal-mask" bindtap="hideCloudFunctionTest"></view>
  <view class="test-content">
    <view class="test-header">
      <view class="test-title">äº‘å‡½æ•°æµ‹è¯•</view>
      <view class="test-close" bindtap="hideCloudFunctionTest">Ã—</view>
    </view>
    
    <view class="test-body">
      <!-- äº‘å‡½æ•°é€‰æ‹© -->
      <view class="test-section">
        <view class="section-title">é€‰æ‹©äº‘å‡½æ•°</view>
        <picker class="function-picker" 
                range="{{cloudFunctions}}" 
                range-key="name"
                value="{{selectedFunctionIndex}}"
                bindchange="onCloudFunctionChange">
          <view class="picker-display">
            <view class="picker-text">
              {{selectedCloudFunction ? selectedCloudFunction.name : 'è¯·é€‰æ‹©äº‘å‡½æ•°'}}
            </view>
            <view class="picker-arrow">â–¼</view>
          </view>
        </picker>
        
        <view wx:if="{{selectedCloudFunction}}" class="function-info">
          <view class="info-item">
            <view class="info-label">åŠŸèƒ½æè¿°:</view>
            <view class="info-value">{{selectedCloudFunction.description}}</view>
          </view>
          <view class="info-item">
            <view class="info-label">APIè·¯å¾„:</view>
            <view class="info-value">{{selectedCloudFunction.apiPath}}</view>
          </view>
        </view>
      </view>
      
      <!-- æµ‹è¯•å‚æ•° -->
      <view wx:if="{{selectedCloudFunction}}" class="test-section">
        <view class="section-title">æµ‹è¯•å‚æ•°</view>
        <textarea class="param-textarea" 
                  value="{{testParams}}" 
                  placeholder="è¯·è¾“å…¥JSONæ ¼å¼çš„æµ‹è¯•å‚æ•°"
                  bindinput="onTestParamsInput" />
      </view>
      
      <!-- æµ‹è¯•æŒ‰é’® -->
      <view class="test-actions">
        <button class="test-btn primary {{testLoading ? 'loading' : ''}}" 
                bindtap="startCloudFunctionTest"
                disabled="{{!selectedCloudFunction || testLoading}}">
          <view wx:if="{{testLoading}}" class="loading-icon">â³</view>
          <view class="btn-text">{{testLoading ? 'æµ‹è¯•ä¸­...' : 'å¼€å§‹æµ‹è¯•'}}</view>
        </button>
        <button class="test-btn" bindtap="clearTestResult">æ¸…ç©ºç»“æœ</button>
      </view>
      
      <!-- æµ‹è¯•ç»“æœ -->
      <view wx:if="{{testResult}}" class="test-result">
        <view class="result-header">
          <view class="result-title">æµ‹è¯•ç»“æœ</view>
          <view class="result-status {{testResult.success ? 'success' : 'error'}}">
            {{testResult.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}}
          </view>
        </view>
        
        <view class="result-content">
          <view class="result-item">
            <view class="result-label">å“åº”æ—¶é—´:</view>
            <view class="result-value">{{testResult.duration}}ms</view>
          </view>
          <view class="result-item">
            <view class="result-label">çŠ¶æ€ç :</view>
            <view class="result-value">{{testResult.code}}</view>
          </view>
          
          <view class="result-data">
            <view class="data-title">è¿”å›æ•°æ®:</view>
            <scroll-view class="data-content" scroll-y>
              <text class="data-text">{{testResult.dataText}}</text>
            </scroll-view>
          </view>
          
          <view wx:if="{{testResult.error}}" class="result-error">
            <view class="error-title">é”™è¯¯ä¿¡æ¯:</view>
            <view class="error-content">{{testResult.error}}</view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>