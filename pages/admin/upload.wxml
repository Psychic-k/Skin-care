<!--ç®¡ç†åå° - äº§å“æ•°æ®ä¸Šä¼ é¡µé¢-->
<view class="container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="header">
    <view class="header-title">äº§å“æ•°æ®ä¸Šä¼ </view>
    <view class="header-subtitle">æ”¯æŒæ‰¹é‡ä¸Šä¼ å’Œå•ä¸ªäº§å“æ·»åŠ </view>
  </view>

  <!-- ä¸Šä¼ æ–¹å¼é€‰æ‹© -->
  <view class="upload-type-selector">
    <view class="type-option {{uploadType === 'batch' ? 'active' : ''}}" bindtap="selectUploadType" data-type="batch">
      <view class="type-icon">ğŸ“Š</view>
      <view class="type-text">æ‰¹é‡ä¸Šä¼ </view>
    </view>
    <view class="type-option {{uploadType === 'single' ? 'active' : ''}}" bindtap="selectUploadType" data-type="single">
      <view class="type-icon">â•</view>
      <view class="type-text">å•ä¸ªæ·»åŠ </view>
    </view>
  </view>

  <!-- æ‰¹é‡ä¸Šä¼ åŒºåŸŸ -->
  <view class="batch-upload-section" wx:if="{{uploadType === 'batch'}}">
    <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
    <view class="file-upload-area">
      <view wx:if="{{!selectedFile}}" class="upload-zone" bindtap="selectFile">
        <view class="upload-icon">ğŸ“</view>
        <view class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</view>
        <view class="upload-hint">æ”¯æŒ Excel (.xlsx) å’Œ CSV (.csv) æ ¼å¼</view>
      </view>

      <!-- å·²é€‰æ‹©æ–‡ä»¶ -->
      <view wx:if="{{selectedFile}}" class="selected-file">
        <view class="file-info">
          <view class="file-icon">ğŸ“„</view>
          <view class="file-details">
            <view class="file-name">{{selectedFile.name}}</view>
            <view class="file-size">{{selectedFile.size}}</view>
          </view>
          <view class="file-remove" bindtap="removeFile">âœ•</view>
        </view>

        <!-- ä¸Šä¼ æŒ‰é’® -->
        <view class="upload-actions">
          <button class="upload-btn {{uploading ? 'uploading' : ''}}" 
                  bindtap="startUpload" 
                  disabled="{{uploading}}">
            {{uploading ? 'ä¸Šä¼ ä¸­...' : 'å¼€å§‹ä¸Šä¼ '}}
          </button>
        </view>

        <!-- ä¸Šä¼ è¿›åº¦ -->
        <view wx:if="{{uploading}}" class="upload-progress">
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{uploadProgress}}%"></view>
          </view>
          <view class="progress-text">{{uploadProgress}}%</view>
        </view>

        <!-- ä¸Šä¼ ç»“æœ -->
        <view wx:if="{{uploadResult}}" class="upload-result">
          <view class="result-header {{uploadResult.success ? 'success' : 'error'}}">
            <view class="result-icon">{{uploadResult.success ? 'âœ…' : 'âŒ'}}</view>
            <view class="result-message">{{uploadResult.message}}</view>
          </view>

          <view class="result-details">
            <view class="detail-item">
              <view class="detail-label">æ€»è®¡:</view>
              <view class="detail-value">{{uploadResult.total}}</view>
            </view>
            <view class="detail-item">
              <view class="detail-label">æˆåŠŸ:</view>
              <view class="detail-value success">{{uploadResult.success_count}}</view>
            </view>
            <view class="detail-item" wx:if="{{uploadResult.error_count > 0}}">
              <view class="detail-label">å¤±è´¥:</view>
              <view class="detail-value error">{{uploadResult.error_count}}</view>
            </view>
          </view>

          <!-- é”™è¯¯è¯¦æƒ… -->
          <view wx:if="{{uploadResult.errors && uploadResult.errors.length > 0}}" class="error-list">
            <view class="error-title">é”™è¯¯è¯¦æƒ…:</view>
            <view wx:for="{{uploadResult.errors}}" wx:key="index" class="error-item">
              <view class="error-row">ç¬¬{{item.row}}è¡Œ:</view>
              <view class="error-msg">{{item.message}}</view>
            </view>
          </view>
        </view>
      </view>

      <!-- æ¨¡æ¿ä¸‹è½½ -->
      <view class="template-download">
        <text class="download-link" bindtap="downloadTemplate">ä¸‹è½½Excelæ¨¡æ¿</text>
      </view>
    </view>
  </view>

  <!-- å•ä¸ªäº§å“æ·»åŠ åŒºåŸŸ -->
  <view class="single-add-section" wx:if="{{uploadType === 'single'}}">
    <form class="product-form" bindsubmit="submitProduct">
      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
        
        <view class="form-item">
          <view class="form-label">äº§å“åç§° *</view>
          <input class="form-input" 
                 name="name" 
                 value="{{productForm.name}}" 
                 placeholder="è¯·è¾“å…¥äº§å“åç§°"
                 bindinput="onFormInput"
                 data-field="name" />
        </view>

        <view class="form-item">
          <view class="form-label">å“ç‰Œ *</view>
          <view class="brand-selector" bindtap="showBrandModal">
            <view class="brand-text {{!productForm.brand ? 'placeholder' : ''}}">
              {{productForm.brand || 'è¯·é€‰æ‹©å“ç‰Œ'}}
            </view>
            <view class="selector-arrow">â–¼</view>
          </view>
        </view>

        <view class="form-item">
          <view class="form-label">ä»·æ ¼ (å…ƒ)</view>
          <input class="form-input" 
                 name="price" 
                 type="digit"
                 value="{{productForm.price}}" 
                 placeholder="è¯·è¾“å…¥ä»·æ ¼"
                 bindinput="onFormInput"
                 data-field="price" />
        </view>

        <view class="form-item">
          <view class="form-label">åˆ†ç±» *</view>
          <picker range="{{categories}}" 
                  value="{{categoryIndex}}" 
                  bindchange="onCategoryChange">
            <view class="picker-display">
              <view>{{productForm.category || 'è¯·é€‰æ‹©åˆ†ç±»'}}</view>
              <view class="picker-arrow">â–¼</view>
            </view>
          </picker>
        </view>

        <view class="form-item">
          <view class="form-label">äº§å“æè¿°</view>
          <textarea class="form-textarea" 
                    name="description" 
                    value="{{productForm.description}}" 
                    placeholder="è¯·è¾“å…¥äº§å“æè¿°"
                    bindinput="onFormInput"
                    data-field="description"
                    maxlength="500" />
        </view>
      </view>

      <!-- é€‚ç”¨è‚Œè‚¤ç±»å‹ -->
      <view class="form-section">
        <view class="section-title">é€‚ç”¨è‚Œè‚¤ç±»å‹</view>
        <view class="checkbox-group">
          <view wx:for="{{skinTypes}}" 
                wx:key="index" 
                class="checkbox-item {{productForm.skinTypes.includes(item) ? 'selected' : ''}}"
                bindtap="toggleSkinType"
                data-type="{{item}}">
            <view class="checkbox-icon">{{productForm.skinTypes.includes(item) ? 'âœ“' : 'â—‹'}}</view>
            <view class="checkbox-text">{{item}}</view>
          </view>
        </view>
      </view>

      <!-- ä¸»è¦åŠŸæ•ˆ -->
      <view class="form-section">
        <view class="section-title">ä¸»è¦åŠŸæ•ˆ</view>
        <view class="checkbox-group">
          <view wx:for="{{effects}}" 
                wx:key="index" 
                class="checkbox-item {{productForm.effects.includes(item) ? 'selected' : ''}}"
                bindtap="toggleEffect"
                data-effect="{{item}}">
            <view class="checkbox-icon">{{productForm.effects.includes(item) ? 'âœ“' : 'â—‹'}}</view>
            <view class="checkbox-text">{{item}}</view>
          </view>
        </view>
      </view>

      <!-- æˆåˆ†ä¿¡æ¯ -->
      <view class="form-section">
        <view class="section-title">æˆåˆ†ä¿¡æ¯</view>
        
        <view class="ingredient-input">
          <input class="ingredient-field" 
                 value="{{newIngredient.name}}" 
                 placeholder="æˆåˆ†åç§°"
                 bindinput="onIngredientInput"
                 data-field="name" />
          <input class="ingredient-field" 
                 value="{{newIngredient.concentration}}" 
                 placeholder="æµ“åº¦ (å¯é€‰)"
                 bindinput="onIngredientInput"
                 data-field="concentration" />
          <button class="add-ingredient-btn" 
                  bindtap="addIngredient" 
                  type="button">æ·»åŠ </button>
        </view>

        <view class="ingredient-list">
          <view wx:for="{{productForm.ingredients}}" 
                wx:key="index" 
                class="ingredient-tag">
            <view class="ingredient-name">
              {{item.name}}{{item.concentration ? ' (' + item.concentration + ')' : ''}}
            </view>
            <view class="remove-ingredient" 
                  bindtap="removeIngredient" 
                  data-index="{{index}}">Ã—</view>
          </view>
        </view>
      </view>

      <!-- äº§å“å›¾ç‰‡ -->
      <view class="form-section">
        <view class="section-title">äº§å“å›¾ç‰‡</view>
        <view class="image-upload" bindtap="selectImage">
          <view wx:if="{{productForm.image}}" class="image-preview">
            <image class="preview-image" src="{{productForm.image}}" mode="aspectFill" />
            <view class="image-mask">
              <view class="change-text">ç‚¹å‡»æ›´æ¢</view>
            </view>
          </view>
          <view wx:else class="image-placeholder">
            <view class="placeholder-icon">ğŸ“·</view>
            <view class="placeholder-text">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</view>
          </view>
        </view>
      </view>

      <!-- éªŒè¯é”™è¯¯ -->
      <view wx:if="{{validationErrors.length > 0}}" class="validation-errors">
        <view class="error-title">è¯·ä¿®æ­£ä»¥ä¸‹é”™è¯¯:</view>
        <view wx:for="{{validationErrors}}" wx:key="index" class="error-item">
          <view class="error-text">â€¢ {{item}}</view>
        </view>
      </view>

      <!-- è¡¨å•æ“ä½œ -->
      <view class="form-actions">
        <button class="reset-btn" bindtap="resetForm" type="button">é‡ç½®</button>
        <button class="submit-btn" form-type="submit">ä¿å­˜äº§å“</button>
      </view>
    </form>
  </view>
</view>

<!-- å“ç‰Œé€‰æ‹©å¼¹çª— -->
<view wx:if="{{showBrandModal}}" class="brand-modal">
  <view class="modal-mask" bindtap="hideBrandModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <view class="modal-title">é€‰æ‹©å“ç‰Œ</view>
      <view class="modal-close" bindtap="hideBrandModal">Ã—</view>
    </view>
    <scroll-view class="brand-list" scroll-y>
      <view wx:for="{{brands}}" 
            wx:key="id" 
            class="brand-item"
            bindtap="selectBrand"
            data-brand="{{item.name}}">
        <image class="brand-logo" src="{{item.logo}}" mode="aspectFill" />
        <view class="brand-name">{{item.name}}</view>
      </view>
    </scroll-view>
  </view>
</view>