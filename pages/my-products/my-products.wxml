<!--pages/my-products/my-products.wxml-->
<view class="container">
  <!-- å¤´éƒ¨åŒºåŸŸ -->
  <view class="header">
    <view class="header-content">
      <text class="title">æˆ‘çš„ç”¨å“</text>
      <text class="subtitle">ç®¡ç†æ‚¨çš„æŠ¤è‚¤å“æ”¶è—</text>
    </view>
    <view class="header-actions">
      <view class="action-btn" bindtap="showAddOptions">
        <text class="action-icon">+</text>
        <text class="action-text">æ·»åŠ </text>
      </view>
    </view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰åŒºåŸŸ -->
  <view class="search-section">
    <view class="search-bar">
      <view class="search-input-wrapper">
        <input 
          class="search-input" 
          placeholder="æœç´¢äº§å“åç§°æˆ–å“ç‰Œ" 
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          bindconfirm="onSearchConfirm"
        />
        <view class="search-icon">ğŸ”</view>
      </view>
      <view class="filter-btn" bindtap="showFilterModal">
        <text class="filter-icon">âš™ï¸</text>
      </view>
    </view>
    
    <!-- ç­›é€‰æ ‡ç­¾ -->
    <view class="filter-tags" wx:if="{{activeFilters.length > 0}}">
      <view 
        class="filter-tag" 
        wx:for="{{activeFilters}}" 
        wx:key="index"
        bindtap="removeFilter"
        data-index="{{index}}"
      >
        <text>{{item.label}}</text>
        <text class="remove-icon">Ã—</text>
      </view>
      <view class="clear-filters" bindtap="clearAllFilters">
        <text>æ¸…ç©ºç­›é€‰</text>
      </view>
    </view>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="stats-section">
    <view class="stat-item">
      <text class="stat-number">{{totalCount}}</text>
      <text class="stat-label">æ€»æ•°é‡</text>
    </view>
    <view class="stat-item">
      <text class="stat-number">{{usedCount}}</text>
      <text class="stat-label">å·²ä½¿ç”¨</text>
    </view>
    <view class="stat-item">
      <text class="stat-number">{{favoriteCount}}</text>
      <text class="stat-label">æ”¶è—</text>
    </view>
  </view>

  <!-- äº§å“åˆ—è¡¨ -->
  <view class="products-section">
    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-container" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-container" wx:elif="{{products.length === 0 && !loading}}">
      <view class="empty-icon">ğŸ“¦</view>
      <text class="empty-title">æš‚æ— æŠ¤è‚¤å“</text>
      <text class="empty-desc">ç‚¹å‡»å³ä¸Šè§’æ·»åŠ æŒ‰é’®å¼€å§‹æ”¶é›†æ‚¨çš„æŠ¤è‚¤å“</text>
      <view class="empty-action" bindtap="showAddOptions">
        <text>ç«‹å³æ·»åŠ </text>
      </view>
    </view>

    <!-- äº§å“ç½‘æ ¼ -->
    <view class="products-grid" wx:else>
      <view 
        class="product-card" 
        wx:for="{{products}}" 
        wx:key="_id"
        bindtap="viewProductDetail"
        data-product="{{item}}"
      >
        <view class="product-image-wrapper">
          <image 
            class="product-image" 
            src="{{item.imageUrl || '/images/placeholder-product.png'}}" 
            mode="aspectFill"
            lazy-load="{{true}}"
          />
          <view class="product-status" wx:if="{{item.status}}">
            <text class="status-text">{{item.status === 'used' ? 'å·²ç”¨' : item.status === 'favorite' ? 'æ”¶è—' : ''}}</text>
          </view>
        </view>
        
        <view class="product-info">
          <text class="product-name">{{item.name}}</text>
          <text class="product-brand">{{item.brand}}</text>
          <view class="product-meta">
            <text class="product-category">{{item.categoryDisplay || item.category}}</text>
            <text class="product-date">{{item.addedDateDisplay}}</text>
          </view>
        </view>

        <view class="product-actions">
          <view 
            class="action-btn-small {{item.isFavorite ? 'active' : ''}}" 
            bindtap="toggleFavorite"
            data-id="{{item._id}}"
            catchtap="true"
          >
            <text class="action-icon">{{item.isFavorite ? 'â¤ï¸' : 'ğŸ¤'}}</text>
          </view>
          <view 
            class="action-btn-small" 
            bindtap="showProductMenu"
            data-product="{{item}}"
            catchtap="true"
          >
            <text class="action-icon">â‹¯</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{hasMore && products.length > 0}}">
      <view class="load-more-btn" bindtap="loadMore" wx:if="{{!loadingMore}}">
        <text>åŠ è½½æ›´å¤š</text>
      </view>
      <view class="loading-more" wx:else>
        <view class="loading-spinner-small"></view>
        <text>åŠ è½½ä¸­...</text>
      </view>
    </view>
  </view>

  <!-- æ·»åŠ é€‰é¡¹å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showAddModal}}" bindtap="hideAddModal">
    <view class="add-modal" catchtap="true">
      <view class="modal-header">
        <text class="modal-title">æ·»åŠ æŠ¤è‚¤å“</text>
        <view class="modal-close" bindtap="hideAddModal">Ã—</view>
      </view>
      <view class="modal-content">
        <view class="add-option" bindtap="selectFromExisting">
          <view class="option-icon">ğŸ§´</view>
          <view class="option-info">
            <text class="option-title">ä»ç°æœ‰äº§å“é€‰æ‹©</text>
            <text class="option-desc">ä»äº§å“åº“ä¸­é€‰æ‹©å·²æœ‰çš„æŠ¤è‚¤å“</text>
          </view>
          <view class="option-arrow">â†’</view>
        </view>
        <view class="add-option" bindtap="requestNewProduct">
          <view class="option-icon">ğŸ“</view>
          <view class="option-info">
            <text class="option-title">äº§å“å‚¬æ›´</text>
            <text class="option-desc">æäº¤æ–°äº§å“ä¿¡æ¯ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸</text>
          </view>
          <view class="option-arrow">â†’</view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showFilterModal}}" bindtap="hideFilterModal">
    <view class="filter-modal" catchtap="true">
      <view class="modal-header">
        <text class="modal-title">ç­›é€‰æ¡ä»¶</text>
        <view class="modal-close" bindtap="hideFilterModal">Ã—</view>
      </view>
      <view class="modal-content">
        <!-- åˆ†ç±»ç­›é€‰ -->
        <view class="filter-group">
          <text class="filter-group-title">äº§å“åˆ†ç±»</text>
          <view class="filter-options">
            <view 
              class="filter-option {{filterOptions.category === item.value ? 'active' : ''}}"
              wx:for="{{categoryOptions}}" 
              wx:key="value"
              bindtap="selectFilterOption"
              data-type="category"
              data-value="{{item.value}}"
            >
              <text>{{item.label}}</text>
            </view>
          </view>
        </view>

        <!-- çŠ¶æ€ç­›é€‰ -->
        <view class="filter-group">
          <text class="filter-group-title">ä½¿ç”¨çŠ¶æ€</text>
          <view class="filter-options">
            <view 
              class="filter-option {{filterOptions.status === item.value ? 'active' : ''}}"
              wx:for="{{statusOptions}}" 
              wx:key="value"
              bindtap="selectFilterOption"
              data-type="status"
              data-value="{{item.value}}"
            >
              <text>{{item.label}}</text>
            </view>
          </view>
        </view>

        <!-- æ’åºæ–¹å¼ -->
        <view class="filter-group">
          <text class="filter-group-title">æ’åºæ–¹å¼</text>
          <view class="filter-options">
            <view 
              class="filter-option {{filterOptions.sort === item.value ? 'active' : ''}}"
              wx:for="{{sortOptions}}" 
              wx:key="value"
              bindtap="selectFilterOption"
              data-type="sort"
              data-value="{{item.value}}"
            >
              <text>{{item.label}}</text>
            </view>
          </view>
        </view>
      </view>
      <view class="modal-footer">
        <view class="modal-btn secondary" bindtap="resetFilters">é‡ç½®</view>
        <view class="modal-btn primary" bindtap="applyFilters">åº”ç”¨</view>
      </view>
    </view>
  </view>

  <!-- äº§å“èœå•å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showMenuModal}}" bindtap="hideMenuModal">
    <view class="menu-modal" catchtap="true">
      <view class="menu-item" bindtap="editProduct">
        <text class="menu-icon">âœï¸</text>
        <text class="menu-text">ç¼–è¾‘</text>
      </view>
      <view class="menu-item" bindtap="markAsUsed">
        <text class="menu-icon">âœ…</text>
        <text class="menu-text">{{selectedProduct.isUsed ? 'å–æ¶ˆä½¿ç”¨' : 'æ ‡è®°ä¸ºå·²ä½¿ç”¨'}}</text>
      </view>
      <view class="menu-item" bindtap="removeProduct">
        <text class="menu-icon">ğŸ—‘ï¸</text>
        <text class="menu-text">ç§»é™¤</text>
      </view>
    </view>
  </view>
</view>