# 云开发数据库集合创建指南

## 📋 概述

本指南将帮助您在微信小程序云开发环境中创建 `user_products` 和 `product_requests` 两个数据库集合。

## 🛠️ 创建方法

### 方法一：通过微信开发者工具创建（推荐）

#### 步骤1：打开云开发控制台

1. 在微信开发者工具中打开您的小程序项目
2. 点击工具栏中的"云开发"按钮
3. 进入云开发控制台

#### 步骤2：创建数据库集合

1. 在左侧菜单中点击"数据库"
2. 点击"集合名称"旁边的"+"按钮
3. 输入集合名称：`user_products`
4. 点击"确定"创建
5. 重复上述步骤创建 `product_requests` 集合

#### 步骤3：设置数据库权限

1. 在数据库页面点击"数据库权限"标签
2. 为 `user_products` 集合设置权限规则：

```json
{
  "read": "auth.uid == resource.userId",
  "write": "auth.uid == resource.userId"
}
```

1. 为 `product_requests` 集合设置权限规则：

```json
{
  "read": "auth.uid == resource.userId || get('users', auth.uid).isAdmin == true",
  "write": "auth.uid == resource.userId || get('users', auth.uid).isAdmin == true"
}
```

### 方法二：通过代码自动创建

当您第一次向集合写入数据时，云开发会自动创建集合。您可以使用以下初始化脚本：

#### 创建初始化脚本文件

在项目根目录创建 `init_database.js` 文件：

```javascript
// init_database.js - 数据库初始化脚本
const cloud = require('wx-server-sdk')

// 初始化云开发
cloud.init({
  env: 'your-env-id' // 替换为您的环境ID
})

const db = cloud.database()

async function initDatabase() {
  try {
    console.log('开始初始化数据库集合...')
    
    // 创建 user_products 集合的示例数据
    const userProductsResult = await db.collection('user_products').add({
      data: {
        userId: 'init_user',
        productId: 'init_product',
        productName: '初始化产品',
        brand: '测试品牌',
        imageUrl: '',
        status: 'active',
        addedDate: new Date(),
        purchaseDate: null,
        expiryDate: null,
        notes: '这是初始化数据，可以删除',
        rating: 0,
        repurchase: false
      }
    })
    console.log('user_products 集合创建成功:', userProductsResult._id)
    
    // 创建 product_requests 集合的示例数据
    const productRequestsResult = await db.collection('product_requests').add({
      data: {
        userId: 'init_user',
        productName: '初始化请求产品',
        brand: '测试品牌',
        imageUrl: '',
        description: '这是初始化数据，可以删除',
        category: 'cleanser',
        requestDate: new Date(),
        status: 'pending',
        adminNotes: '',
        processedBy: '',
        processedDate: null,
        createdProductId: ''
      }
    })
    console.log('product_requests 集合创建成功:', productRequestsResult._id)
    
    console.log('数据库集合初始化完成！')
    
    // 删除初始化数据（可选）
    await db.collection('user_products').doc(userProductsResult._id).remove()
    await db.collection('product_requests').doc(productRequestsResult._id).remove()
    console.log('初始化数据已清理')
    
  } catch (error) {
    console.error('数据库初始化失败:', error)
  }
}

// 导出初始化函数
module.exports = { initDatabase }
```

#### 在云函数中调用初始化

创建一个云函数来执行初始化：

```javascript
// cloudfunctions/initDatabase/index.js
const cloud = require('wx-server-sdk')

cloud.init()
const db = cloud.database()

exports.main = async (event, context) => {
  try {
    // 创建 user_products 集合
    await db.collection('user_products').add({
      data: {
        userId: 'temp',
        productId: 'temp',
        productName: 'temp',
        brand: 'temp',
        imageUrl: '',
        status: 'active',
        addedDate: new Date(),
        notes: '',
        rating: 0,
        repurchase: false
      }
    })
    
    // 创建 product_requests 集合
    await db.collection('product_requests').add({
      data: {
        userId: 'temp',
        productName: 'temp',
        brand: 'temp',
        imageUrl: '',
        description: 'temp',
        category: 'temp',
        requestDate: new Date(),
        status: 'pending',
        adminNotes: '',
        processedBy: '',
        processedDate: null
      }
    })
    
    // 删除临时数据
    await db.collection('user_products').where({
      userId: 'temp'
    }).remove()
    
    await db.collection('product_requests').where({
      userId: 'temp'
    }).remove()
    
    return {
      success: true,
      message: '数据库集合创建成功'
    }
  } catch (error) {
    return {
      success: false,
      error: error.message
    }
  }
}
```

## 🔧 索引创建

创建集合后，建议为以下字段创建索引以提高查询性能：

### user\_products 集合索引

1. `userId` - 普通索引
2. `productId` - 普通索引
3. `status` - 普通索引
4. `addedDate` - 普通索引（降序）

### product\_requests 集合索引

1. `userId` - 普通索引
2. `status` - 普通索引
3. `requestDate` - 普通索引（降序）
4. `processedBy` - 普通索引

## 📊 数据结构示例

### user\_products 集合数据示例

```json
{
  "_id": "user_product_001",
  "userId": "user123",
  "productId": "product456",
  "productName": "月见仙人掌水乳套装",
  "brand": "谷雨",
  "imageUrl": "cloud://cloud1-7grsf5bufd76f124.636c-cloud1-7grsf5bufd76f124-1384119240/products/skincare_set/月见仙人掌补水系列-月见仙人掌水乳套装.png",
  "status": "active",
  "addedDate": "2024-01-15T10:30:00.000Z",
  "purchaseDate": "2024-01-10T00:00:00.000Z",
  "expiryDate": "2025-01-10T00:00:00.000Z",
  "notes": "很好用的补水套装",
  "rating": 5,
  "repurchase": true
}
```

### product\_requests 集合数据示例

```json
{
  "_id": "request_001",
  "userId": "user123",
  "productName": "新品牌洁面乳",
  "brand": "新品牌",
  "imageUrl": "cloud://user-uploads/product-requests/image123.jpg",
  "description": "温和洁面，适合敏感肌",
  "category": "cleanser",
  "requestDate": "2024-01-15T10:30:00.000Z",
  "status": "pending",
  "adminNotes": "",
  "processedBy": "",
  "processedDate": null,
  "createdProductId": ""
}
```

## ✅ 验证集合创建

创建完成后，您可以通过以下方式验证：

1. **在云开发控制台查看**：

   * 进入数据库页面

   * 确认可以看到 `user_products` 和 `product_requests` 两个集合

2. **通过代码测试**：

```javascript
// 在小程序中测试
wx.cloud.database().collection('user_products').get().then(res => {
  console.log('user_products 集合可用:', res)
})

wx.cloud.database().collection('product_requests').get().then(res => {
  console.log('product_requests 集合可用:', res)
})
```

## 🚀 下一步

集合创建完成后，您可以：

1. 开始开发相关的云函数
2. 创建前端页面
3. 实现数据的增删改查功能
4. 设置适当的数据库权限规则

如果在创建过程中遇到任何问题，请检查：

* 云开发环境是否正确初始化

* 是否有足够的权限操作数据库

* 网络连接是否正常

