# 微信小程序登录状态检查技术架构文档

## 1. Architecture Design

```mermaid
graph TD
    A[小程序启动] --> B[app.js - onLaunch]
    B --> C[initCloud - 云开发初始化]
    B --> D[checkLoginStatus - 登录状态检查]
    D --> E{用户已登录?}
    E -->|是| F[setGlobalUserInfo - 设置全局用户信息]
    E -->|否| G[redirectToLogin - 跳转登录页]
    F --> H[进入主页面]
    G --> I[登录引导页]
    I --> J[微信登录/游客模式]
    J --> K[更新登录状态]
    K --> H

    subgraph "存储层"
        L[wx.storage - 本地存储]
        M[globalData - 全局数据]
    end

    subgraph "工具层"
        N[auth.js - 认证工具]
        O[storage.js - 存储工具]
        P[utils.js - 通用工具]
    end

    D --> L
    F --> M
    N --> L
    O --> L
```

## 2. Technology Description

- **前端框架**：微信小程序原生框架
- **状态管理**：app.globalData + 本地存储
- **云服务**：微信云开发（可选）
- **工具库**：自定义utils工具集

## 3. Route Definitions

| Route | Purpose | Login Required |
|-------|---------|----------------|
| /pages/index/index | 主页，显示功能入口和用户状态 | 否（但功能受限） |
| /pages/login/login | 登录引导页，处理用户登录流程 | 否 |
| /pages/detection/detection | AI皮肤检测功能页面 | 是 |
| /pages/diary/diary | 护肤日记功能页面 | 是 |
| /pages/products/products | 产品浏览页面 | 否 |
| /pages/user/user | 用户个人中心页面 | 否（未登录显示登录入口） |

## 4. API Definitions

### 4.1 登录状态检查相关

**检查登录状态**
```javascript
// utils/auth.js
function isLoggedIn()
```

返回值:
| Param Name | Param Type | Description |
|-----------|-------------|-------------|
| result | boolean | 用户是否已登录 |

**获取用户信息**
```javascript
// utils/auth.js  
function getUserInfo()
```

返回值:
| Param Name | Param Type | Description |
|-----------|-------------|-------------|
| userInfo | object/null | 用户信息对象或null |

**设置用户信息**
```javascript
// app.js
setUserInfo(userInfo)
```

请求参数:
| Param Name | Param Type | isRequired | Description |
|-----------|-------------|-------------|-------------|
| userInfo | object | true | 用户信息对象 |

### 4.2 页面跳转控制

**跳转到登录页**
```javascript
// utils/auth.js
function redirectToLogin()
```

**检查页面访问权限**
```javascript
// utils/auth.js
function checkPageAccess(pageName)
```

请求参数:
| Param Name | Param Type | isRequired | Description |
|-----------|-------------|-------------|-------------|
| pageName | string | true | 页面名称标识 |

## 5. Server Architecture Diagram

```mermaid
graph TD
    A[小程序前端] --> B[微信登录API]
    A --> C[本地存储层]
    A --> D[微信云开发]

    subgraph "前端架构层次"
        E[页面层 - Pages]
        F[业务逻辑层 - Utils]
        G[数据存储层 - Storage]
    end

    E --> F
    F --> G
    G --> C
```

## 6. Data Model

### 6.1 Data Model Definition

```mermaid
erDiagram
    USER_INFO {
        string id PK
        string openid
        string nickname
        string avatar
        string role
        boolean isLogin
        boolean isGuest
        timestamp loginTime
    }
    
    LOGIN_STATUS {
        string userId FK
        boolean isValid
        timestamp lastCheck
        string loginMethod
    }
```

### 6.2 Data Definition Language

**用户信息存储结构**
```javascript
// 本地存储 - userInfo
const userInfo = {
    id: 'string',              // 用户唯一标识
    openid: 'string',          // 微信openid
    nickname: 'string',        // 用户昵称
    avatar: 'string',          // 头像URL
    role: 'string',            // 用户角色：user/guest
    isLogin: 'boolean',        // 登录状态
    isGuest: 'boolean',        // 是否游客模式
    loginTime: 'timestamp',    // 登录时间
    loginMethod: 'string'      // 登录方式：wechat/guest
}

// 全局数据结构
app.globalData = {
    userInfo: null,            // 当前用户信息
    cloudEnabled: false,       // 云开发是否可用
    isLoggedIn: false,         // 登录状态标识
    systemInfo: {}             // 系统信息
}
```

**登录状态检查逻辑**
```javascript
// app.js - 启动时检查
onLaunch() {
    this.initCloud()
    this.checkLoginStatus()
    this.initApp()
}

// 登录状态检查方法
checkLoginStatus() {
    const userInfo = wx.getStorageSync('userInfo')
    if (userInfo && userInfo.openid) {
        // 验证登录状态有效性
        this.globalData.userInfo = userInfo
        this.globalData.isLoggedIn = true
    } else {
        // 未登录，跳转登录页
        this.redirectToLogin()
    }
}

// 跳转登录页方法
redirectToLogin() {
    wx.reLaunch({
        url: '/pages/login/login'
    })
}
```