# 微信小程序云开发后端服务搭建指南

## 1. 云开发环境配置和初始化

### 1.1 开通云开发服务

1. **登录微信公众平台**

   * 进入小程序管理后台

   * 点击"云开发" -> "开通"

   * 选择合适的套餐（建议开发阶段选择免费版）

2. **创建云开发环境**

   ```bash
   # 环境配置
   环境名称: skincare-dev (开发环境)
   环境ID: skincare-prod (生产环境)
   ```

### 1.2 项目配置

1. **修改 project.config.json**

   ```json
   {
     "miniprogramRoot": "./",
     "cloudfunctionRoot": "./cloudfunctions/",
     "setting": {
       "urlCheck": false,
       "es6": true,
       "enhance": true,
       "postcss": true,
       "minified": true
     },
     "appid": "your-app-id",
     "projectname": "SkinCare",
     "cloudfunctionTemplateRoot": "cloudfunctionTemplate",
     "watchOptions": {
       "ignore": []
     }
   }
   ```

2. **初始化云开发**

   ```javascript
   // app.js
   App({
     onLaunch: function () {
       // 初始化云开发
       if (!wx.cloud) {
         console.error('请使用 2.2.3 或以上的基础库以使用云能力')
       } else {
         wx.cloud.init({
           env: 'your-env-id', // 云开发环境ID
           traceUser: true
         })
       }
     }
   })
   ```

## 2. 云数据库设计

### 2.1 数据库集合设计

#### 用户信息集合 (users)

```javascript
// 集合名: users
{
  "_id": "user_id",
  "openid": "wx_openid",
  "nickName": "用户昵称",
  "avatarUrl": "头像URL",
  "gender": 1, // 0-未知 1-男 2-女
  "city": "城市",
  "province": "省份",
  "country": "国家",
  "skinType": "oily|dry|combination|sensitive", // 肤质类型
  "skinConcerns": ["acne", "aging", "pigmentation"], // 肌肤问题
  "birthDate": "1990-01-01",
  "registrationDate": new Date(),
  "lastLoginDate": new Date(),
  "memberLevel": "basic|premium|vip", // 会员等级
  "points": 0, // 积分
  "isExpert": false, // 是否为体验官
  "expertLevel": 0 // 体验官等级
}
```

#### 皮肤检测记录集合 (detections)

```javascript
// 集合名: detections
{
  "_id": "detection_id",
  "userId": "user_id",
  "detectionType": "face|eye|lip", // 检测类型
  "imageUrl": "检测照片URL",
  "detectionDate": new Date(),
  "results": {
    "overallScore": 85, // 综合评分
    "skinAge": 25, // 肌肤年龄
    "skinType": "combination", // 检测出的肤质
    "issues": [
      {
        "type": "acne", // 问题类型
        "severity": "mild", // 严重程度
        "score": 20,
        "description": "轻微痘痘问题"
      }
    ],
    "skinMetrics": {
      "moisture": 65, // 水分
      "oiliness": 45, // 油分
      "elasticity": 80, // 弹性
      "pigmentation": 90, // 色素
      "pores": 70 // 毛孔
    }
  },
  "recommendations": [
    {
      "category": "cleanser",
      "productIds": ["prod_001", "prod_002"],
      "advice": "建议使用温和洁面产品"
    }
  ],
  "aiAnalysisData": {
    "confidence": 0.95,
    "processingTime": 2.3,
    "modelVersion": "v2.1"
  }
}
```

#### 产品信息集合 (products)

```javascript
// 集合名: products
{
  "_id": "product_id",
  "name": "产品名称",
  "brand": "品牌名称",
  "category": "cleanser|toner|serum|moisturizer|sunscreen",
  "subCategory": "具体分类",
  "description": "产品描述",
  "imageUrl": "产品图片URL",
  "price": {
    "min": 99,
    "max": 299,
    "currency": "CNY"
  },
  "volume": "50ml",
  "suitableSkinTypes": ["oily", "combination"],
  "skinConcerns": ["acne", "pores"],
  "ingredients": [
    {
      "name": "水杨酸",
      "englishName": "Salicylic Acid",
      "concentration": "2%",
      "function": "去角质",
      "safetyLevel": "safe|caution|avoid",
      "description": "成分说明"
    }
  ],
  "usage": {
    "frequency": "daily|weekly",
    "timeOfDay": "morning|evening|both",
    "instructions": "使用说明"
  },
  "ratings": {
    "average": 4.5,
    "count": 1250
  },
  "tags": ["敏感肌适用", "孕妇可用"],
  "createdDate": new Date(),
  "updatedDate": new Date(),
  "isActive": true
}
```

#### 护肤日记集合 (diaries)

```javascript
// 集合名: diaries
{
  "_id": "diary_id",
  "userId": "user_id",
  "date": "2024-01-15",
  "morningRoutine": [
    {
      "productId": "prod_001",
      "productName": "洁面乳",
      "usage": "适量",
      "notes": "感觉很温和"
    }
  ],
  "eveningRoutine": [
    {
      "productId": "prod_002",
      "productName": "精华液",
      "usage": "2-3滴",
      "notes": "吸收很快"
    }
  ],
  "skinCondition": {
    "moisture": 7, // 1-10评分
    "oiliness": 4,
    "sensitivity": 2,
    "breakouts": 1,
    "overall": 8
  },
  "photos": [
    {
      "url": "照片URL",
      "type": "morning|evening",
      "timestamp": new Date()
    }
  ],
  "notes": "今天皮肤状态不错",
  "weather": {
    "temperature": 25,
    "humidity": 60,
    "condition": "sunny"
  },
  "mood": "good|neutral|bad",
  "createdDate": new Date()
}
```

#### 体验官任务集合 (expert\_tasks)

```javascript
// 集合名: expert_tasks
{
  "_id": "task_id",
  "title": "任务标题",
  "description": "任务描述",
  "type": "product_test|survey|review",
  "productIds": ["prod_001"],
  "requirements": {
    "skinTypes": ["oily", "combination"],
    "ageRange": [20, 35],
    "duration": 14, // 天数
    "reportRequirements": ["before_photo", "after_photo", "daily_log"]
  },
  "rewards": {
    "points": 500,
    "products": ["prod_001"],
    "cash": 50
  },
  "maxParticipants": 100,
  "currentParticipants": 45,
  "startDate": new Date(),
  "endDate": new Date(),
  "status": "active|completed|cancelled",
  "createdBy": "admin_id",
  "createdDate": new Date()
}
```

### 2.2 数据库索引配置

```javascript
// 在云开发控制台中创建索引
// users 集合索引
db.collection('users').createIndex({openid: 1}, {unique: true})
db.collection('users').createIndex({skinType: 1})
db.collection('users').createIndex({isExpert: 1})

// detections 集合索引
db.collection('detections').createIndex({userId: 1, detectionDate: -1})
db.collection('detections').createIndex({detectionType: 1})

// products 集合索引
db.collection('products').createIndex({category: 1, isActive: 1})
db.collection('products').createIndex({suitableSkinTypes: 1})
db.collection('products').createIndex({name: "text", brand: "text"})

// diaries 集合索引
db.collection('diaries').createIndex({userId: 1, date: -1})
```

## 3. 云函数开发

### 3.1 用户认证云函数

创建云函数目录结构：

```
cloudfunctions/
├── login/
│   ├── index.js
│   └── package.json
├── getUserInfo/
│   ├── index.js
│   └── package.json
└── updateUserProfile/
    ├── index.js
    └── package.json
```

#### 登录云函数 (login)

```javascript
// cloudfunctions/login/index.js
const cloud = require('wx-server-sdk')
cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
})

const db = cloud.database()

exports.main = async (event, context) => {
  const { userInfo } = event
  const { OPENID } = cloud.getWXContext()
  
  try {
    // 查找用户是否已存在
    const userResult = await db.collection('users').where({
      openid: OPENID
    }).get()
    
    let user
    let isNewUser = false
    
    if (userResult.data.length === 0) {
      // 新用户，创建用户记录
      const createResult = await db.collection('users').add({
        data: {
          openid: OPENID,
          nickName: userInfo.nickName || '',
          avatarUrl: userInfo.avatarUrl || '',
          gender: userInfo.gender || 0,
          city: userInfo.city || '',
          province: userInfo.province || '',
          country: userInfo.country || '',
          skinType: '',
          skinConcerns: [],
          registrationDate: new Date(),
          lastLoginDate: new Date(),
          memberLevel: 'basic',
          points: 0,
          isExpert: false,
          expertLevel: 0
        }
      })
      
      user = {
        _id: createResult._id,
        openid: OPENID,
        ...userInfo,
        skinType: '',
        memberLevel: 'basic',
        points: 0,
        isExpert: false
      }
      isNewUser = true
    } else {
      // 老用户，更新最后登录时间
      user = userResult.data[0]
      await db.collection('users').doc(user._id).update({
        data: {
          lastLoginDate: new Date(),
          // 更新用户信息
          nickName: userInfo.nickName || user.nickName,
          avatarUrl: userInfo.avatarUrl || user.avatarUrl
        }
      })
    }
    
    return {
      success: true,
      data: {
        user,
        isNewUser,
        openid: OPENID
      }
    }
  } catch (error) {
    console.error('登录失败:', error)
    return {
      success: false,
      error: error.message
    }
  }
}
```

```json
// cloudfunctions/login/package.json
{
  "name": "login",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "dependencies": {
    "wx-server-sdk": "~2.6.3"
  }
}
```

### 3.2 皮肤检测云函数

#### 皮肤检测分析云函数 (skinAnalysis)

```javascript
// cloudfunctions/skinAnalysis/index.js
const cloud = require('wx-server-sdk')
cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
})

const db = cloud.database()

exports.main = async (event, context) => {
  const { imageFileID, detectionType } = event
  const { OPENID } = cloud.getWXContext()
  
  try {
    // 获取用户信息
    const userResult = await db.collection('users').where({
      openid: OPENID
    }).get()
    
    if (userResult.data.length === 0) {
      return {
        success: false,
        error: '用户不存在'
      }
    }
    
    const user = userResult.data[0]
    
    // 调用AI分析服务（这里需要集成实际的AI服务）
    const analysisResult = await performSkinAnalysis(imageFileID, detectionType)
    
    // 生成护肤建议
    const recommendations = await generateRecommendations(analysisResult, user.skinType)
    
    // 保存检测记录
    const detectionRecord = {
      userId: user._id,
      detectionType,
      imageUrl: imageFileID,
      detectionDate: new Date(),
      results: analysisResult,
      recommendations,
      aiAnalysisData: {
        confidence: analysisResult.confidence || 0.9,
        processingTime: 2.5,
        modelVersion: 'v2.1'
      }
    }
    
    const saveResult = await db.collection('detections').add({
      data: detectionRecord
    })
    
    return {
      success: true,
      data: {
        detectionId: saveResult._id,
        results: analysisResult,
        recommendations
      }
    }
  } catch (error) {
    console.error('皮肤检测失败:', error)
    return {
      success: false,
      error: error.message
    }
  }
}

// AI分析函数（示例实现）
async function performSkinAnalysis(imageFileID, detectionType) {
  // 这里应该调用实际的AI服务
  // 示例返回数据
  return {
    overallScore: Math.floor(Math.random() * 30) + 70,
    skinAge: Math.floor(Math.random() * 10) + 25,
    skinType: ['oily', 'dry', 'combination', 'sensitive'][Math.floor(Math.random() * 4)],
    issues: [
      {
        type: 'acne',
        severity: 'mild',
        score: Math.floor(Math.random() * 50) + 10,
        description: '轻微痘痘问题'
      }
    ],
    skinMetrics: {
      moisture: Math.floor(Math.random() * 40) + 60,
      oiliness: Math.floor(Math.random() * 60) + 20,
      elasticity: Math.floor(Math.random() * 30) + 70,
      pigmentation: Math.floor(Math.random() * 20) + 80,
      pores: Math.floor(Math.random() * 40) + 60
    }
  }
}

// 生成推荐函数
async function generateRecommendations(analysisResult, userSkinType) {
  const db = cloud.database()
  
  // 根据检测结果推荐产品
  const recommendations = []
  
  // 基础护肤推荐
  const basicProducts = await db.collection('products')
    .where({
      suitableSkinTypes: db.command.in([analysisResult.skinType, userSkinType]),
      isActive: true
    })
    .limit(10)
    .get()
  
  if (basicProducts.data.length > 0) {
    recommendations.push({
      category: 'basic_care',
      title: '基础护肤推荐',
      products: basicProducts.data.slice(0, 3),
      advice: '根据您的肌肤状态，建议使用以下基础护肤产品'
    })
  }
  
  return recommendations
}
```

### 3.3 产品推荐云函数

```javascript
// cloudfunctions/getProductRecommendations/index.js
const cloud = require('wx-server-sdk')
cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
})

const db = cloud.database()

exports.main = async (event, context) => {
  const { skinType, skinConcerns, category, page = 1, limit = 10 } = event
  const { OPENID } = cloud.getWXContext()
  
  try {
    // 构建查询条件
    let whereCondition = {
      isActive: true
    }
    
    if (category) {
      whereCondition.category = category
    }
    
    if (skinType) {
      whereCondition.suitableSkinTypes = db.command.in([skinType])
    }
    
    if (skinConcerns && skinConcerns.length > 0) {
      whereCondition.skinConcerns = db.command.in(skinConcerns)
    }
    
    // 查询产品
    const productsResult = await db.collection('products')
      .where(whereCondition)
      .orderBy('ratings.average', 'desc')
      .skip((page - 1) * limit)
      .limit(limit)
      .get()
    
    // 获取总数
    const countResult = await db.collection('products')
      .where(whereCondition)
      .count()
    
    return {
      success: true,
      data: {
        products: productsResult.data,
        total: countResult.total,
        page,
        limit,
        hasMore: (page * limit) < countResult.total
      }
    }
  } catch (error) {
    console.error('获取产品推荐失败:', error)
    return {
      success: false,
      error: error.message
    }
  }
}
```

### 3.4 护肤日记云函数

```javascript
// cloudfunctions/saveDiary/index.js
const cloud = require('wx-server-sdk')
cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
})

const db = cloud.database()

exports.main = async (event, context) => {
  const { date, morningRoutine, eveningRoutine, skinCondition, photos, notes, weather, mood } = event
  const { OPENID } = cloud.getWXContext()
  
  try {
    // 获取用户信息
    const userResult = await db.collection('users').where({
      openid: OPENID
    }).get()
    
    if (userResult.data.length === 0) {
      return {
        success: false,
        error: '用户不存在'
      }
    }
    
    const user = userResult.data[0]
    
    // 检查当天是否已有日记
    const existingDiary = await db.collection('diaries').where({
      userId: user._id,
      date: date
    }).get()
    
    const diaryData = {
      userId: user._id,
      date,
      morningRoutine: morningRoutine || [],
      eveningRoutine: eveningRoutine || [],
      skinCondition: skinCondition || {},
      photos: photos || [],
      notes: notes || '',
      weather: weather || {},
      mood: mood || 'neutral',
      createdDate: new Date()
    }
    
    let result
    if (existingDiary.data.length > 0) {
      // 更新现有日记
      result = await db.collection('diaries').doc(existingDiary.data[0]._id).update({
        data: {
          ...diaryData,
          updatedDate: new Date()
        }
      })
    } else {
      // 创建新日记
      result = await db.collection('diaries').add({
        data: diaryData
      })
    }
    
    // 更新用户积分
    await db.collection('users').doc(user._id).update({
      data: {
        points: db.command.inc(10) // 每次记录日记获得10积分
      }
    })
    
    return {
      success: true,
      data: {
        diaryId: result._id || existingDiary.data[0]._id,
        pointsEarned: 10
      }
    }
  } catch (error) {
    console.error('保存日记失败:', error)
    return {
      success: false,
      error: error.message
    }
  }
}
```

## 4. 云存储配置

### 4.1 存储目录结构设计

```
cloud://your-env-id.7465-your-env-id/
├── avatars/           # 用户头像
│   └── {userId}/
├── detections/        # 检测照片
│   └── {userId}/
│       └── {date}/
├── diaries/          # 日记照片
│   └── {userId}/
│       └── {date}/
├── products/         # 产品图片
│   └── {productId}/
└── temp/            # 临时文件
```

### 4.2 文件上传云函数

```javascript
// cloudfunctions/uploadFile/index.js
const cloud = require('wx-server-sdk')
cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
})

exports.main = async (event, context) => {
  const { fileType, fileName, filePath } = event
  const { OPENID } = cloud.getWXContext()
  
  try {
    // 根据文件类型生成存储路径
    let cloudPath = ''
    const timestamp = Date.now()
    const fileExtension = fileName.split('.').pop()
    
    switch (fileType) {
      case 'avatar':
        cloudPath = `avatars/${OPENID}/${timestamp}.${fileExtension}`
        break
      case 'detection':
        cloudPath = `detections/${OPENID}/${new Date().toISOString().split('T')[0]}/${timestamp}.${fileExtension}`
        break
      case 'diary':
        cloudPath = `diaries/${OPENID}/${new Date().toISOString().split('T')[0]}/${timestamp}.${fileExtension}`
        break
      default:
        cloudPath = `temp/${OPENID}/${timestamp}.${fileExtension}`
    }
    
    // 上传文件到云存储
    const uploadResult = await cloud.uploadFile({
      cloudPath,
      fileContent: filePath
    })
    
    return {
      success: true,
      data: {
        fileID: uploadResult.fileID,
        cloudPath
      }
    }
  } catch (error) {
    console.error('文件上传失败:', error)
    return {
      success: false,
      error: error.message
    }
  }
}
```

### 4.3 文件管理云函数

```javascript
// cloudfunctions/manageFiles/index.js
const cloud = require('wx-server-sdk')
cloud.init({
  env: cloud.DYNAMIC_CURRENT_ENV
})

exports.main = async (event, context) => {
  const { action, fileIDs } = event
  
  try {
    let result
    
    switch (action) {
      case 'delete':
        result = await cloud.deleteFile({
          fileList: fileIDs
        })
        break
      case 'getTempFileURL':
        result = await cloud.getTempFileURL({
          fileList: fileIDs
        })
        break
      default:
        throw new Error('不支持的操作')
    }
    
    return {
      success: true,
      data: result
    }
  } catch (error) {
    console.error('文件管理失败:', error)
    return {
      success: false,
      error: error.message
    }
  }
}
```

## 5. 前端与云开发集成

### 5.1 API 封装

```javascript
// utils/cloudApi.js
class CloudAPI {
  constructor() {
    this.cloud = wx.cloud
  }
  
  // 用户登录
  async login(userInfo) {
    try {
      const result = await this.cloud.callFunction({
        name: 'login',
        data: { userInfo }
      })
      
      if (result.result.success) {
        // 保存用户信息到本地
        wx.setStorageSync('userInfo', result.result.data.user)
        return result.result.data
      } else {
        throw new Error(result.result.error)
      }
    } catch (error) {
      console.error('登录失败:', error)
      throw error
    }
  }
  
  // 皮肤检测
  async analyzeSkin(imageFileID, detectionType) {
    try {
      const result = await this.cloud.callFunction({
        name: 'skinAnalysis',
        data: { imageFileID, detectionType }
      })
      
      if (result.result.success) {
        return result.result.data
      } else {
        throw new Error(result.result.error)
      }
    } catch (error) {
      console.error('皮肤检测失败:', error)
      throw error
    }
  }
  
  // 获取产品推荐
  async getProductRecommendations(params) {
    try {
      const result = await this.cloud.callFunction({
        name: 'getProductRecommendations',
        data: params
      })
      
      if (result.result.success) {
        return result.result.data
      } else {
        throw new Error(result.result.error)
      }
    } catch (error) {
      console.error('获取产品推荐失败:', error)
      throw error
    }
  }
  
  // 保存护肤日记
  async saveDiary(diaryData) {
    try {
      const result = await this.cloud.callFunction({
        name: 'saveDiary',
        data: diaryData
      })
      
      if (result.result.success) {
        return result.result.data
      } else {
        throw new Error(result.result.error)
      }
    } catch (error) {
      console.error('保存日记失败:', error)
      throw error
    }
  }
  
  // 上传文件
  async uploadFile(filePath, fileType, fileName) {
    try {
      // 先上传到云存储
      const uploadResult = await this.cloud.callFunction({
        name: 'uploadFile',
        data: { fileType, fileName, filePath }
      })
      
      if (uploadResult.result.success) {
        return uploadResult.result.data
      } else {
        throw new Error(uploadResult.result.error)
      }
    } catch (error) {
      console.error('文件上传失败:', error)
      throw error
    }
  }
  
  // 数据库查询封装
  async queryDatabase(collection, where = {}, orderBy = null, limit = 20) {
    try {
      const db = this.cloud.database()
      let query = db.collection(collection).where(where)
      
      if (orderBy) {
        query = query.orderBy(orderBy.field, orderBy.order)
      }
      
      const result = await query.limit(limit).get()
      return result.data
    } catch (error) {
      console.error('数据库查询失败:', error)
      throw error
    }
  }
}

// 导出单例
export default new CloudAPI()
```

### 5.2 页面集成示例

```javascript
// pages/detection/detection.js
import CloudAPI from '../../utils/cloudApi'

Page({
  data: {
    detecting: false,
    result: null
  },
  
  // 拍照检测
  async takePhoto() {
    try {
      // 选择图片
      const chooseResult = await wx.chooseImage({
        count: 1,
        sizeType: ['compressed'],
        sourceType: ['camera', 'album']
      })
      
      const tempFilePath = chooseResult.tempFilePaths[0]
      
      // 显示加载状态
      this.setData({ detecting: true })
      wx.showLoading({ title: '分析中...' })
      
      // 上传图片
      const uploadResult = await CloudAPI.uploadFile(
        tempFilePath, 
        'detection', 
        `detection_${Date.now()}.jpg`
      )
      
      // 调用检测分析
      const analysisResult = await CloudAPI.analyzeSkin(
        uploadResult.fileID, 
        'face'
      )
      
      // 更新页面数据
      this.setData({
        detecting: false,
        result: analysisResult
      })
      
      wx.hideLoading()
      
      // 跳转到结果页面
      wx.navigateTo({
        url: `/pages/report/report?detectionId=${analysisResult.detectionId}`
      })
      
    } catch (error) {
      console.error('检测失败:', error)
      this.setData({ detecting: false })
      wx.hideLoading()
      wx.showToast({
        title: '检测失败，请重试',
        icon: 'none'
      })
    }
  }
})
```

## 6. 安全规则和权限控制

### 6.1 数据库安全规则

```javascript
// 在云开发控制台设置数据库安全规则

// users 集合 - 用户只能读写自己的数据
{
  "read": "auth.openid == resource.openid",
  "write": "auth.openid == resource.openid"
}

// detections 集合 - 用户只能读写自己的检测记录
{
  "read": "auth.openid == get('users', resource.userId).openid",
  "write": "auth.openid == get('users', resource.userId).openid"
}

// products 集合 - 所有用户可读，只有管理员可写
{
  "read": true,
  "write": "get('users', auth.openid).role == 'admin'"
}

// diaries 集合 - 用户只能读写自己的日记
{
  "read": "auth.openid == get('users', resource.userId).openid",
  "write": "auth.openid == get('users', resource.userId).openid"
}
```

### 6.2 云函数权限控制

```javascript
// 权限验证中间件
function checkAuth(requiredRole = null) {
  return async (event, context) => {
    const { OPENID } = cloud.getWXContext()
    
    if (!OPENID) {
      return {
        success: false,
        error: '未授权访问'
      }
    }
    
    if (requiredRole) {
      const db = cloud.database()
      const userResult = await db.collection('users').where({
        openid: OPENID
      }).get()
      
      if (userResult.data.length === 0 || userResult.data[0].role !== requiredRole) {
        return {
          success: false,
          error: '权限不足'
        }
      }
    }
    
    return null // 验证通过
  }
}

// 在云函数中使用
exports.main = async (event, context) => {
  // 权限检查
  const authResult = await checkAuth('admin')(event, context)
  if (authResult) return authResult
  
  // 业务逻辑
  // ...
}
```

### 6.3 云存储安全规则

```javascript
// 云存储安全规则
{
  "read": "auth != null && (
    resource.openid == auth.openid || 
    resource.path.matches('products/.*')
  )",
  "write": "auth != null && resource.openid == auth.openid"
}
```

## 7. 部署和测试流程

### 7.1 开发环境部署

1. **上传云函数**

   ```bash
   # 在微信开发者工具中
   # 右键云函数文件夹 -> 上传并部署：云端安装依赖
   ```

2. **初始化数据库**

   ```javascript
   // 在云开发控制台执行初始化脚本
   // 创建集合和索引
   ```

3. **配置环境变量**

   ```javascript
   // 在云函数配置中设置环境变量
   {
     "AI_API_KEY": "your-ai-api-key",
     "WEATHER_API_KEY": "your-weather-api-key"
   }
   ```

### 7.2 测试流程

1. **单元测试**

   ```javascript
   // test/cloudFunction.test.js
   const cloud = require('wx-server-sdk')

   describe('云函数测试', () => {
     test('用户登录测试', async () => {
       const result = await cloud.callFunction({
         name: 'login',
         data: {
           userInfo: {
             nickName: '测试用户',
             avatarUrl: 'test-avatar-url'
           }
         }
       })
       
       expect(result.result.success).toBe(true)
       expect(result.result.data.user).toBeDefined()
     })
   })
   ```

2. **集成测试**

   ```javascript
   // 测试完整的业务流程
   describe('皮肤检测流程测试', () => {
     test('完整检测流程', async () => {
       // 1. 用户登录
       // 2. 上传图片
       // 3. 调用检测
       // 4. 保存结果
       // 5. 验证数据
     })
   })
   ```

### 7.3 生产环境部署

1. **环境切换**

   ```javascript
   // 修改环境ID
   wx.cloud.init({
     env: 'production-env-id'
   })
   ```

2. **性能优化**

   * 启用数据库索引

   * 配置CDN加速

   * 设置缓存策略

3. **监控配置**

   * 设置云函数监控

   * 配置错误告警

   * 性能指标监控

### 7.4 版本管理

```javascript
// 版本控制策略
const VERSION_CONFIG = {
  development: {
    env: 'dev-env-id',
    debug: true,
    logLevel: 'debug'
  },
  staging: {
    env: 'staging-env-id',
    debug: false,
    logLevel: 'info'
  },
  production: {
    env: 'prod-env-id',
    debug: false,
    logLevel: 'error'
  }
}
```

## 8. 最佳实践和注意事项

### 8.1 性能优化

1. **数据库查询优化**

   * 合理使用索引

   * 避免全表扫描

   * 使用分页查询

2. **云函数优化**

   * 减少冷启动时间

   * 复用数据库连接

   * 异步处理非关键任务

3. **云存储优化**

   * 图片压缩处理

   * CDN加速配置

   * 合理的文件命名规则

### 8.2 错误处理

```javascript
// 统一错误处理
class CloudError extends Error {
  constructor(code, message, details = null) {
    super(message)
    this.code = code
    this.details = details
  }
}

// 错误码定义
const ERROR_CODES = {
  USER_NOT_FOUND: 'USER_NOT_FOUND',
  INVALID_PARAMETER: 'INVALID_PARAMETER',
  PERMISSION_DENIED: 'PERMISSION_DENIED',
  SYSTEM_ERROR: 'SYSTEM_ERROR'
}
```

### 8.3 日志记录

```javascript
// 日志工具
class Logger {
  static log(level, message, data = null) {
    const logEntry = {
      timestamp: new Date().toISOString(),
      level,
      message,
      data,
      openid: cloud.getWXContext().OPENID
    }
    
    console.log(JSON.stringify(logEntry))
    
    // 可以将日志保存到数据库或外部服务
    if (level === 'error') {
      // 发送错误告警
    }
  }
  
  static info(message, data) {
    this.log('info', message, data)
  }
  
  static error(message, data) {
    this.log('error', message, data)
  }
  
  static debug(message, data) {
    this.log('debug', message, data)
  }
}
```

通过以上完整的云开发集成方案，您可以为护肤小程序构建一个功能完整、安全可靠的后端服务系统。建议按照文档逐步实施，先搭建基础功能，再逐步完善高级特性。
