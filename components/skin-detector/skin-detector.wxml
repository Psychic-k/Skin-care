<!--çš®è‚¤æ£€æµ‹ç»„ä»¶-->
<view class="skin-detector">
  <!-- ç›¸æœºæ¨¡å¼ -->
  <view class="camera-container" wx:if="{{mode === 'camera'}}">
    <camera 
      class="camera" 
      device-position="front"
      flash="off"
      binderror="onCameraError"
      bindready="onCameraReady">
    </camera>
    
    <!-- æ£€æµ‹åŒºåŸŸæŒ‡å¼• -->
    <view class="detection-overlay">
      <view class="detection-area {{detectionStyle}}" 
            style="width: {{detectionArea.width}}rpx; height: {{detectionArea.height}}rpx; left: {{detectionArea.left}}rpx; top: {{detectionArea.top}}rpx;">
        <view class="area-border"></view>
        <view class="area-corners">
          <view class="corner top-left"></view>
          <view class="corner top-right"></view>
          <view class="corner bottom-left"></view>
          <view class="corner bottom-right"></view>
        </view>
      </view>
      
      <!-- æ£€æµ‹æŒ‡å¼•æ–‡å­— -->
      <view class="detection-guide" wx:if="{{!detecting && !result}}">
        <text class="guide-text">è¯·å°†é¢éƒ¨å¯¹å‡†æ£€æµ‹åŒºåŸŸ</text>
        <text class="guide-subtext">ä¿æŒå…‰çº¿å……è¶³ï¼Œé¢éƒ¨æ¸…æ™°å¯è§</text>
      </view>
    </view>
  </view>

  <!-- å›¾ç‰‡é¢„è§ˆæ¨¡å¼ -->
  <view class="image-preview" wx:if="{{mode === 'album' || imagePath}}">
    <image class="preview-image" src="{{imagePath}}" mode="aspectFit" wx:if="{{imagePath}}"></image>
    <view class="preview-placeholder" wx:else>
      <text class="placeholder-icon">ğŸ“·</text>
      <text class="placeholder-text">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</text>
    </view>
  </view>

  <!-- æ£€æµ‹è¿›åº¦ -->
  <view class="detection-progress" wx:if="{{detecting}}">
    <view class="progress-container">
      <view class="progress-circle">
        <view class="progress-fill" style="transform: rotate({{progress * 3.6}}deg);"></view>
        <view class="progress-text">{{Math.floor(progress)}}%</view>
      </view>
      <view class="progress-status">
        <text class="status-text">AIæ­£åœ¨åˆ†ææ‚¨çš„è‚Œè‚¤...</text>
        <view class="status-dots">
          <text class="dot">â—</text>
          <text class="dot">â—</text>
          <text class="dot">â—</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ£€æµ‹ç»“æœ -->
  <view class="detection-result" wx:if="{{result && !detecting}}">
    <view class="result-header">
      <text class="result-title">æ£€æµ‹å®Œæˆ</text>
      <text class="result-score">ç»¼åˆè¯„åˆ†ï¼š{{result.score}}åˆ†</text>
    </view>
    
    <view class="result-summary">
      <view class="summary-item">
        <text class="summary-label">è‚Œè‚¤ç±»å‹</text>
        <text class="summary-value">{{result.skinType}}</text>
      </view>
      <view class="summary-item">
        <text class="summary-label">è‚Œè‚¤å¹´é¾„</text>
        <text class="summary-value">{{result.skinAge}}å²</text>
      </view>
    </view>

    <view class="result-details">
      <view class="detail-item">
        <text class="detail-label">æ°´åˆ†</text>
        <view class="detail-bar">
          <view class="bar-fill" style="width: {{result.moisture}}%;"></view>
        </view>
        <text class="detail-value">{{result.moisture}}%</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">æ²¹åˆ†</text>
        <view class="detail-bar">
          <view class="bar-fill" style="width: {{result.oiliness}}%;"></view>
        </view>
        <text class="detail-value">{{result.oiliness}}%</text>
      </view>
      <view class="detail-item">
        <text class="detail-label">æ•æ„Ÿåº¦</text>
        <view class="detail-bar">
          <view class="bar-fill sensitive" style="width: {{result.sensitivity}}%;"></view>
        </view>
        <text class="detail-value">{{result.sensitivity}}%</text>
      </view>
    </view>
  </view>

  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-buttons">
    <!-- æ£€æµ‹æŒ‰é’® -->
    <view class="detect-btn {{detecting ? 'detecting' : ''}}" 
          bindtap="startDetection" 
          wx:if="{{!result}}">
      <text class="btn-text" wx:if="{{!detecting}}">
        {{mode === 'camera' ? 'æ‹ç…§æ£€æµ‹' : 'é€‰æ‹©å›¾ç‰‡'}}
      </text>
      <text class="btn-text" wx:else>æ£€æµ‹ä¸­...</text>
    </view>

    <!-- ç»“æœæ“ä½œæŒ‰é’® -->
    <view class="result-actions" wx:if="{{result}}">
      <view class="action-btn secondary" bindtap="retryDetection">
        <text class="btn-text">é‡æ–°æ£€æµ‹</text>
      </view>
      <view class="action-btn primary" bindtap="viewReport">
        <text class="btn-text">æŸ¥çœ‹æŠ¥å‘Š</text>
      </view>
    </view>

    <!-- æ¨¡å¼åˆ‡æ¢ -->
    <view class="mode-switch" bindtap="switchMode" wx:if="{{!detecting && !result}}">
      <text class="switch-text">
        {{mode === 'camera' ? 'ä»ç›¸å†Œé€‰æ‹©' : 'ä½¿ç”¨ç›¸æœºæ‹æ‘„'}}
      </text>
    </view>
  </view>

  <!-- æ£€æµ‹æŒ‡å¼•æŒ‰é’® -->
  <view class="guide-btn" bindtap="showDetectionGuide" wx:if="{{showGuide && !detecting && !result}}">
    <text class="guide-icon">â“</text>
  </view>

  <!-- æ£€æµ‹æŒ‡å¼•å¼¹çª— -->
  <view class="guide-modal" id="guide-modal" hidden>
    <view class="modal-mask" bindtap="closeGuide"></view>
    <view class="modal-content">
      <view class="guide-header">
        <text class="guide-title">æ£€æµ‹æŒ‡å¼•</text>
        <view class="guide-close" bindtap="closeGuide">Ã—</view>
      </view>
      
      <view class="guide-content">
        <view class="guide-step">
          <text class="step-icon">{{guideSteps[guideStep].icon}}</text>
          <text class="step-title">{{guideSteps[guideStep].title}}</text>
          <text class="step-desc">{{guideSteps[guideStep].desc}}</text>
        </view>
        
        <view class="guide-progress">
          <view class="progress-dot {{index <= guideStep ? 'active' : ''}}" 
                wx:for="{{guideSteps}}" 
                wx:key="*this">
          </view>
        </view>
      </view>
      
      <view class="guide-actions">
        <view class="guide-btn-next" bindtap="nextGuideStep">
          {{guideStep < guideSteps.length - 1 ? 'ä¸‹ä¸€æ­¥' : 'å¼€å§‹æ£€æµ‹'}}
        </view>
      </view>
    </view>
  </view>
</view>